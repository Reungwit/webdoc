<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Handsontable Quick Test</title>

  <!-- Handsontable CSS (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/styles/handsontable.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/styles/ht-theme-main.min.css">

  <!-- Handsontable JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .btn { padding: 9px 14px; border: 1px solid #dadde3; border-radius: 10px; background: #fff; cursor: pointer; font-weight: 600; }
    .btn.primary { background: #2d6cdf; color: #fff; border-color: #2d6cdf; }
    .toolbar { display: flex; gap: 10px; margin: 10px 0 18px; flex-wrap: wrap; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin: 14px 0; background: #fff; }
    .head { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .title { display: flex; align-items: center; gap: 10px; flex: 1; }
    .badge { background:#eef2ff; border:1px solid #c7d2fe; color:#1e3a8a; font-weight:700; border-radius:8px; padding:2px 8px; }
    .caption { flex: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; }
    .actions { display: flex; gap: 6px; }
    .sub { font-size: 12px; color: var(--muted); margin: 6px 0 8px; }
    .hot-mount { border: 1px solid var(--border); border-radius: 10px; overflow: auto; }
    .json { width: 100%; height: 140px; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Handsontable</h1>

  <div class="toolbar">
    <button id="btnCreate" class="btn primary">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
    <button id="btnShowJson" class="btn">üëÄ ‡πÅ‡∏™‡∏î‡∏á tb_sections_json</button>
  </div>

  <div id="tablesContainer"></div>
  <textarea id="jsonOut" class="json json-view" placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå tb_sections_json ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>

  <script>
    // ===== Config =====
    const CHAPTER_NO = 3;  // ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3

    // ===== State =====
    let tableSeq = 0;         // ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏ö‡∏ó (‡∏£‡∏±‡∏ô‡∏ô‡∏¥‡πà‡∏á)
    const allTables = [];     // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å tb_sections_json

    // ===== Helpers =====
    const nextSeq = () => (++tableSeq);

    function formatDisplayTitle(chap, seq, caption) {
      // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà <‡∏ö‡∏ó>-<‡∏•‡∏≥‡∏î‡∏±‡∏ö>‚ê†‚ê†<‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢>
      const cap = (caption || '').trim();
      return `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${chap}-${seq}${cap ? '  ' + cap : ''}`;
    }

    function defaultMatrix(rows = 5, cols = 5) {
      const headers = Array.from({ length: cols }, (_, i) => `‡∏´‡∏±‡∏ß ${i + 1}`);
      const rowsData = Array.from({ length: rows }, () => Array.from({ length: cols }, () => ''));
      return { headers, rowsData };
    }

    function buildTbJson(tb) {
      const hot = tb.hot;
      return {
        title_no: tb.title_no,                   // ‡πÉ‡∏ä‡πâ anchor ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
        caption: tb.caption || '',
        headers: hot ? hot.getColHeader() : tb.headers,
        rows: hot ? hot.getData() : tb.rows,
        display_title: tb.display_title,
        seq: tb.seq,
        anchor_no: tb.title_no
      };
    }

    function refreshJsonOutput() {
      const payload = allTables.map(buildTbJson);
      document.getElementById('jsonOut').value = JSON.stringify(payload, null, 2);
    }

    // ===== UI: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á 1 ‡πÉ‡∏ö =====
    function createTableCard() {
      const seq = nextSeq();
      const anchorNo = `3.${seq}`;      // anchor ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πÇ‡∏°

      const card = document.createElement('div');
      card.className = 'card';

      const head = document.createElement('div');
      head.className = 'head';

      const titleWrap = document.createElement('div');
      titleWrap.className = 'title';

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = anchorNo;

      const caption = document.createElement('input');
      caption.className = 'caption';
      caption.placeholder = '‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á';

      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.innerHTML = `
        <button class="btn" data-act="add-row">+ ‡πÅ‡∏ñ‡∏ß</button>
        <button class="btn" data-act="add-col">+ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
        <button class="btn" data-act="del-row">- ‡πÅ‡∏ñ‡∏ß</button>
        <button class="btn" data-act="del-col">- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
        <button class="btn" data-act="remove">‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
      `;

      titleWrap.appendChild(badge);
      titleWrap.appendChild(caption);
      head.appendChild(titleWrap);
      head.appendChild(actions);

      const sub = document.createElement('div');
      sub.className = 'sub';

      const mount = document.createElement('div');
      mount.className = 'hot-mount';

      card.appendChild(head);
      card.appendChild(sub);
      card.appendChild(mount);

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Handsontable 5√ó5
      const { headers, rowsData } = defaultMatrix();
      const hot = new Handsontable(mount, {
        themeName: 'ht-theme-main-dark-auto', // ‡πÉ‡∏ä‡πâ‡∏ò‡∏µ‡∏°‡∏´‡∏•‡∏±‡∏Å
        data: rowsData,
        colHeaders: headers,
        rowHeaders: true,
        manualColumnMove: true,
        manualRowMove: true,
        stretchH: 'all',
        contextMenu: true,
        height: 'auto',
        licenseKey: 'non-commercial-and-evaluation'
      });

      // ‡πÄ‡∏Å‡πá‡∏ö state ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ
      const tb = {
        title_no: anchorNo,
        caption: '',
        display_title: '',
        seq,
        hot
      };
      allTables.push(tb);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å caption
      caption.addEventListener('input', (e) => {
        tb.caption = e.target.value;
        tb.display_title = formatDisplayTitle(CHAPTER_NO, tb.seq, tb.caption);
        sub.textContent = tb.display_title;
        refreshJsonOutput();
      });
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (caption ‡∏ß‡πà‡∏≤‡∏á)
      tb.display_title = formatDisplayTitle(CHAPTER_NO, tb.seq, tb.caption);
      sub.textContent = tb.display_title;

      // ‡∏õ‡∏∏‡πà‡∏° action ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
      head.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-act]');
        if (!btn) return;
        const act = btn.dataset.act;

        if (act === 'add-row') hot.alter('insert_row', hot.countRows());
        if (act === 'del-row' && hot.countRows() > 0) hot.alter('remove_row', hot.countRows() - 1);

        if (act === 'add-col') {
          hot.alter('insert_col', hot.countCols());
          const h = hot.getColHeader(); h.push(''); hot.updateSettings({ colHeaders: h });
        }
        if (act === 'del-col' && hot.countCols() > 0) {
          const h = hot.getColHeader(); h.pop();
          hot.alter('remove_col', hot.countCols() - 1);
          hot.updateSettings({ colHeaders: h });
        }
        if (act === 'remove') {
          if (confirm('‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ?')) {
            const i = allTables.indexOf(tb);
            if (i >= 0) allTables.splice(i, 1);
            card.remove();
            refreshJsonOutput();
          }
        }
        refreshJsonOutput();
      });

      return card;
    }

    // ===== Wire buttons =====
    document.getElementById('btnCreate').addEventListener('click', () => {
      const card = createTableCard();
      document.getElementById('tablesContainer').appendChild(card);
    });

    document.getElementById('btnShowJson').addEventListener('click', refreshJsonOutput);
  </script>
</body>
</html>
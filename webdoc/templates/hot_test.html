<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Handsontable Quick Test</title>

  <!-- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏±‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/styles/ht-theme-main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>

  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui,-apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .btn { padding: 9px 14px; border: 1px solid #dadde3; border-radius: 10px; background: #fff; cursor: pointer; font-weight: 600; }
    .btn.primary { background: #2d6cdf; color: #fff; border-color: #2d6cdf; }
    .toolbar { display: flex; gap: 10px; margin: 10px 0 18px; flex-wrap: wrap; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin: 14px 0; background: #fff; }
    .head { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .title { display: flex; align-items: center; gap: 10px; flex: 1; }
    .badge { background:#eef2ff; border:1px solid #c7d2fe; color:#1e3a8a; font-weight:700; border-radius:8px; padding:2px 8px; }
    .caption { flex: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; }
    .actions { display: flex; gap: 6px; }
    .sub { font-size: 12px; color: var(--muted); margin: 6px 0 8px; }
    .hot-mount { border: 1px solid var(--border); border-radius: 10px; overflow: auto; }
    .json { width: 100%; height: 140px; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Handsontable</h1>

  <div class="toolbar">
    <button id="btnCreate" class="btn primary">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
    <button id="btnShowJson" class="btn">üëÄ ‡πÅ‡∏™‡∏î‡∏á tb_sections_json</button>
  </div>

  <div id="tablesContainer"></div>
  <textarea id="jsonOut" class="json json-view" placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå tb_sections_json ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>

  <script>
    // ===== Config =====
    const CHAPTER_NO = 3;  // ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3

    // ===== State =====
    let tableSeq = 0;               // running number
    const allTables = [];           // [{ title_no, caption, display_title, seq, hot }]

    // ===== Helpers =====
    const nextSeq = () => (++tableSeq);

    function formatDisplayTitle(chap, seq, caption) {
      const cap = (caption || '').trim();
      return `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${chap}-${seq}${cap ? '  ' + cap : ''}`;
    }

    function defaultMatrix(rows = 5, cols = 5) {
      const headers = Array.from({ length: cols }, (_, i) => `‡∏´‡∏±‡∏ß ${i + 1}`);
      const rowsData = Array.from({ length: rows }, () => Array.from({ length: cols }, () => ''));
      return { headers, rowsData };
    }

    function normalizedHeaders(hot) {
      const n = hot.countCols();
      let h = Array.isArray(hot.getColHeader()) ? hot.getColHeader().slice() : [];
      while (h.length < n) h.push(`‡∏´‡∏±‡∏ß ${h.length + 1}`);
      if (h.length > n) h.length = n;
      return h;
    }

    function buildTbJson(tb) {
      const hot = tb.hot;
      // commit ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡πà‡∏≤‡∏ô
      hot.finishEditing();
      return {
        title_no: tb.title_no,
        caption: tb.caption || '',
        headers: normalizedHeaders(hot),
        rows: hot.getData(),
        display_title: tb.display_title,
        seq: tb.seq,
        anchor_no: tb.title_no
      };
    }

    function refreshJsonOutput() {
      const payload = allTables.map(buildTbJson);
      document.getElementById('jsonOut').value = JSON.stringify(payload, null, 2);
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö ‡πÅ‡∏ñ‡∏ß‚Äì‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÅ‡∏ö‡∏ö "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ alter()" ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å build
    function addRowAfterSelection(hot) {
      const data = hot.getData();                   // array by ref
      const nRows = hot.countRows();
      const nCols = hot.countCols();
      const sel = hot.getSelectedLast();
      const r = sel ? sel[0] : nRows - 1;
      const row = Array.from({ length: nCols }, () => '');
      data.splice(Math.max(r + 1, 0), 0, row);
      hot.updateSettings({ data });
    }
    function removeRowAtSelection(hot) {
      const data = hot.getData();
      const nRows = hot.countRows();
      if (!nRows) return;
      const sel = hot.getSelectedLast();
      const r = sel ? sel[0] : nRows - 1;
      data.splice(Math.max(r, 0), 1);
      hot.updateSettings({ data });
    }
    function addColAfterSelection(hot) {
      const data = hot.getData();
      const nCols = hot.countCols();
      let headers = normalizedHeaders(hot);
      const sel = hot.getSelectedLast();
      const c = sel ? sel[1] : nCols - 1;
      data.forEach(row => row.splice(Math.max(c + 1, 0), 0, ''));
      headers.splice(Math.max(c + 1, 0), 0, '');
      hot.updateSettings({ data, colHeaders: headers });
    }
    function removeColAtSelection(hot) {
      const data = hot.getData();
      const nCols = hot.countCols();
      if (!nCols) return;
      let headers = normalizedHeaders(hot);
      const sel = hot.getSelectedLast();
      const c = sel ? sel[1] : nCols - 1;
      data.forEach(row => row.splice(Math.max(c, 0), 1));
      headers.splice(Math.max(c, 0), 1);
      hot.updateSettings({ data, colHeaders: headers });
    }

    // ===== UI: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á 1 ‡πÉ‡∏ö =====
    function createTableCard() {
      const seq = nextSeq();
      const anchorNo = `3.${seq}`;

      const card = document.createElement('div');
      card.className = 'card';

      const head = document.createElement('div');
      head.className = 'head';

      const titleWrap = document.createElement('div');
      titleWrap.className = 'title';

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = anchorNo;

      const caption = document.createElement('input');
      caption.className = 'caption';
      caption.placeholder = '‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á';

      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.innerHTML = `
        <button class="btn" data-act="add-row">+ ‡πÅ‡∏ñ‡∏ß</button>
        <button class="btn" data-act="add-col">+ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
        <button class="btn" data-act="del-row">- ‡πÅ‡∏ñ‡∏ß</button>
        <button class="btn" data-act="del-col">- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
        <button class="btn" data-act="remove">‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
      `;

      titleWrap.appendChild(badge);
      titleWrap.appendChild(caption);
      head.appendChild(titleWrap);
      head.appendChild(actions);

      const sub = document.createElement('div');
      sub.className = 'sub';

      const mount = document.createElement('div');
      mount.className = 'hot-mount';

      card.appendChild(head);
      card.appendChild(sub);
      card.appendChild(mount);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á Handsontable ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 5√ó5
      const { headers, rowsData } = defaultMatrix();
      const hot = new Handsontable(mount, {
        themeName: 'ht-theme-main-dark-auto',
        data: rowsData,
        colHeaders: headers,
        rowHeaders: true,
        manualColumnMove: true,
        manualRowMove: true,
        stretchH: 'all',
        contextMenu: true,
        height: 'auto',
        licenseKey: 'non-commercial-and-evaluation'
      });

      // ‡πÄ‡∏Å‡πá‡∏ö state
      const tb = { title_no: anchorNo, caption: '', display_title: '', seq, hot };
      allTables.push(tb);

      // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå
      const updateTitle = () => {
        tb.display_title = formatDisplayTitle(CHAPTER_NO, tb.seq, tb.caption);
        sub.textContent = tb.display_title;
      };
      updateTitle();
      caption.addEventListener('input', (e) => { tb.caption = e.target.value; updateTitle(); refreshJsonOutput(); });

      // ‡∏õ‡∏∏‡πà‡∏° action (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Äú‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ alter()‚Äù)
      head.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-act]');
        if (!btn) return;
        const act = btn.dataset.act;

        if (act === 'add-row') addRowAfterSelection(hot);
        if (act === 'del-row') removeRowAtSelection(hot);
        if (act === 'add-col') addColAfterSelection(hot);
        if (act === 'del-col') removeColAtSelection(hot);
        if (act === 'remove') {
          if (confirm('‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ?')) {
            const i = allTables.indexOf(tb);
            if (i >= 0) allTables.splice(i, 1);
            card.remove();
          }
        }
        refreshJsonOutput();
      });

      return card;
    }

    // ===== Wire buttons =====
    document.getElementById('btnCreate').addEventListener('click', () => {
      const card = createTableCard();
      document.getElementById('tablesContainer').appendChild(card);
    });

    document.getElementById('btnShowJson').addEventListener('click', refreshJsonOutput);
  </script>
</body>
</html>

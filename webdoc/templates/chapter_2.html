{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ page_title|default:"‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á" }}</title>

  <link rel="stylesheet" href="{% static 'css/chapter_2.css' %}">
</head>

<body>
<div class="page-shell">

  <div class="header-row">
  </div>

  {% if messages %}
  <ul class="messages">
      {% for message in messages %}
      <li{% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
  </ul>
  {% endif %}

  <div id="alert-box"></div>

  <form id="chapter2Form" method="POST" action="{% url 'chapter_2' %}">
    {% csrf_token %}

    <section class="section-card-outer">
      <center><h2>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 </h2></center>
      <div class="section-title-head">
       <center> <div>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</div></center>
        
      </div>
      <div class="section-card-body">
        <div class="badge-no">‡∏ö‡∏ó‡∏ô‡∏≥</div>
        <textarea id="intro_body" name="intro_body" class="clean-textarea main-textarea" rows="6" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2...">{{ initial.intro_body|default:'' }}</textarea>
      </div>
    </section>

    
    

      <div id="sections-container" class="chapter2-sections-wrapper"></div>

      <div style="margin-top:12px;">
        <button id="btnAddSection" class="main-btn main-btn-neutral" type="button" style="box-shadow:none;">
          <span class="emoji">‚ûï</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (2.x)</span>
        </button>
      </div>

      <input type="hidden" id="sections_json" name="sections_json" value="[]">
   

    <div class="footer-action-bar">

      <button id="btnSave" class="main-btn main-btn-success" 
              type="submit" name="action" value="save">
        <span class="emoji">üíæ</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>

      <button id="btnGetData" class="main-btn main-btn-info" 
              type="submit" name="action" value="get_data">
        <span class="emoji">üîÑ</span><span>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>

      <button id="btnGen" class="main-btn main-btn-danger" 
              type="submit" name="action" value="generate_doc">
        <span class="emoji">üìÑ</span><span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
      </button>

    </div>
  </form>

  {% if initial.sections %}{{ initial.sections|json_script:"chapter2-data" }}{% endif %}

</div> 

<script>
// ========================= CSRF Helper (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö postAction) =========================
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return "";
}
function getCsrfToken() { return getCookie("csrftoken"); }

// ========================= Alert / Toast (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö postAction) =========================
const alertBox = (() => {
  const el = () => document.getElementById("alert-box");
  function show(msg, type = "info", timeoutMs = 3000) {
    const box = el();
    if (!box) return;
    box.textContent = msg;
    box.className = "";
    box.classList.add(type);
    box.classList.add("show");
    if (timeoutMs) {
      setTimeout(() => {
        if (box.textContent === msg) {
          box.textContent = "";
          box.className = "";
        }
      }, timeoutMs);
    }
  }
  return { show };
})();

// ========================= Data Model =========================
function makeNode() {
  return {
    text: "",
    paragraphs: [],
    pictures: [],   // [{pic_no, pic_name, pic_path, id?, server_pic_no?}]
    children: []
  };
}

function makeSection(title_no, title) {
  return {
    title_no,
    title,
    body_paragraphs: [],
    pictures: [],
    items: [ makeNode() ]
  };
}

// state ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
let sectionsState = [
  makeSection("2.1", "‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á"),
  makeSection("2.2", "‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á")
];

// key => File ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô node ‡∏ô‡∏±‡πâ‡∏ô
const pendingFiles = {}; // {"secIndex|path.path": File}

// ========================= Utils / AJAX (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö add_picture ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) =========================
function syncHiddenField() {
  const hidden = document.getElementById("sections_json");
  if (!hidden) return;
  hidden.value = JSON.stringify(sectionsState);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 'add_picture' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
async function postAction(action, extra = {}, fileToUpload = null) {
  const url = window.location.href;
  const fd  = new FormData();
  fd.append("action", action);
  Object.entries(extra).forEach(([k,v]) => fd.append(k, v));
  if (fileToUpload) fd.append("pic_file", fileToUpload);

  const res = await fetch(url, {
    method: "POST",
    headers: { "X-CSRFToken": getCsrfToken() },
    body: fd
  });

  const ct = res.headers.get("Content-Type") || "";
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text);
  }
  if (ct.includes("application/json")) return res.json();
  return res.text();
}

// (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helpers ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà JS ‡πÉ‡∏ä‡πâ ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°... )
function getNodeByPath(sectionObj, pathArr) {
  if (pathArr.length === 0) return null;
  let cur = sectionObj.items[pathArr[0]];
  for (let i = 1; i < pathArr.length; i++) {
    cur = cur.children[pathArr[i]];
  }
  return cur;
}
function buildNodeNumber(sectionNo, pathArr) {
  if (!pathArr || pathArr.length === 0) return sectionNo;
  const suffix = pathArr.map(i => (i+1)).join(".");
  return sectionNo + "." + suffix;
}
function fileKey(secIndex, pathArr) {
  if (!pathArr || pathArr.length === 0) return secIndex + "|";
  return secIndex + "|" + pathArr.join(".");
}
function getNextSectionNumber() {
  if (sectionsState.length === 0) return "2.1";
  const last = sectionsState[sectionsState.length - 1].title_no || "2.1";
  const parts = last.split(".");
  if (parts.length === 2) {
    const chap = parts[0]; // "2"
    const idx  = parseInt(parts[1], 10) || 1;
    return chap + "." + (idx + 1);
  }
  return "2." + (sectionsState.length + 1);
}

// ===== Picture numbering ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) =====
function parseSeqFromPicNo(pic_no) {
  if (!pic_no || typeof pic_no !== "string") return 0;
  const m = String(pic_no).match(/^(\d+)-(\d+)$/); // 2-15 -> 15
  return m ? parseInt(m[2], 10) : 0;
}
function normalizePicNo(anyPicNo) {
  if (!anyPicNo) return anyPicNo;
  const m = String(anyPicNo).match(/^(\d+)(?:\.\d+)*-(\d+)$/); // "2.2.1-7" -> ["2","7"]
  return m ? `${m[1]}-${m[2]}` : anyPicNo;
}
function collectChapterPicSeqs(chapterNo) {
  const seqs = new Set();
  function scan(arr) {
    (arr || []).forEach(p => {
      const pn = normalizePicNo(p && p.pic_no);
      if (pn && String(pn).startsWith(chapterNo + "-")) {
        const n = parseSeqFromPicNo(pn);
        if (n > 0) seqs.add(n);
      }
    });
  }
  function walk(node) {
        if (!node) return;
        scan(node.pictures);
        (node.children || []).forEach(walk);
      }
      (sectionsState || []).forEach(sec => {
        scan(sec.pictures);
        (sec.items || []).forEach(walk);
      });
      return seqs;
}
function computeFirstFreePicNoForChapter(chapterNo) {
  const seqs = collectChapterPicSeqs(chapterNo);
  let i = 1; while (seqs.has(i)) i += 1;
  return `${chapterNo}-${i}`;
}

// ========================= Paragraph Editor =========================
function renderParagraphs(arr, onChangeContent, onAddOrRemove) {
  const wrap = document.createElement("div");
  wrap.className = "paras-wrap";
  arr.forEach((txt, idx) => {
    const row = document.createElement("div");
    row.className = "para-row";
    const ta = document.createElement("textarea");
    ta.classList.add("clean-textarea");
    ta.value = txt || "";
    ta.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ . . .";
    ta.addEventListener("input", (e) => {
      arr[idx] = e.target.value;
      if (onChangeContent) onChangeContent();
    });
    const del = document.createElement("button");
    del.type = "button";
    del.className = "del-para-btn";
    del.textContent = "‡∏•‡∏ö";
    del.addEventListener("click", () => {
      arr.splice(idx,1);
      if (onAddOrRemove) onAddOrRemove();
    });
    row.appendChild(ta);
    row.appendChild(del);
    wrap.appendChild(row);
  });
  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "add-para-btn";
  addBtn.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  addBtn.addEventListener("click", () => {
    arr.push("");
    if (onAddOrRemove) onAddOrRemove();
  });
  wrap.appendChild(addBtn);
  return wrap;
}

// ========================= Picture Box (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ postAction) =========================
function renderPicturesBox(sectionObj, secIndex, pathArr) {
  // ( ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô renderPicturesBox ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ... )
  // ( ... ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ AJAX (postAction) ... )
  // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (2.x)
  if (!pathArr || pathArr.length === 0) {
    return document.createElement("div"); // ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤
  }
  const picsBox = document.createElement("div");
  picsBox.className = "pics-box";
  const targetNode = getNodeByPath(sectionObj, pathArr);
  if (!targetNode.pictures) {
    targetNode.pictures = [];
  }
  const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
  const keyForThisNode = fileKey(secIndex, pathArr);
  const head = document.createElement("div");
  head.className = "pics-head";
  head.textContent = `‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${nodeNo}`;
  picsBox.appendChild(head);
  const addRow = document.createElement("div");
  addRow.className = "pics-add-row";
  const captionInput = document.createElement("input");
  captionInput.type = "text";
  captionInput.className = "pic-caption-input";
  captionInput.placeholder = "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ (‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 2-1 : ‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö)";
  const pendingLabel = document.createElement("div");
  pendingLabel.style.fontSize = "12px";
  pendingLabel.style.color = "#6b7280";
  pendingLabel.style.minWidth = "160px";
  const pickBtn = document.createElement("button");
  pickBtn.type = "button";
  pickBtn.className = "mini-btn";
  pickBtn.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‚Ä¶";
  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "mini-btn";
  addBtn.textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ";
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.style.display = "none";
  pickBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", () => {
    if (fileInput.files && fileInput.files.length > 0) {
      pendingFiles[keyForThisNode] = fileInput.files[0];
      pendingLabel.textContent = "‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + fileInput.files[0].name;
      alertBox.show(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ: ${fileInput.files[0].name}`, "info");
    }
  });
  addBtn.addEventListener("click", async () => {
    const picName = (captionInput.value || "").trim();
    const f = pendingFiles[keyForThisNode];
    if (!picName) { alertBox.show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "warning"); return; }
    if (!f)       { alertBox.show("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ", "warning"); return; }
    alertBox.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...", "info", 0);
    try {
      const chapterNo = String(sectionObj.title_no).split(".")[0] || "2";
      const nextPicNo = computeFirstFreePicNoForChapter(chapterNo);
      const data = await postAction(
        "add_picture",
        {
          node_no: nodeNo,
          pic_name: picName,
          pic_path: f.name,
          pic_no: nextPicNo
        },
        f
      );
      const pushed = (data && data.picture) ? { ...data.picture } : { pic_name: picName, pic_path: f.name };
      pushed.pic_no = nextPicNo;
      targetNode.pictures.push(pushed);
      captionInput.value = "";
      pendingLabel.textContent = "";
      delete pendingFiles[keyForThisNode];
      renderPicturesList(); // <--- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
      alertBox.show((data && data.message) || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
    } catch (err) {
      console.error(err);
      alertBox.show("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (" + err.message + ")", "error", 5000);
    }
  });
  addRow.appendChild(captionInput);
  addRow.appendChild(pickBtn);
  addRow.appendChild(pendingLabel);
  addRow.appendChild(addBtn);
  addRow.appendChild(fileInput);
  picsBox.appendChild(addRow);
  const list = document.createElement("div");
  list.className = "pic-list";
  function renderPicturesList() {
    list.innerHTML = "";
    const arr = targetNode.pictures || [];
    if (arr.length === 0) {
      const empty = document.createElement("div");
      empty.className = "pic-item";
      empty.style.background = "#fff";
      empty.style.borderStyle = "dashed";
      empty.style.color = "#6b7280";
      empty.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ";
      list.appendChild(empty);
      return;
    }
    arr.sort((a, b) => {
      const an = parseSeqFromPicNo(normalizePicNo(a.pic_no));
      const bn = parseSeqFromPicNo(normalizePicNo(b.pic_no));
      return an - bn;
    });
    arr.forEach((p, idx) => {
      const shownNo = normalizePicNo(p.pic_no);
      const item = document.createElement("div");
      item.className = "pic-item";
      item.dataset.idx = String(idx);
      item.innerHTML = `
        <div class="pic-main">
          <strong>‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${shownNo || "-"}</strong> : ${p.pic_name || ""}
          ${p.pic_path ? `<div class="pic-path">${p.pic_path}</div>` : ""}
        </div>
        <div class="pic-actions">
          <button type="button" class="mini-btn danger" data-act="del">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
          <button type="button" class="mini-btn outline" data-act="edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
      `;
      list.appendChild(item);
    });
  }
  list.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-act]");
    if (!btn) return;
    const item = btn.closest(".pic-item");
    if (!item) return;
    const idx = parseInt(item.dataset.idx, 10);
    const arr = targetNode.pictures || [];
    const p = arr[idx];
    if (!p) return;
    if (btn.dataset.act === "del") {
      const shownNo = normalizePicNo(p.pic_no);
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${shownNo || "-"}`)) return;
      try {
        const payload = p.id ? { pic_id: p.id } : { node_no: nodeNo, pic_no: shownNo };
        const res = await postAction("delete_picture", payload); 
        if (res && res.status === "ok") {
          arr.splice(idx, 1);
          renderPicturesList();
          alertBox.show("‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success", 1200);
        } else {
          throw new Error((res && res.message) || "delete failed");
        }
      } catch (e2) {
        console.error(e2);
        alertBox.show("‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "danger", 1500);
      }
    }
    if (btn.dataset.act === "edit") {
      const newName = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ:", p.pic_name || "");
      if (newName === null) return;
      try {
        const payload = p.id ? { pic_id: p.id, pic_name: newName }
                             : { node_no: nodeNo, pic_no: normalizePicNo(p.pic_no), pic_name: newName };
        const res = await postAction("edit_picture", payload);
        if (res && res.status === "ok") {
          arr[idx].pic_name = newName;
          renderPicturesList();
          alertBox.show("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success", 1200);
        } else {
          throw new Error((res && res.message) || "edit failed");
        }
      } catch (e3) {
        console.error(e3);
        alertBox.show("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "danger", 1500);
      }
    }
  });
  renderPicturesList();
  picsBox.appendChild(list);
  return picsBox;
}

// ========================= Node Renderer (‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢) =========================
function renderNode(sectionObj, secIndex, nodeObj, pathArr) {
  // ( ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô renderNode ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ... )
  const nodeEl = document.createElement("div");
  nodeEl.className = "node-card";
  const topRow = document.createElement("div");
  topRow.className = "node-top-row";
  const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
  const badge = document.createElement("div");
  badge.className = "node-no-badge";
  badge.textContent = nodeNo;
  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.className = "node-title-input";
  titleInput.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‚Ä¶";
  titleInput.value = nodeObj.text || "";
  titleInput.addEventListener("input", (e) => {
    nodeObj.text = e.target.value;
    syncHiddenField(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï hidden ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà redraw
  });
  const controls = document.createElement("div");
  controls.className = "node-controls";
  const btnAddPara = document.createElement("button");
  btnAddPara.type = "button";
  btnAddPara.className = "mini-btn";
  btnAddPara.textContent = "‚ûï ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  btnAddPara.addEventListener("click", () => {
    if (!nodeObj.paragraphs) nodeObj.paragraphs = []; // Ensure array exists
    nodeObj.paragraphs.push("");
    redrawSections(); // ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á redraw
  });
  const btnAddChild = document.createElement("button");
  btnAddChild.type = "button";
  btnAddChild.className = "mini-btn";
  btnAddChild.textContent = "‚ûï ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
  btnAddChild.addEventListener("click", () => {
    if (!nodeObj.children) nodeObj.children = []; // Ensure array exists
    nodeObj.children.push(makeNode());
    redrawSections(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏´‡∏°‡πà -> redraw
  });
  const btnDelNode = document.createElement("button");
  btnDelNode.type = "button";
  btnDelNode.className = "mini-btn";
  btnDelNode.textContent = "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ";
  btnDelNode.addEventListener("click", () => {
    const [rootIdx, ...rest] = pathArr;
    if (rest.length === 0) {
      sectionObj.items.splice(rootIdx,1);
    } else {
      const parentPath = pathArr.slice(0, -1);
      const parentNode = getNodeByPath(sectionObj, parentPath);
      const myIdx = pathArr[pathArr.length-1];
      parentNode.children.splice(myIdx,1);
    }
    redrawSections(); // ‡∏•‡∏ö -> redraw
  });
  controls.appendChild(btnAddPara);
  controls.appendChild(btnAddChild);
  controls.appendChild(btnDelNode);
  topRow.appendChild(badge);
  topRow.appendChild(titleInput);
  topRow.appendChild(controls);
  nodeEl.appendChild(topRow);
  if (nodeObj.paragraphs && nodeObj.paragraphs.length > 0) {
    nodeEl.appendChild(
      renderParagraphs(
        nodeObj.paragraphs,
        () => { // onChangeContent (‡πÅ‡∏Ñ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå)
          syncHiddenField();
        },
        () => { // onAddOrRemove (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)
          redrawSections();
        }
      )
    );
  } else {
    const firstParaBtn = document.createElement("button");
    firstParaBtn.type = "button";
    firstParaBtn.className = "mini-btn";
    firstParaBtn.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
    firstParaBtn.addEventListener("click", () => {
      if (!nodeObj.paragraphs) nodeObj.paragraphs = [];
      nodeObj.paragraphs.push("");
      redrawSections(); // ‡πÄ‡∏û‡∏¥‡πà‡∏° -> redraw
    });
    nodeEl.appendChild(firstParaBtn);
  }
  nodeEl.appendChild(renderPicturesBox(sectionObj, secIndex, pathArr));
  const childrenWrap = document.createElement("div");
  childrenWrap.className = "children-block";
  if (nodeObj.children) { // Check if children array exists
    nodeObj.children.forEach((childNode, childIdx) => {
      const childPath = [...pathArr, childIdx];
      childrenWrap.appendChild(
        renderNode(sectionObj, secIndex, childNode, childPath)
      );
    });
  }
  if (!nodeObj.children || nodeObj.children.length === 0) {
    const addChildInline = document.createElement("button");
    addChildInline.type = "button";
    addChildInline.className = "mini-btn";
    addChildInline.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
    addChildInline.addEventListener("click", () => {
      if (!nodeObj.children) nodeObj.children = [];
      nodeObj.children.push(makeNode());
      redrawSections();
    });
    childrenWrap.appendChild(addChildInline);
  }
  nodeEl.appendChild(childrenWrap);
  return nodeEl;
}

// ( ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô renderSectionTree, renderSectionCard, redrawSections ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ... )
function renderSectionTree(sectionObj, secIndex) {
  const treeWrap = document.createElement("div");
  treeWrap.className = "tree-wrap";
  if (sectionObj.items) { // Check if items array exists
    sectionObj.items.forEach((node, idx) => {
      const pathArr = [idx];
      treeWrap.appendChild(
        renderNode(sectionObj, secIndex, node, pathArr)
      );
    });
  }
  const addRootBtn = document.createElement("button");
  addRootBtn.type = "button";
  addRootBtn.className = "mini-btn";
  addRootBtn.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å";
  addRootBtn.addEventListener("click", () => {
    if (!sectionObj.items) sectionObj.items = [];
    sectionObj.items.push(makeNode());
    redrawSections();
  });
  treeWrap.appendChild(addRootBtn);
  return treeWrap;
}
function renderSectionCard(sectionObj, secIndex) {
  const wrap = document.createElement("div");
  wrap.className = "chapter-section-card";
  const headRow = document.createElement("div");
  headRow.className = "chapter-head-row";
  const badge = document.createElement("div");
  badge.className = "badge-no";
  badge.textContent = sectionObj.title_no;
  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.className = "chapter-title-input";
  titleInput.placeholder = "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á";
  titleInput.value = sectionObj.title || "";
  titleInput.addEventListener("input", (e) => {
    sectionObj.title = e.target.value;
    syncHiddenField(); // ‡πÑ‡∏°‡πà redraw ‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
  });
  const delSectionBtn = document.createElement("button");
  delSectionBtn.type = "button";
  delSectionBtn.className = "mini-btn";
  delSectionBtn.style.marginLeft = "auto";
  delSectionBtn.textContent = "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà";
  delSectionBtn.addEventListener("click", () => {
    sectionsState.splice(secIndex, 1);
    redrawSections(); // ‡∏•‡∏ö -> redraw
  });
  headRow.appendChild(badge);
  headRow.appendChild(titleInput);
  headRow.appendChild(delSectionBtn);
  wrap.appendChild(headRow);
  const overBlock = document.createElement("div");
  overBlock.className = "overview-block";
  const overLabel = document.createElement("div");
  overLabel.className = "overview-label";
  overLabel.textContent = "‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°):";
  overBlock.appendChild(overLabel);
  if (!sectionObj.body_paragraphs) sectionObj.body_paragraphs = []; 
  overBlock.appendChild(
    renderParagraphs(
      sectionObj.body_paragraphs,
      () => { // onChangeContent
        syncHiddenField();
      },
      () => { // onAddOrRemove
        redrawSections();
      }
    )
  );
  wrap.appendChild(overBlock);
  wrap.appendChild(renderSectionTree(sectionObj, secIndex));
  return wrap;
}
function redrawSections() {
  const container = document.getElementById("sections-container");
  if (!container) return; // Guard clause
  container.innerHTML = "";
  sectionsState.forEach((secObj, secIndex) => {
    container.appendChild(renderSectionCard(secObj, secIndex));
  });
  syncHiddenField();
}

// ========================= BUTTON HANDLERS (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà) =========================
function wireButtons() {
  // const btnGet = document.getElementById("btnGetData"); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
  // const btnSave = document.getElementById("btnSave"); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
  // const btnGen  = document.getElementById("btnGenerate"); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
  const btnAddSection = document.getElementById("btnAddSection");

  // ‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" (Get Data) ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Form Submit (‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà 2)
  // ‡∏à‡∏∂‡∏á‡∏•‡∏ö event listener ‡∏Ç‡∏≠‡∏á 'get_data' ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô AJAX ‡∏≠‡∏≠‡∏Å

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏´‡∏°‡πà (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)
  if (btnAddSection) {
    btnAddSection.addEventListener("click", () => {
      const nextNo = getNextSectionNumber();
      const newSec = makeSection(nextNo, "");
      sectionsState.push(newSec);
      redrawSections();
      // alertBox.show(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${nextNo} ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ`, "success"); // ‡πÉ‡∏ä‡πâ messages ‡πÅ‡∏ó‡∏ô
    });
  }
}

// [‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà 5] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô json_script (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô chapter_1.html)
function getJsonScript(id){
  const el = document.getElementById(id);
  if(!el) return null;
  try { return JSON.parse(el.textContent); } catch(e){ console.error('JSON Script Error:', e); return null; }
}

// ========================= init (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥) =========================
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("chapter2Form");

  const pre = getJsonScript('chapter2-data');
  if (pre && Array.isArray(pre) && pre.length > 0) {
      const remapPicture = (p) => {
        const server_no = p.pic_no || p.server_pic_no || "";
        return { ...p, pic_no: normalizePicNo(p.pic_no) };
      };
      const remapNode = (rawNode) => ({
        text: rawNode.text || "",
        paragraphs: Array.isArray(rawNode.paragraphs) ? rawNode.paragraphs.slice() : [],
        pictures: Array.isArray(rawNode.pictures) ? rawNode.pictures.map(remapPicture) : [],
        children: Array.isArray(rawNode.children) ? rawNode.children.map(remapNode) : []
      });
      sectionsState = pre.map(sec => ({
        title_no: sec.title_no || "",
        title: sec.title || "",
        body_paragraphs: Array.isArray(sec.body_paragraphs) ? sec.body_paragraphs.slice() : [],
        pictures: Array.isArray(sec.pictures) ? sec.pictures.map(remapPicture) : [],
        items: Array.isArray(sec.items) ? sec.items.map(remapNode) : []
      }));
  }

  redrawSections();
  wireButtons();

  if (form) {
   

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô ‚Äú‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‚Äù
    form.addEventListener("submit", function (e) {
      const textareas = form.querySelectorAll("textarea");
      textareas.forEach(textarea => {
        const rawText = textarea.value;
        const cleanedText = rawText
          .replace(/\r?\n/g, "")      // ‡∏•‡∏ö \n ‡πÅ‡∏•‡∏∞ \r
          .replace(/\s+/g, " ")       // ‡∏¢‡∏∏‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
          .trim();                    // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢
        textarea.value = cleanedText;
      });
    });

  } else {
    console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö <form id='chapter2Form'> ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ HTML");
  }
});
</script>

</body>
</html>
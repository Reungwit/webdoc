{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ page_title|default:"‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á" }}</title>
  <link rel="stylesheet" href="{% static 'css/chapter_2.css' %}">
</head>

<body>
<div class="page-shell">
  <div class="header-row">
    <div class="header-left"><h1>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h1></div>
  </div>

  {% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li{% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  <div id="alert-box"></div>

  <form id="chapter2Form" method="POST" action="{% url 'chapter_2' %}">
    {% csrf_token %}

    <!-- ============== ‡∏ö‡∏ó‡∏ô‡∏≥ ============== -->
    <section class="section-card-outer">
      <div class="section-title-head">‡∏ö‡∏ó‡∏ô‡∏≥</div>

      <div id="intro-paras"></div>
      <div id="intro-nodes"></div>

      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button id="btnAddIntroPara" class="main-btn main-btn-neutral" type="button">
          <span class="emoji">‚ûï</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</span>
        </button>
        <button id="btnAddIntroNode" class="main-btn main-btn-neutral" type="button">
          <span class="emoji">‚ûï</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏≥ 2.1</span>
        </button>
      </div>
    </section>

    <!-- ============== ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 (2.x) ============== -->
    <section class="section-card-outer">
      <div class="section-title-head">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</div>
      <p class="section-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö 2.x (‡πÄ‡∏ä‡πà‡∏ô 2.1, 2.2, ...), ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢, ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤, ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ</p>

      <div id="sections-container"></div>

      <div style="margin-top:12px;">
        <button id="btnAddSection" class="main-btn main-btn-neutral" type="button">
          <span class="emoji">‚ûï</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å 2.1</span>
        </button>
      </div>
    </section>

    <input type="hidden" id="intro_body" name="intro_body" value="{}">
    <input type="hidden" id="sections_json" name="sections_json" value="[]">

    <div class="footer-action-bar">
      <button class="main-btn main-btn-success" type="submit" name="action" value="save">
        <span class="emoji">üíæ</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>
      <button class="main-btn main-btn-info" type="submit" name="action" value="get_data">
        <span class="emoji">üîÑ</span><span>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>
      <button class="main-btn main-btn-doc" type="submit" name="action" value="generate_doc">
        <span class="emoji">üìÑ</span><span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
      </button>
    </div>
  </form>

  {% if initial.sections %}{{ initial.sections|json_script:"chapter2-data" }}{% endif %}
  {{ initial.intro_paras|default:"{}"|json_script:"intro-body-data" }}
</div>

<!-- ================= INLINE JS ================= -->
<script>
/* ---------- CSRF / alerts ---------- */
function getCookie(name){var value='; '+document.cookie;var parts=value.split('; '+name+'=');if(parts.length===2) return parts.pop().split(';').shift();return'';}
function getCsrfToken(){return getCookie('csrftoken');}
const alertBox=(()=>{const el=()=>document.getElementById('alert-box');function show(msg,type='info',t=3000){const b=el();if(!b)return;b.textContent=msg;b.className='show';b.classList.remove('success','error','warning');if(type)b.classList.add(type);if(t){setTimeout(()=>{if(b.textContent===msg){b.textContent='';b.className='';}},t);} }return{show};})();

/* ---------- helpers ---------- */
function getJsonScript(id){const el=document.getElementById(id);if(!el) return null;try{return JSON.parse(el.textContent);}catch(e){return null;}}
function qs(id){return document.getElementById(id);}

/* ================= ‡∏ö‡∏ó‡∏ô‡∏≥ ================= */
let introData={paragraphs:[],subnodes:[]};
function syncIntroHidden(){const h=qs('intro_body');if(h)h.value=JSON.stringify(introData);}

function refreshIntroButtons(){
  const btn = qs('btnAddIntroNode');
  if (btn) {
    const next = ' 2.' + ((introData.subnodes?.length || 0) + 1);
    btn.querySelector('span:last-child').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏≥' + next;
  }
}

function renderIntroParas(){
  const mount=qs('intro-paras'); mount.innerHTML='';
  if(!introData.paragraphs || introData.paragraphs.length===0){ mount.className=''; refreshIntroButtons(); return; }
  mount.className='chapter2-sections-wrapper';
  introData.paragraphs.forEach((p,i)=>{
    const row=document.createElement('div'); row.className='para-row';
    const ta=document.createElement('textarea'); ta.value=p||''; ta.placeholder='‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤...';
    ta.addEventListener('input',e=>{introData.paragraphs[i]=e.target.value;syncIntroHidden();});
    const del=document.createElement('button'); del.type='button'; del.className='del-para-btn danger'; del.textContent='‡∏•‡∏ö';
    del.addEventListener('click',()=>{introData.paragraphs.splice(i,1);renderIntroParas();});
    row.appendChild(ta); row.appendChild(del); mount.appendChild(row);
  });
  refreshIntroButtons();
  syncIntroHidden();
}

function renderIntroNodes(){
  const wrap=qs('intro-nodes'); wrap.innerHTML='';
  if(!introData.subnodes || introData.subnodes.length===0){ wrap.className=''; refreshIntroButtons(); return; }
  wrap.className='chapter2-sections-wrapper';

  introData.subnodes.forEach((n,idx)=>{
    const card=document.createElement('div'); card.className='chapter-section-card';

    const head=document.createElement('div'); head.className='chapter-head-row';
    const badge=document.createElement('div'); badge.className='badge-no'; badge.textContent='2.'+(idx+1);
    const title=document.createElement('input'); title.type='text'; title.className='chapter-title-input'; title.placeholder='‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ô‡∏≥'; title.value=n.title||'';
    title.addEventListener('input',e=>{n.title=e.target.value;syncIntroHidden();});
    const del=document.createElement('button'); del.type='button'; del.className='mini-btn danger'; del.textContent='‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢';
    del.addEventListener('click',()=>{introData.subnodes.splice(idx,1);renderIntroNodes();syncIntroHidden();});
    head.appendChild(badge); head.appendChild(title); head.appendChild(del);
    card.appendChild(head);

    const paras=document.createElement('div');
    (n.paragraphs||[]).forEach((txt,i)=>{
      const row=document.createElement('div'); row.className='para-row';
      const ta=document.createElement('textarea'); ta.value=txt||''; ta.placeholder='‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢...';
      ta.addEventListener('input',e=>{n.paragraphs[i]=e.target.value;syncIntroHidden();});
      const delp=document.createElement('button'); delp.type='button'; delp.className='del-para-btn danger'; delp.textContent='‡∏•‡∏ö';
      delp.addEventListener('click',()=>{n.paragraphs.splice(i,1);renderIntroNodes();});
      row.appendChild(ta); row.appendChild(delp);
      paras.appendChild(row);
    });
    const addp=document.createElement('button'); addp.type='button'; addp.className='add-para-btn'; addp.textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ';
    addp.addEventListener('click',()=>{n.paragraphs.push('');renderIntroNodes();});
    paras.appendChild(addp);

    card.appendChild(paras);
    wrap.appendChild(card);
  });

  refreshIntroButtons();
  syncIntroHidden();
}

document.addEventListener('DOMContentLoaded',()=>{
  try{
    const raw=qs('intro-body-data');
    if(raw){
      const d=JSON.parse(raw.textContent||'{}');
      if(d && (Array.isArray(d.paragraphs)||Array.isArray(d.subnodes))) introData=d;
    }
  }catch(e){}
  renderIntroParas(); renderIntroNodes();

  qs('btnAddIntroPara').onclick=()=>{ if(!introData.paragraphs) introData.paragraphs=[]; introData.paragraphs.push(''); renderIntroParas(); };
  qs('btnAddIntroNode').onclick=()=>{ if(!introData.subnodes) introData.subnodes=[]; introData.subnodes.push({title:'',paragraphs:['']}); renderIntroNodes(); };
});

/* ================= ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (2.x) ================= */
function makeNode(){return{ text:'', paragraphs:[], pictures:[], captions:[], children:[] };}
function makeSection(no,title){return{ title_no:no, title, body_paragraphs:[], pictures:[], items:[makeNode()] };}

let sectionsState=[]; const pendingFiles={};
function syncSectionsHidden(){const h=qs('sections_json'); if(h) h.value=JSON.stringify(sectionsState);}
function buildNodeNumber(no,path){ if(!path||path.length===0) return no; return no+'.'+path.map(i=>i+1).join('.'); }
function getNodeByPath(sec,path){ if(path.length===0) return null; let cur=sec.items[path[0]]; for(let i=1;i<path.length;i++){cur=cur.children[path[i]];} return cur; }
function getNextSectionNumber(){ if(sectionsState.length===0) return '2.1'; const last=sectionsState[sectionsState.length-1].title_no||'2.1'; const idx=parseInt((last.split('.')[1]||'1'),10)||1; return '2.'+(idx+1); }

/* ‡∏•‡∏ö‡πÇ‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏° path ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ */
function removeNodeByPath(sectionObj, pathArr){
  if (!Array.isArray(pathArr) || pathArr.length===0) return false;
  if (pathArr.length===1){
    if (!Array.isArray(sectionObj.items)) return false;
    sectionObj.items.splice(pathArr[0], 1);
    return true;
  }
  const parentPath = pathArr.slice(0, -1);
  const parent = getNodeByPath(sectionObj, parentPath);
  if (!parent || !Array.isArray(parent.children)) return false;
  parent.children.splice(pathArr[pathArr.length-1], 1);
  return true;
}

/* ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏ó: 2-1, 2-2, ... */
function normalizePicNo(x){ if(!x) return x; const m=String(x).match(/^(\d+)(?:\.\d+)*-(\d+)$/); return m? (m[1]+'-'+m[2]) : x; }
function parseSeqFromPicNo(s){ if(!s) return 0; const m=String(s).match(/^(\d+)-(\d+)$/); return m?parseInt(m[2],10):0; }
function collectChapterPicSeqs(ch){ const set=new Set(); function scan(arr){ (arr||[]).forEach(p=>{ const n=normalizePicNo(p&&p.pic_no); if(n&&String(n).startsWith(ch+'-')) set.add(parseSeqFromPicNo(n)); }); }
  sectionsState.forEach(sec=>{ scan(sec.pictures); (sec.items||[]).forEach(function walk(n){ scan(n.pictures); (n.children||[]).forEach(walk); });});
  return set;
}
function firstFreePicNo(ch){ const used=collectChapterPicSeqs(ch); let i=1; while(used.has(i)) i++; return ch+'-'+i; }

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å */
function refreshAddSectionButton(){
  const btn=qs('btnAddSection');
  if(btn){ btn.querySelector('span:last-child').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ' + getNextSectionNumber(); }
}

async function postAction(action, extra={}, fileToUpload=null){
  const url=window.location.href;
  const fd=new FormData(); fd.append('action',action);
  Object.entries(extra).forEach(([k,v])=>fd.append(k,v));
  if(fileToUpload) fd.append('pic_file',fileToUpload);
  const res=await fetch(url,{method:'POST',headers:{'X-CSRFToken':getCsrfToken()},body:fd});
  const ct=res.headers.get('Content-Type')||''; if(!res.ok) throw new Error(await res.text());
  return ct.includes('application/json')?res.json():res.text();
}

function renderImageCaptions(pic,onChange,onMutate){
  if(!pic.captions) pic.captions=[];
  const box=document.createElement('div');
  const list=document.createElement('div');
  pic.captions.forEach((cap,i)=>{
    const row=document.createElement('div'); row.className='para-row';
    const ta=document.createElement('textarea'); ta.value=cap||''; ta.placeholder='‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ...';
    ta.addEventListener('input',e=>{pic.captions[i]=e.target.value; onChange&&onChange();});
    row.appendChild(ta); list.appendChild(row);
  });
  const add=document.createElement('button'); add.type='button'; add.className='add-para-btn'; add.textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ï‡πâ‡∏£‡∏π‡∏õ';
  add.addEventListener('click',()=>{pic.captions.push(''); onMutate&&onMutate();});
  const delLast=document.createElement('button'); delLast.type='button'; delLast.className='del-para-btn danger'; delLast.textContent='‡∏•‡∏ö‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
  delLast.addEventListener('click',()=>{ if(pic.captions.length>0){ pic.captions.pop(); onMutate&&onMutate(); } });
  box.appendChild(list); box.appendChild(add); box.appendChild(delLast);
  return box;
}

function renderPicturesBox(sectionObj,secIndex,pathArr){
  if(!pathArr||pathArr.length===0) return document.createElement('div');
  const box=document.createElement('div'); box.className='pics-box';
  const node=getNodeByPath(sectionObj,pathArr); if(!node.pictures) node.pictures=[];
  const nodeNo=buildNodeNumber(sectionObj.title_no,pathArr); const key=secIndex+'|'+pathArr.join('.');

  const head=document.createElement('div'); head.className='pics-head'; head.textContent='‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ '+nodeNo; box.appendChild(head);

  const addRow=document.createElement('div'); addRow.className='pics-add-row';
  const caption=document.createElement('input'); caption.type='text'; caption.className='pic-caption-input'; caption.placeholder='‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ (‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 2-1 : ‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö)';
  const pick=document.createElement('button'); pick.type='button'; pick.className='mini-btn select-btn'; pick.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‚Ä¶';
  const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='mini-btn'; addBtn.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ';
  const label=document.createElement('div'); label.style.fontSize='12px'; label.style.color='#6b7280';
  const file=document.createElement('input'); file.type='file'; file.accept='image/*'; file.style.display='none';

  pick.addEventListener('click',()=>file.click());
  file.addEventListener('change',()=>{ if(file.files&&file.files.length>0){ pendingFiles[key]=file.files[0]; label.textContent='‡πÑ‡∏ü‡∏•‡πå: '+file.files[0].name; }});

  addBtn.addEventListener('click', async ()=>{
    const name=(caption.value||'').trim(); const f=pendingFiles[key];
    if(!name){alertBox.show('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ','warning');return;}
    if(!f){alertBox.show('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ','warning');return;}
    try{
      alertBox.show('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...','info',0);
      const picNo=firstFreePicNo('2');
      const res=await postAction('add_picture',{node_no:nodeNo,pic_name:name,pic_no:picNo,pic_path:f.name},f);
      const pushed=(res&&res.picture)?{...res.picture}:{pic_name:name,pic_no:picNo,pic_path:f.name};
      if(!pushed.captions) pushed.captions=[];
      node.pictures.push(pushed);
      caption.value=''; label.textContent=''; delete pendingFiles[key];
      renderList(); syncSectionsHidden(); alertBox.show('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
    }catch(e){alertBox.show('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error',3000);}
  });

  addRow.appendChild(caption); addRow.appendChild(pick); addRow.appendChild(label); addRow.appendChild(addBtn); addRow.appendChild(file);
  box.appendChild(addRow);

  const list=document.createElement('div'); list.className='pic-list';
  function renderList(){
    list.innerHTML='';
    const arr=(node.pictures||[]);
    if(arr.length===0){ const d=document.createElement('div'); d.className='pic-item'; d.style.borderStyle='dashed'; d.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ'; list.appendChild(d); return; }
    arr.sort((a,b)=>parseSeqFromPicNo(normalizePicNo(a.pic_no))-parseSeqFromPicNo(normalizePicNo(b.pic_no)));
    arr.forEach((p,idx)=>{
      const shown=normalizePicNo(p.pic_no);
      const item=document.createElement('div'); item.className='pic-item';
      const main=document.createElement('div');
      main.innerHTML='<strong>‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà '+(shown||'-')+'</strong> : '+(p.pic_name||'')+(p.pic_path?'<div class="pic-path">'+p.pic_path+'</div>':'');
      const del=document.createElement('button'); del.type='button'; del.className='del-para-btn danger'; del.textContent='‡∏•‡∏ö‡∏£‡∏π‡∏õ';
      del.addEventListener('click',()=>{ if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç '+(shown||'-'))) return; node.pictures.splice(idx,1); renderList(); syncSectionsHidden(); });
      item.appendChild(main);
      item.appendChild(renderImageCaptions(p,()=>syncSectionsHidden(),()=>{renderList(); syncSectionsHidden();}));
      item.appendChild(del);
      list.appendChild(item);
    });
  }
  renderList();
  box.appendChild(list);
  return box;
}

function renderParagraphs(arr,onChange,onMutate){
  const wrap=document.createElement('div');
  arr.forEach((txt,idx)=>{
    const row=document.createElement('div'); row.className='para-row';
    const ta=document.createElement('textarea'); ta.value=txt||''; ta.placeholder='‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤...';
    ta.addEventListener('input',e=>{arr[idx]=e.target.value;onChange&&onChange();});
    const del=document.createElement('button'); del.type='button'; del.className='del-para-btn danger'; del.textContent='‡∏•‡∏ö';
    del.addEventListener('click',()=>{arr.splice(idx,1);onMutate&&onMutate();});
    row.appendChild(ta); row.appendChild(del); wrap.appendChild(row);
  });
  const add=document.createElement('button'); add.type='button'; add.className='add-para-btn'; add.textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤';
  add.addEventListener('click',()=>{arr.push('');onMutate&&onMutate();});
  wrap.appendChild(add);
  return wrap;
}

function renderNode(sectionObj,secIndex,nodeObj,pathArr){
  const wrap=document.createElement('div'); wrap.className='node-card';

  const top=document.createElement('div'); top.className='node-top-row';
  const nodeNo = buildNodeNumber(sectionObj.title_no,pathArr);
  const badge=document.createElement('div'); badge.className='node-no-badge'; badge.textContent=nodeNo;

  const title=document.createElement('input'); title.type='text'; title.className='node-title-input'; title.placeholder='‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‚Ä¶'; title.value=nodeObj.text||'';
  title.addEventListener('input',e=>{nodeObj.text=e.target.value; syncSectionsHidden();});

  const ctr=document.createElement('div'); ctr.className='node-controls';

  const delNode=document.createElement('button'); delNode.type='button'; delNode.className='mini-btn danger'; delNode.textContent='‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ '+nodeNo;
  delNode.addEventListener('click',()=>{
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ '+nodeNo+' ?')) return;
    const ok = removeNodeByPath(sectionObj, pathArr);
    if (ok){ redrawSections(); } else { alertBox.show('‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
  });

  ctr.appendChild(delNode);
  top.appendChild(badge); top.appendChild(title); top.appendChild(ctr);
  wrap.appendChild(top);

  if(nodeObj.paragraphs && nodeObj.paragraphs.length){
    wrap.appendChild(renderParagraphs(nodeObj.paragraphs, ()=>syncSectionsHidden(), ()=>{redrawSections();}));
  }else{
    const btn=document.createElement('button'); btn.type='button'; btn.className='mini-btn'; btn.textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤';
    btn.style.marginBottom='12px';
    btn.addEventListener('click',()=>{ if(!nodeObj.paragraphs) nodeObj.paragraphs=[]; nodeObj.paragraphs.push(''); redrawSections(); });
    wrap.appendChild(btn);
  }

  const pics = renderPicturesBox(sectionObj,secIndex,pathArr);
  pics.style.marginTop = '12px';
  wrap.appendChild(pics);

  const children=document.createElement('div'); children.className='children-block';
  (nodeObj.children||[]).forEach((ch,i)=>{children.appendChild(renderNode(sectionObj,secIndex,ch,[...pathArr,i]));});
  wrap.appendChild(children);

  const nextChildNo = nodeNo + '.' + ((nodeObj.children?.length || 0) + 1);
  const addChild=document.createElement('button'); addChild.type='button'; addChild.className='mini-btn';
  addChild.textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ '+nextChildNo;
  addChild.addEventListener('click',()=>{ if(!nodeObj.children) nodeObj.children=[]; nodeObj.children.push(makeNode()); redrawSections(); });
  wrap.appendChild(addChild);

  return wrap;
}

function renderSectionTree(sectionObj,secIndex){
  const tree=document.createElement('div'); tree.className='tree-wrap';
  (sectionObj.items||[]).forEach((node,idx)=>{ tree.appendChild(renderNode(sectionObj,secIndex,node,[idx])); });

  const addRoot=document.createElement('button'); addRoot.type='button'; addRoot.className='mini-btn';
  const nextRootNo = sectionObj.title_no + '.' + ((sectionObj.items?.length || 0) + 1);
  addRoot.textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ '+nextRootNo;
  addRoot.addEventListener('click',()=>{ if(!sectionObj.items) sectionObj.items=[]; sectionObj.items.push(makeNode()); redrawSections(); });

  tree.appendChild(addRoot);
  return tree;
}

function renderSectionCard(sectionObj,secIndex){
  const card=document.createElement('div'); card.className='chapter-section-card';

  const head=document.createElement('div'); head.className='chapter-head-row';
  const badge=document.createElement('div'); badge.className='badge-no'; badge.textContent=sectionObj.title_no;
  const title=document.createElement('input'); title.type='text'; title.className='chapter-title-input'; title.placeholder='‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏§‡∏©‡∏é‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á'; title.value=sectionObj.title||'';
  title.addEventListener('input',e=>{sectionObj.title=e.target.value; syncSectionsHidden();});
  const del=document.createElement('button'); del.type='button'; del.className='mini-btn danger'; del.style.marginLeft='auto'; del.textContent='‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å';
  del.addEventListener('click',()=>{ if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å '+sectionObj.title_no+' ?')) return; sectionsState.splice(secIndex,1); redrawSections(); });

  head.appendChild(badge); head.appendChild(title); head.appendChild(del);
  card.appendChild(head);

  const overview=document.createElement('div'); overview.className='overview-block';
  const label=document.createElement('div'); label.className='overview-label'; label.textContent='‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°)';
  overview.appendChild(label);
  if(!sectionObj.body_paragraphs) sectionObj.body_paragraphs=[];
  overview.appendChild(renderParagraphs(sectionObj.body_paragraphs, ()=>syncSectionsHidden(), ()=>{redrawSections();}));
  card.appendChild(overview);

  card.appendChild(renderSectionTree(sectionObj,secIndex));
  return card;
}

/* ---------- ‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô sectionsState ---------- */
function renumberSections(chapterNo='2'){
  sectionsState.forEach((sec, i) => { sec.title_no = chapterNo + '.' + (i + 1); });
}

function redrawSections(){
  const cont=qs('sections-container'); cont.innerHTML='';
  if(!sectionsState.length){ cont.className=''; refreshAddSectionButton(); return; }

  renumberSections('2'); /* <-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡∏Ç‡∏Ñ‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö/‡πÅ‡∏ó‡∏£‡∏Å */

  cont.className='chapter2-sections-wrapper';
  sectionsState.forEach((s,i)=>cont.appendChild(renderSectionCard(s,i)));
  syncSectionsHidden();
  refreshAddSectionButton();
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  const pre=getJsonScript('chapter2-data');
  if(pre && Array.isArray(pre) && pre.length){
    const remapPic=p=>({...p, pic_no:normalizePicNo(p.pic_no), captions:Array.isArray(p.captions)?p.captions:[]});
    const remapNode=n=>({ text:n.text||'', paragraphs:Array.isArray(n.paragraphs)?n.paragraphs.slice():[], pictures:Array.isArray(n.pictures)?n.pictures.map(remapPic):[], captions:[], children:Array.isArray(n.children)?n.children.map(remapNode):[] });
    sectionsState = pre.map(sec=>({ title_no:sec.title_no||'', title:sec.title||'', body_paragraphs:Array.isArray(sec.body_paragraphs)?sec.body_paragraphs.slice():[], pictures:Array.isArray(sec.pictures)?sec.pictures.map(remapPic):[], items:Array.isArray(sec.items)?sec.items.map(remapNode):[] }));
  }
  redrawSections();

  const btnAdd=qs('btnAddSection');
  if(btnAdd){ btnAdd.addEventListener('click',()=>{ const no=getNextSectionNumber(); sectionsState.push(makeSection(no,'')); redrawSections(); }); }

  const form=qs('chapter2Form');
  if(form){
    form.addEventListener('submit', ()=>{
      form.querySelectorAll('textarea').forEach(ta=>{
        ta.value = ta.value.replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim();
      });
      syncIntroHidden();
      syncSectionsHidden();
    });
  }
});
</script>
</body>
</html>

{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>บทที่ 1</title>
  <link rel="stylesheet" href="{% static 'css/chapter_1.css' %}">
</head>
<body>
  <div class="container">
    
    <form id="chapter1Form" method="POST" action="{% url 'chapter_1' %}">
      {% csrf_token %}

      <div class="text-center"><h1>บทที่ 1</h1></div>
        {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
      <div class="card">
        <div class="card-header bg-success">บทนำ</div>
        <div class="card-body">
          <label for="intro_body" class="form-label">บทนำ</label>
          <textarea class="form-control" id="intro_body" name="intro_body" rows="6">{{ initial.intro_body|default:'' }}</textarea>
        </div>
      </div>

      <div id="root_sections"></div>

      <input type="hidden" id="chapter1_json" name="chapter1_json" value="" />

      <div class="button-group">
        <button class="btn btn-primary" type="submit" name="action" value="save">บันทึกข้อมูล</button>
        <button class="btn btn-info" type="submit" name="action" value="get_data">ดึงข้อมูล</button>
        <button class="btn btn-success" type="submit" name="action" value="generate_docx">สร้างเอกสาร</button>
      </div>
    </form>
  </div>

  {% if initial.chapter1_json|default:None %}{{ initial.chapter1_json|json_script:"chapter1-data" }}{% endif %}

  <!-- เทมเพลตของหัวข้อใหญ่ -->
  <template id="tmpl-section">
    <div class="card section">
      <div class="card-header legend-flex">
        <span class="number" aria-hidden="true"></span>
        <input type="text" class="title-input" placeholder="ชื่อหัวข้อใหญ่" />
      </div>

      <div class="card-body">
        <!-- ▼ โหมดย่อหน้า: ใช้เฉพาะหัวข้อ 1.1 -->
        <div class="para-mode" hidden>
          <div class="para-wrap"></div>
          <div class="row" style="gap:8px;margin:8px 0 12px;">
            <button type="button" class="btn btn-outline-secondary me-2" data-cmd="add-para">+ เพิ่มย่อหน้า</button>
            <button type="button" class="btn btn-outline-warning" data-cmd="remove-para">ลบย่อหน้า (ล่าสุด)</button>
          </div>
        </div>

        <!-- ▼ โหมดเนื้อหา/หัวข้อย่อย: ใช้กับหัวข้อ 1.2+ (เดิม) -->
        <label class="form-label body-label">เนื้อหา (ย่อหน้า)</label>
        <textarea class="form-control body-input" rows="5" placeholder="พิมพ์เนื้อหาโดยสรุปของหัวข้อนี้..."></textarea>

        <div class="subblock">
          <div class="row" style="gap:8px;margin:8px 0 12px;">
            <button type="button" class="btn btn-outline-secondary me-2" data-cmd="add-main">+ เพิ่มหัวข้อหลัก (1.x.y)</button>
            <button type="button" class="btn btn-outline-warning" data-cmd="remove-main">ลบหัวข้อหลัก (ข้อล่าสุด)</button>
          </div>
          <input type="hidden" class="main-count" value="0">
          <div class="mains-wrap"></div>
        </div>

        <div class="controls row" style="margin-top:8px;">
          <button type="button" class="btn btn-outline-warning" data-cmd="remove-section" hidden>ลบหัวข้อใหญ่</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    const $  = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function getJsonScript(id){
      const el = document.getElementById(id);
      if(!el) return null;
      try { return JSON.parse(el.textContent); } catch(e){ console.error('JSON Script Error:', e); return null; }
    }

    // ====== โครงเริ่มต้น (หัวข้อคงที่) ======
    function defaultSections(){
      return [
        { title: 'ความเป็นมาและความสำคัญของปัญหา', paragraphs: [], mains: [] }, // 1.1 → paragraphs mode
        { title: 'วัตถุประสงค์',           body: '', points: [] },
        { title: 'สมมุติฐาน',                 body: '', points: [] },
        { title: 'ขอบเขตการทำโครงงาน',                  body: '', points: [] },
        { title: 'ข้อตกลงเบื้องต้น',                   body: '', points: [] },
        { title: 'นิยามศัพท์เฉพาะ',                    body: '', points: [] },
        { title: 'ประโยชน์ที่คาดว่าจะได้รับ',          body: '', points: [] },
      ];
    }

    let secAutoId = 0;

    // ====== ย่อหน้า 1 กล่อง (เฉพาะ 1.1) ======
    function createParagraphItem(idx, text=''){
      const box = document.createElement('div');
      box.className = 'para-item';
      const label = document.createElement('label');
      label.className = 'form-label';
      label.textContent = `ย่อหน้าใหญ่ที่ ${idx}`;
      const ta = document.createElement('textarea');
      ta.className = 'para-input';
      ta.rows = 4;
      ta.placeholder = 'พิมพ์ย่อหน้าใหญ่...';
      ta.value = text || '';
      box.appendChild(label);
      box.appendChild(ta);
      return box;
    }

    function createSubItem(sectionEl, mainIdx, subIdx, val=''){
      const subLbl = document.createElement('label');
      subLbl.className = 'form-label sub-label';
      subLbl.textContent = `1.${getRootIndex(sectionEl)}.${mainIdx}.${subIdx}`;

      const subInput = document.createElement('input');
      subInput.type = 'text';
      subInput.className = 'sub-input';
      subInput.id = `sub_${sectionEl.dataset.sid}_${mainIdx}_${subIdx}`;
      subInput.value = val;

      return [subLbl, subInput];
    }

    function createMainBlock(index, mainVal='', subsList=[], sectionEl){
      const wrap = document.createElement('div');
      wrap.className = 'main-block';
      const rootIdx = getRootIndex(sectionEl);

      const lbl = document.createElement('label');
      lbl.className = 'form-label';
      lbl.textContent = `1.${rootIdx}.${index}`;

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'main-input';
      input.id = `main_${sectionEl.dataset.sid}_${index}`;
      input.value = mainVal;

      const controls = document.createElement('div');
      controls.className = 'row';
      const mainNumStr = `1.${rootIdx}.${index}`;
      controls.innerHTML = `
        <button type="button" class="btn btn-outline-secondary me-2" data-subcmd="add" data-main="${index}">+ เพิ่มหัวข้อย่อย (${mainNumStr}.x)</button>
        <button type="button" class="btn btn-outline-warning" data-subcmd="remove" data-main="${index}">ลบหัวข้อย่อย (ข้อล่าสุด)</button>
      `;

      const subCount = document.createElement('input');
      subCount.type = 'hidden';
      subCount.className = 'sub-count';
      subCount.dataset.main = index.toString();
      subCount.value = Array.isArray(subsList) ? subsList.length : 0;

      const subsWrap = document.createElement('div');
      subsWrap.className = 'subs-wrap';
      subsWrap.id = `subs_${sectionEl.dataset.sid}_${index}`;

      (subsList || []).forEach((sv, j) => {
        const subIdx = j + 1;
        const [label, inputSub] = createSubItem(sectionEl, index, subIdx, sv);
        subsWrap.appendChild(label);
        subsWrap.appendChild(inputSub);
      });
      subCount.value = (subsList || []).length;

      wrap.appendChild(lbl);
      wrap.appendChild(input);
      wrap.appendChild(controls);
      wrap.appendChild(subCount);
      wrap.appendChild(subsWrap);
      return wrap;
    }

    // ====== สร้างหัวข้อ (index เริ่มที่ 1) ======
    function createSectionNode(data={title:'', body:'', points:[]}, index=1){
      const node = document.getElementById('tmpl-section').content.firstElementChild.cloneNode(true);
      node.dataset.sid = (++secAutoId).toString();

      $('.title-input', node).value = data.title || '';
      $('.body-input',  node).value = data.body  || '';

      const paraMode = $('.para-mode', node);
      const paraWrap = $('.para-wrap', node);

      // ----- เฉพาะหัวข้อ 1.1: โหมดย่อหน้า -----
      if (index === 1) {
        paraMode.hidden = false;                                // แสดงโหมดย่อหน้า
        $('.body-label', node).hidden = true;                   // ซ่อน body label
        $('.body-input', node).hidden = true;                   // ซ่อน textarea body
        $('.subblock', node).hidden = true;                     // ซ่อนหัวข้อหลัก/ย่อย

        let paras = Array.isArray(data.paragraphs) ? data.paragraphs.slice() : [];
        if (!paras.length && (data.body || '').trim()) {
          paras = (data.body || '').replace(/\r\n/g, '\n').split(/\n\n+/).map(s=>s.trim()).filter(Boolean);
        }
        if (!paras.length) paras = [''];
        paraWrap.innerHTML = '';
        paras.forEach((p,i)=> paraWrap.appendChild(createParagraphItem(i+1, p)));

        node.addEventListener('click', (e)=>{
          const btn = e.target.closest('button');
          if(!btn) return;
          if(btn.dataset.cmd === 'add-para'){
            const count = $$('.para-item', node).length + 1;
            paraWrap.appendChild(createParagraphItem(count, ''));
          } else if (btn.dataset.cmd === 'remove-para'){
            const last = paraWrap.lastElementChild;
            if(last) paraWrap.removeChild(last);
          }
        });

        return node; // ไม่ต้องผูก event อื่นๆ
      }

      // ----- หัวข้ออื่น: ใช้ logic เดิม -----
      const mainsWrap = $('.mains-wrap', node);
      const mainCountInput = $('.main-count', node);

      function renderMainsFromData(list){
        mainsWrap.innerHTML = '';
        let count = 0;
        (list || []).forEach(item => {
          count++;
          mainsWrap.appendChild(createMainBlock(count, item.main || '', item.subs || [], node));
        });
        mainCountInput.value = count;
      }
      renderMainsFromData(data.points || []);

      node.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;

        if(btn.dataset.cmd){
          const cmd = btn.dataset.cmd;
          const parent = node.parentElement;
          if(cmd==='remove-section'){ parent.removeChild(node); renumber(); }
          else if(cmd==='add-main'){
            const cur = (mainCountInput.value|0) + 1;
            mainCountInput.value = cur;
            mainsWrap.appendChild(createMainBlock(cur, '', [], node));
            renumber();
          } else if(cmd==='remove-main'){
            const cur = (mainCountInput.value|0);
            if(cur>0){ mainsWrap.removeChild(mainsWrap.lastElementChild); mainCountInput.value = cur-1; renumber(); }
          }
          return;
        }

        if(btn.dataset.subcmd){
          const subcmd = btn.dataset.subcmd;
          const mainIdx = parseInt(btn.dataset.main,10);
          const subCountInput = $(`.sub-count[data-main="${mainIdx}"]`, node);
          const subsWrap = $(`#subs_${node.dataset.sid}_${mainIdx}`, node);
          let cur = (subCountInput.value|0);
          if(subcmd==='add'){
            cur++; subCountInput.value = cur;
            const [label, input] = createSubItem(node, mainIdx, cur, '');
            subsWrap.appendChild(label);
            subsWrap.appendChild(input);
            renumber();
          }else if(subcmd==='remove' && cur>0){
            subsWrap.removeChild(subsWrap.lastElementChild);
            subsWrap.removeChild(subsWrap.lastElementChild);
            subCountInput.value = cur-1;
            renumber();
          }
        }
      });

      return node;
    }

    function getRootIndex(sectionEl){
      const parent = sectionEl.parentElement;
      if (!parent || parent.id !== 'root_sections') return 1;
      return Array.from(parent.children).indexOf(sectionEl) + 1;
    }

    function deserialize(arr){
      const root = document.getElementById('root_sections');
      root.innerHTML = '';
      (arr || []).forEach((s, idx) => root.appendChild(createSectionNode(s, idx+1)));
      renumber();
    }

    function serialize(){
      function sectionToObj(sectionEl, idx){
        const title = $('.title-input', sectionEl).value.trim();

        if (idx === 1) {
          // หัวข้อ 1.1 → เก็บเป็น paragraphs
          const paras = $$('.para-item .para-input', sectionEl).map(t => t.value.trim()).filter(Boolean);
          return { title, paragraphs: paras, mains: [] };
        }

        const body  = $('.body-input',  sectionEl).value.trim();
        const points = [];
        $$('.main-block', sectionEl).forEach((blk)=>{
          const mainVal = $('input.main-input', blk).value.trim();
          const subs = [];
          $$('.subs-wrap > input.sub-input', blk).forEach(inp => subs.push(inp.value.trim()));
          if(mainVal || subs.some(Boolean)) points.push({ main: mainVal, subs: subs.filter(Boolean) });
        });
        return { title, body, points };
      }
      const list  = $$('#root_sections > .section').map((sec, i) => sectionToObj(sec, i+1));
      return JSON.stringify(list);
    }

    function renumber(){
      $$('#root_sections > .section').forEach((sec, i)=>{
        const rootIndex = i+1;
        $('.number', sec).textContent = '1.' + rootIndex;

        // อัปเดตเลขหัวข้อหลัก/ย่อยเฉพาะหัวข้อ 1.2+
        if (rootIndex === 1) return;

        $$('.main-block', sec).forEach((blk, mi)=>{
          const mainIndex = mi+1;
          const mainNumStr = `1.${rootIndex}.${mainIndex}`;
          const mainLabel = $('label.form-label', blk);
          if (mainLabel && !mainLabel.classList.contains('sub-label')) mainLabel.textContent = mainNumStr;
          const subs = $$('.subs-wrap > .sub-label', blk);
          subs.forEach((slab, sj)=> slab.textContent = `${mainNumStr}.${sj+1}`);
          const addButton = $(`button[data-subcmd="add"]`, blk);
          if (addButton) addButton.textContent = `+ เพิ่มหัวข้อย่อย (${mainNumStr}.x)`;
        });
      });
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const pre = getJsonScript('chapter1-data');
      const data = Array.isArray(pre) && pre.length ? pre : defaultSections();
      deserialize(data);

      document.getElementById('chapter1Form').addEventListener('submit', (e)=>{
        const action = e.submitter && e.submitter.value;
        if(action==='save' || action==='generate_docx'){
          document.getElementById('chapter1_json').value = serialize();
        }
      });
    });
  </script>
</body>
</html>

{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ page_title|default:"‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" }}</title>
  <link rel="stylesheet" href="{% static 'css/chapter_3.css' %}">
</head>

<body>
<div class="page-shell">

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        {% if "chapter3" in message.tags %}
          <li class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}

  <div id="alert-box"></div>

  <form id="chapter3Form" method="POST" action="{% url 'chapter_3' %}" enctype="multipart/form-data">
    {% csrf_token %}

    <section class="section-card-outer">
      <center><h2>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</h2></center>
      <div class="section-title-head">
        <center><div>‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div></center>
      </div>

      <div class="section-card-body">
        <div class="badge-no">‡∏ö‡∏ó‡∏ô‡∏≥</div>
        
        <div id="intro-paras"></div>
        <div id="intro-nodes"></div>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnAddIntroNode" class="main-btn main-btn-neutral" type="button">
            <span class="emoji">‚ûï</span><span>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏≥ 3.1</span>
          </button>
        </div>
      </div>
    </section>

    
<div id="sections-container" class="chapter-sections-wrapper"></div>

    <input type="hidden" id="intro_body" name="intro_body" value="{}">
    <input type="hidden" id="sections_json" name="sections_json" value="[]">
    <input type="hidden" id="tables_json"   name="chapter3_tables_json" value="[]">

    <div class="toolbar-bottom" style="margin-top: 18px;">
      <button id="btnAddSection" class="main-btn main-btn-neutral" type="button">
        <span class="emoji">‚ûï</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (3.x)</span>
      </button>
    </div>

    <div class="footer-action-bar">
      <button class="main-btn main-btn-success" 
              type="submit" name="action" value="save">
        <span class="emoji">üíæ</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>

      <button class="main-btn main-btn-info" 
              type="submit" name="action" value="get_data">
        <span class="emoji">üîÑ</span><span>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>

      <button class="main-btn main-btn-danger" 
              type="submit" name="action" value="generate_doc">
        <span class="emoji">üìÑ</span><span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
      </button>
    </div>
  </form>

  {% if initial.sections %}{{ initial.sections|json_script:"chapter3-sections" }}{% endif %}
  {% if initial.tables %}{{ initial.tables|json_script:"chapter3-tables" }}{% endif %}
  {{ initial.intro_body|default:"{}"|json_script:"intro-body-data" }}

</div> 

<script>
/* ========================= Utilities ========================= */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return "";
}
function getCsrfToken() { return getCookie("csrftoken"); }

const alertBox = (() => {
  const el = () => document.getElementById("alert-box");
  function show(msg, type = "info", timeoutMs = 2200) {
    const box = el();
    if (!box) return;
    box.textContent = msg;
    box.className = "";
    box.classList.add("alert-inline", type, "show");
    if (timeoutMs) {
      setTimeout(() => {
        if (box.textContent === msg) {
          box.textContent = "";
          box.className = "";
        }
      }, timeoutMs);
    }
  }
  return { show };
})();

function getJsonScript(id){
  const el = document.getElementById(id);
  if(!el) return null;
  try { return JSON.parse(el.textContent); } catch(e){ console.error('JSON Script Error:', e); return null; }
}

/* ========================= Intro Management (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ö‡∏ó 2) ========================= */
let introData = { paragraphs: [], subnodes: [] };

function getIntroBodyData() {
    const raw = document.getElementById('intro-body-data');
    if (raw) {
        try {
            const d = JSON.parse(raw.textContent || '{}');
            if (d && (Array.isArray(d.paragraphs) || Array.isArray(d.subnodes))) return d;
        } catch (e) {
            console.error("Error parsing intro data:", e);
        }
    }
    return { paragraphs: [], subnodes: [] };
}

function syncIntroHidden() {
    const h = document.getElementById('intro_body');
    if (h) h.value = JSON.stringify(introData);
}

function refreshIntroButtons() {
    const btn = document.getElementById('btnAddIntroNode');
    if (btn) {
        const next = ' 3.' + ((introData.subnodes?.length || 0) + 1);
        btn.querySelector('span:last-child').textContent = '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏≥' + next; 
    }
}

function renderIntroParas() {
    const mount = document.getElementById('intro-paras');
    mount.innerHTML = '';
    if (!introData.paragraphs || introData.paragraphs.length === 0) {
        mount.className = '';
        refreshIntroButtons();
        return;
    }
    mount.className = 'paras-wrap';
    mount.appendChild(
        renderParagraphs(
            introData.paragraphs, 
            () => syncIntroHidden(), 
            () => { renderIntroParas(); }
        )
    );
    refreshIntroButtons();
    syncIntroHidden();
}

function renderIntroNodes() {
    const wrap = document.getElementById('intro-nodes');
    wrap.innerHTML = '';
    if (!introData.subnodes || introData.subnodes.length === 0) {
        wrap.className = '';
        refreshIntroButtons();
        return;
    }
    wrap.className = 'chapter-sections-wrapper';

    introData.subnodes.forEach((n, idx) => {
        const card = document.createElement('div');
        card.className = 'chapter-section-card';
        card.style.padding = '12px';

        const head = document.createElement('div');
        head.className = 'chapter-head-row';
        const badge = document.createElement('div');
        badge.className = 'badge-no';
        badge.textContent = '3.' + (idx + 1);
        const title = document.createElement('input');
        title.type = 'text';
        title.className = 'chapter-title-input';
        title.placeholder = '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ô‡∏≥';
        title.value = n.title || '';
        title.addEventListener('input', e => {
            n.title = e.target.value;
            syncIntroHidden();
        });
        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'mini-btn danger';
        del.textContent = '‡∏•‡∏ö'; 
        del.addEventListener('click', () => {
            introData.subnodes.splice(idx, 1);
            renderIntroNodes();
            syncIntroHidden();
        });
        head.appendChild(badge);
        head.appendChild(title);
        head.appendChild(del);
        card.appendChild(head);

        if (!n.paragraphs) n.paragraphs = [];
        const paraWrap = document.createElement('div');
        paraWrap.className = "overview-block";
        paraWrap.style.marginTop = '10px';
        paraWrap.appendChild(
            renderParagraphs(
                n.paragraphs, 
                () => syncIntroHidden(), 
                () => { renderIntroNodes(); syncIntroHidden(); }
            )
        );
        card.appendChild(paraWrap);

        wrap.appendChild(card);
    });

    refreshIntroButtons();
    syncIntroHidden();
}


/* ========================= Data Model ========================= */
function makeNode() {
  return { text: "", paragraphs: [], pictures: [], tables: [], children: [] };
}
function makeSection(title_no, title) {
  return { title_no, title, body_paragraphs: [], pictures: [], items: [ makeNode() ] };
}
let sectionsState = [ makeSection("3.1", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å") ];

// ===== Intro JSON model (‡πÉ‡∏´‡∏°‡πà) =====
function makeIntroNode() {
  return { title_no: "", title: "", paragraphs: [], children: [] };
}
// [!] introState ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö pictures ‡πÅ‡∏•‡πâ‡∏ß
let introState = { paragraphs: [], items: [], pictures: [] };// root paragraphs + list of intro nodes

// ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πà‡∏≠ node
const pendingFiles = {}; // {"secIndex|path.path": File}

/* === syncHiddenField: (‡πÄ‡∏û‡∏¥‡πà‡∏° intro_body JSON) === */
function syncHiddenField() {
  const allTables = [];
  function walkNode(node, nodeNo){
    (node.tables || []).forEach(tb => {
      allTables.push({
        table_no: tb.table_no || "", 
        caption: tb.caption || "",
        headers: Array.isArray(tb.headers) ? tb.headers : [],
        rows: Array.isArray(tb.rows) ? tb.rows : [],
        row_types: Array.isArray(tb.row_types) ? tb.row_types : [],
        table_type: tb.table_type || "default",
        notes: Array.isArray(tb.notes) ? tb.notes : [],
        anchor_no: nodeNo,
      });
    });
    (node.children || []).forEach((ch, i) => walkNode(ch, `${nodeNo}.${i+1}`));
  }
  (sectionsState || []).forEach(sec => {
    (sec.items || []).forEach((node, i) => walkNode(node, `${sec.title_no}.${i+1}`));
  });

  document.getElementById("sections_json").value = JSON.stringify(sectionsState);
  document.getElementById("tables_json").value   = JSON.stringify(allTables);
  
  // [!] EDIT 2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç syncHiddenField
  const introEl = document.getElementById("intro_body");
  if (introEl) {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö intro_body ‡πÇ‡∏î‡∏¢ "‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°" key pictures
    const introDataToSave = {
      paragraphs: introState.paragraphs || [],
      items: introState.items || []
      // ‡πÄ‡∏£‡∏≤‡∏à‡∏á‡πÉ‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà key 'pictures' ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    };
    introEl.value = JSON.stringify(introDataToSave);
  }
}
function fileKey(secIndex, pathArr) {
  if (!pathArr || pathArr.length === 0) return secIndex + "|";
  return secIndex + "|" + pathArr.join(".");
}

/* ========================= Helpers ========================= */
function getNodeByPath(sectionObj, pathArr) {
  if (pathArr.length === 0) return null;
  let cur = sectionObj.items[pathArr[0]];
  for (let i = 1; i < pathArr.length; i++) cur = cur.children[pathArr[i]];
  return cur;
}
function getParentAndIndex(sectionObj, pathArr) {
  if (!pathArr.length) return null;
  if (pathArr.length === 1) return { listRef: sectionObj.items, idx: pathArr[0] };
  let parent = sectionObj.items[pathArr[0]];
  for (let i=1;i<pathArr.length-1;i++) parent = parent.children[pathArr[i]];
  return { listRef: parent.children, idx: pathArr[pathArr.length-1] };
}
function buildNodeNumber(sectionNo, pathArr) {
  if (!pathArr || pathArr.length === 0) return sectionNo;
  const suffix = pathArr.map(i => (i+1)).join(".");
  return sectionNo + "." + suffix;
}
// üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà
function refreshAddSectionButton() {
  const btn = document.getElementById('btnAddSection');
  if (btn) {
    const nextNo = getNextSectionNumber();
    btn.querySelector('span:last-child').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (' + nextNo + ')';
  }
}

function getNextSectionNumber() {
  if (sectionsState.length === 0) return "3.1";
  const last = sectionsState[sectionsState.length - 1].title_no || "3.1";
  const parts = last.split(".");
  if (parts.length === 2) {
    const chap = parts[0];
    const idx  = parseInt(parts[1], 10) || 1;
    return chap + "." + (sectionsState.length + 1);
  }
  return "3." + (sectionsState.length + 1);
}

/* ===== Picture numbering (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
function parseSeqFromPicNo(pic_no) {
  if (!pic_no || typeof pic_no !== "string") return 0;
  const m = String(pic_no).match(/^(\d+)-(\d+)$/);
  return m ? parseInt(m[2], 10) : 0;
}
function normalizePicNo(anyPicNo) {
  if (!anyPicNo) return anyPicNo;
  const m = String(anyPicNo).match(/^(\d+)(?:\.\d+)*-(\d+)$/);
  return m ? `${m[1]}-${m[2]}` : anyPicNo;
}
function collectChapterPicSeqs(chapterNo) {
  const seqs = new Set();
  function scan(arr) {
    (arr || []).forEach(p => {
      const pn = normalizePicNo(p && p.pic_no);
      if (pn && String(pn).startsWith(chapterNo + "-")) {
        const n = parseSeqFromPicNo(pn);
        if (n > 0) seqs.add(n);
      }
    });
  }
  function walk(node) {
    if (!node) return;
    scan(node.pictures);
    (node.children || []).forEach(walk);
  }
  // [!] scan(introState.pictures); <-- ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á scan ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
  (sectionsState || []).forEach(sec => {
    scan(sec.pictures); // <-- ‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á intro ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô sectionsState[0].pictures
    (sec.items || []).forEach(walk);
  });
  return seqs;
}
function computeFirstFreePicNoForChapter(chapterNo) {
  const seqs = collectChapterPicSeqs(chapterNo);
  let i = 1; while (seqs.has(i)) i += 1;
  return `${chapterNo}-${i}`;
}

/* ===== Table numbering (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== */
function parseSeqFromTableNo(table_no) {
  if (!table_no || typeof table_no !== "string") return 0;
  const m = String(table_no).match(/^(\d+)-(\d+)$/);
  return m ? parseInt(m[2], 10) : 0;
}
function normalizeTableNo(anyTableNo) {
  if (!anyTableNo) return anyTableNo;
  const m = String(anyTableNo).match(/^(\d+)(?:\.\d+)*-(\d+)$/);
  return m ? `${m[1]}-${m[2]}` : anyTableNo;
}
function collectChapterTableSeqs(chapterNo) {
  const seqs = new Set();
  function scanTables(arr) {
    (arr || []).forEach(t => {
      const tn = normalizeTableNo(t && t.table_no);
      if (tn && String(tn).startsWith(chapterNo + "-")) {
        const n = parseSeqFromTableNo(tn);
        if (n > 0) seqs.add(n);
      }
    });
  }
  function walk(node) {
    if (!node) return;
    scanTables(node.tables); 
    (node.children || []).forEach(walk);
  }
  (sectionsState || []).forEach(sec => {
    (sec.items || []).forEach(walk); 
  });
  return seqs;
}
function computeFirstFreeTableNoForChapter(chapterNo) {
  const seqs = collectChapterTableSeqs(chapterNo);
  let i = 1; while (seqs.has(i)) i += 1;
  return `${chapterNo}-${i}`;
}

/* ========================= Paragraph Editor (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà/‡πÄ‡∏•‡πá‡∏Å) ========================= */
// **‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô Intro ‡πÅ‡∏•‡∏∞ Body/Node
function renderParagraphs(arr, onChangeContent, onAddOrRemove, isBody = false) {
  const wrap = document.createElement("div");
  wrap.className = "paras-wrap";
  
  if(arr.length > 0) {
      arr.forEach((txt, idx) => {
        const row = document.createElement("div");
        row.className = "para-row";
        const ta = document.createElement("textarea");
        ta.classList.add("clean-textarea");
        ta.value = txt || "";
        ta.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ . . .";
        ta.addEventListener("input", (e) => {
          arr[idx] = e.target.value;
          if (onChangeContent) onChangeContent();
        });
        const del = document.createElement("button");
        del.type = "button";
        del.className = "mini-btn danger";
        del.textContent = "‡∏•‡∏ö‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
        del.addEventListener("click", () => {
          arr.splice(idx,1);
          if (onAddOrRemove) onAddOrRemove();
        });
        row.appendChild(ta);
        row.appendChild(del);
        wrap.appendChild(row);
      });
      // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô controls/node-top-row
      // ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤' ‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  }

  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "mini-btn";
  addBtn.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  addBtn.style.padding = '10px 14px'; // üí° ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô
  addBtn.style.width = '10%';
  addBtn.style.textAlign = 'center';
  addBtn.style.marginTop = '10px';

  addBtn.addEventListener("click", () => {
    arr.push("");
    if (onAddOrRemove) onAddOrRemove();
  });

  wrap.appendChild(addBtn);

  return wrap;
}

function renderParagraphsLastOnly(arr, onChangeContent, onReRender) {
  const wrap = document.createElement("div");
  wrap.className = "paras-wrap";

  // ‡πÅ‡∏™‡∏î‡∏á textarea ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏Ç‡πâ‡∏≤‡∏á‡πÜ)
  arr.forEach((txt, idx) => {
    const row = document.createElement("div");
    row.className = "para-row";
    const ta = document.createElement("textarea");
    ta.classList.add("clean-textarea");
    ta.value = txt || "";
    ta.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ . . .";
    ta.addEventListener("input", (e) => {
      arr[idx] = e.target.value;
      if (onChangeContent) onChangeContent();
    });
    row.appendChild(ta);
    wrap.appendChild(row);
  });

  // ‡πÅ‡∏ñ‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
  const bar = document.createElement("div");
  bar.className = "para-bar-bottom";

  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "mini-btn";
  addBtn.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  addBtn.addEventListener("click", () => {
    arr.push("");
    if (onReRender) onReRender();   // ‡πÉ‡∏´‡πâ re-render ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á textarea ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
  });

  const delLastBtn = document.createElement("button");
  delLastBtn.type = "button";
  delLastBtn.className = "mini-btn danger";
  delLastBtn.textContent = "‡∏•‡∏ö‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏Ç‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)";
  delLastBtn.disabled = arr.length === 0;
  delLastBtn.addEventListener("click", () => {
    if (arr.length === 0) return;
    // ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
    arr.pop();
    if (onReRender) onReRender();
  });

  bar.appendChild(addBtn);
  bar.appendChild(delLastBtn);
  wrap.appendChild(bar);
  return wrap;
}

/* ========================= AJAX Helper (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ========================= */
function postAction(action, extra = {}, fileToUpload = null) {
  const url = window.location.href;
  const fd  = new FormData();
  fd.append("action", action);
  Object.entries(extra).forEach(([k,v]) => fd.append(k, v));
  if (fileToUpload) fd.append("pic_file", fileToUpload);

  return fetch(url, {
    method: "POST",
    headers: { "X-CSRFToken": getCsrfToken() },
    body: fd
  }).then(async (res) => {
    const ct = res.headers.get("Content-Type") || "";
    if (!res.ok) throw new Error(await res.text());
    if (ct.includes("application/json")) return res.json();
    return res.text();
  });
}

/* ========================= Picture box (per node) (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ========================= */
function renderIntroPicturesBox() {
  const picsBox = document.createElement("div");
  picsBox.className = "pics-box";

  // [!] EDIT 1: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (targetNode)
  // const targetNode = introState; // <-- OLD
  
  // NEW: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ sectionsState[0] (Section 3.1) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
  if (!sectionsState || sectionsState.length === 0) {
      sectionsState = [ makeSection("3.1", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å") ];
      console.warn("sectionsState was empty, created default 3.1 for intro pictures.");
  }
  // NEW: ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠ section ‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î (3.1)
  const targetNode = sectionsState[0]; 

  if (!Array.isArray(targetNode.pictures)) targetNode.pictures = [];

  const chapterNo = "3";                      // ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3
  const nodeNo    = "3.INTRO";                // ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô anchor ‡πÉ‡∏´‡πâ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
  const keyForThisNode = "intro|root";        // ‡πÉ‡∏ä‡πâ key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö pendingFiles

  const head = document.createElement("div");
  head.className = "pics-head";
  head.textContent = `‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ô‡∏≥`;
  picsBox.appendChild(head);

  const addRow = document.createElement("div");
  addRow.className = "pics-add-row";

  const captionInput = document.createElement("input");
  captionInput.type = "text";
  captionInput.className = "pic-caption-input";
  captionInput.placeholder = "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ ‚Ä¶";

  const pendingLabel = document.createElement("div");
  pendingLabel.className = "pending-label";

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.className = "hidden-file";

  const pickBtn = document.createElement("button");
  pickBtn.type = "button";
  pickBtn.className = "mini-btn";
  pickBtn.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‚Ä¶";

  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "mini-btn primary";
  addBtn.textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ";

  pickBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", () => {
    if (fileInput.files && fileInput.files.length > 0) {
      pendingFiles[keyForThisNode] = fileInput.files[0];
      pendingLabel.textContent = "‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + fileInput.files[0].name;
    }
  });

  addBtn.addEventListener("click", async () => {
    const picName = (captionInput.value || "").trim();
    const f = pendingFiles[keyForThisNode];
    if (!picName) { alertBox.show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "warning"); return; }
    if (!f)       { alertBox.show("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ", "warning"); return; }

    alertBox.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...", "info", 0);
    try {
      const nextPicNo = computeFirstFreePicNoForChapter(chapterNo); 
      const data = await postAction(
        "add_picture",
        { node_no: nodeNo, pic_name: picName, pic_path: f.name, pic_no: nextPicNo },
        f
      );

      const pushed = (data && data.picture) ? { ...data.picture } : { pic_name: picName, pic_path: f.name };
      pushed.pic_no = nextPicNo;

      targetNode.pictures.push(pushed); // [!] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á sectionsState[0].pictures
      captionInput.value = "";
      pendingLabel.textContent = "";
      delete pendingFiles[keyForThisNode];

      renderIntroPicturesList();   // refresh ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      alertBox.show((data && data.message) || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      syncHiddenField();           // >>> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï hidden input ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    } catch (err) {
      console.error(err);
      alertBox.show("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (" + err.message + ")", "error", 5000);
    }
  });

  addRow.appendChild(captionInput);
  addRow.appendChild(pickBtn);
  addRow.appendChild(addBtn);
  addRow.appendChild(pendingLabel);
  addRow.appendChild(fileInput);
  picsBox.appendChild(addRow);

  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏≥
  const list = document.createElement("div");
  list.className = "pic-list";

  function renderIntroPicturesList() {
    list.innerHTML = "";
    const arr = targetNode.pictures || []; // [!] ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å sectionsState[0].pictures
    if (arr.length === 0) {
      const empty = document.createElement("div");
      empty.className = "pic-item empty";
      empty.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏≥";
      list.appendChild(empty);
      return;
    }
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏û (3-1, 3-2, ...)
    arr.sort((a, b) => {
      const an = parseSeqFromPicNo(normalizePicNo(a.pic_no));
      const bn = parseSeqFromPicNo(normalizePicNo(b.pic_no));
      return an - bn;
    });
    arr.forEach((p, idx) => {
      const shownNo = normalizePicNo(p.pic_no);
      const item = document.createElement("div");
      item.className = "pic-item";
      item.innerHTML = `
        <div class="pic-main">
          <strong>‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${shownNo || "-"}</strong> : ${p.pic_name || ""}
          ${p.pic_path ? `<div class="pic-path">${p.pic_path}</div>` : ""}
        </div>
        <div class="pic-actions">
          <button type="button" class="mini-btn danger" data-act="del-pic" data-idx="${idx}">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
        </div>
      `;
      list.appendChild(item);
    });

    list.querySelectorAll('[data-act="del-pic"]').forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const i = parseInt(e.currentTarget.dataset.idx,10);
        targetNode.pictures.splice(i,1); // [!] ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å sectionsState[0].pictures
        renderIntroPicturesList();
        syncHiddenField();
      });
    });
  }

  // ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô addBtn ‡∏î‡πâ‡∏ß‡∏¢
  window.renderIntroPicturesList = renderIntroPicturesList;

  renderIntroPicturesList();
  picsBox.appendChild(list);

  return picsBox;
}

// === ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏°‡πà ===
function isDefaultHeader(text, idx1based) {
  return new RegExp(`^\\s*‡∏´‡∏±‡∏ß\\s*${idx1based}\\s*$`).test(String(text || ''));
}
function renumberDefaultHeaders(table) {
  const n = table.headers.length;
  for (let i = 0; i < n; i++) {
    if (!table.headers[i] || isDefaultHeader(table.headers[i], i + 1)) {
      table.headers[i] = `‡∏´‡∏±‡∏ß ${i + 1}`;
    }
  }
}
function insertColumnAt(table, atIndex) {
  const idx = Math.max(0, Math.min(atIndex, table.headers.length));
  // 1) headers
  table.headers.splice(idx, 0, `‡∏´‡∏±‡∏ß ${idx + 1}`);
  // 2) rows
  table.rows.forEach(r => r.splice(idx, 0, ''));
  // 3) ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç default ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô default/‡∏ß‡πà‡∏≤‡∏á)
  renumberDefaultHeaders(table);
}
function deleteColumnAt(table, atIndex) {
  if (table.headers.length <= 1) return;
  const idx = Math.max(0, Math.min(atIndex, table.headers.length - 1));
  table.headers.splice(idx, 1);
  table.rows.forEach(r => r.splice(idx, 1));
  renumberDefaultHeaders(table);
}


/* ========================= Table builder & editor ========================= */
function createEmptyTable(tableNo, caption, rows, cols, type="default"){
  const presets = {
    default: (c)=> Array.from({length:c}, (_,i)=> `‡∏´‡∏±‡∏ß ${i+1}`),
    checklist: ()=> ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "‡∏ú‡πà‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"],
    evaluation: ()=> ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", "‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û"],
    accuracy: ()=> ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö", "‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç", "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (%)"]
  };
  const headers = (presets[type] || presets.default)(cols);
  const dataRows = Array.from({length: rows}).map(()=> Array.from({length: headers.length}).map(()=> ""));
  const rowTypes = Array.from({length: rows}).fill("normal");
  return { table_no:tableNo, caption:caption||"", headers, rows:dataRows, row_types:rowTypes, notes:[], table_type:type };
}

// === ‡∏Å‡∏•‡πà‡∏≠‡∏á "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ..." ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡∏°‡∏µ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡πÅ‡∏ñ‡∏ß/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ===
function renderTableBuilder(sectionObj, pathArr, nodeObj) {
  const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
  const box = document.createElement("div");
  box.className = "table-builder";

  box.innerHTML = `
    <div class="tb-head">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${nodeNo}</div>
    <div class="tb-form">
      <div class="tb-row tb-grid">
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</label>
          <input type="number" min="1" value="2" class="tb-input" data-field="rows">
        </div>
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</label>
          <input type="number" min="1" value="3" class="tb-input" data-field="cols">
        </div>
      </div>
      <div class="tb-actions">
        <button type="button" class="mini-btn primary" data-act="create">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
      </div>
    </div>
  `;

  box.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act=create]");
    if (!btn) return;

    const chapterNo   = String(sectionObj.title_no).split(".")[0] || "3";
    const nextTableNo = computeFirstFreeTableNoForChapter(chapterNo);

    let rows = parseInt(box.querySelector('[data-field="rows"]').value || "2", 10);
    let cols = parseInt(box.querySelector('[data-field="cols"]').value || "3", 10);
    rows = Math.max(1, rows);
    cols = Math.max(1, cols);

    if (!Array.isArray(nodeObj.tables)) nodeObj.tables = [];

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢:
    // - caption ‡∏ß‡πà‡∏≤‡∏á (‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
    // - type "default" ‡πÄ‡∏™‡∏°‡∏≠
    nodeObj.tables.push(createEmptyTable(nextTableNo, "", rows, cols, "default"));

    redrawSections();
    alertBox.show(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${nextTableNo} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "success");
    syncHiddenField();
  });

  return box;
}


function renderSingleNodeTable(t, nodeObj, reRenderFn) {
  const wrap = document.createElement("div");
  wrap.className = "table-card";
  let sel = { r: 0, c: 0 };

  const head = document.createElement("div");
  head.className = "table-head";
  head.innerHTML = `
    <div class="table-title">
      <span class="badge-no">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${t.table_no || '?-?'}</span>
      <input type="text" class="table-caption-input" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á" value="${t.caption || ''}">
      <select class="table-type">
        <option value="default" ${t.table_type==='default'?'selected':''}>‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
        <option value="checklist" ${t.table_type==='checklist'?'selected':''}>‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option>
        <option value="evaluation" ${t.table_type==='evaluation'?'selected':''}>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</option>
        <option value="accuracy" ${t.table_type==='accuracy'?'selected':''}>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (%)</option>
      </select>
    </div>
    <div class="table-actions">
      <button type="button" class="mini-btn" data-act="ins-row-above">‚Üë ‡πÅ‡∏ó‡∏£‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô</button>
      <button type="button" class="mini-btn" data-act="ins-row-below">‚Üì ‡πÅ‡∏ó‡∏£‡∏Å‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á</button>
      <button type="button" class="mini-btn" data-act="ins-col-left">‚Üê ‡πÅ‡∏ó‡∏£‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢</button>
      <button type="button" class="mini-btn" data-act="ins-col-right">‚Üí ‡πÅ‡∏ó‡∏£‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤</button>
      <button type="button" class="mini-btn" data-act="add-section-row">+ ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡πà‡∏ß‡∏ô</button>
      <button type="button" class="mini-btn" data-act="del-row">- ‡πÅ‡∏ñ‡∏ß</button>
      <button type="button" class="mini-btn" data-act="del-col">- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
      <button type="button" class="mini-btn danger" data-act="del-table">‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
    </div>
  `;
  wrap.appendChild(head);

  const tbl = document.createElement("table");
  tbl.className = "ui-table";
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");

  t.headers = Array.isArray(t.headers) ? t.headers : [];
  t.rows    = Array.isArray(t.rows) ? t.rows : [];
  t.row_types = Array.isArray(t.row_types) ? t.row_types : t.rows.map(()=> "normal");

  t.headers.forEach((h, cidx) => {
    const th = document.createElement("th");
    const inp = document.createElement("input");
    inp.type = "text"; inp.value = h || "";
    inp.addEventListener("input", (e) => { t.headers[cidx] = e.target.value; syncHiddenField(); });
    inp.addEventListener("focus", () => { sel.c = cidx; sel.r = 0; });
    th.appendChild(inp); trh.appendChild(th);
  });
  thead.appendChild(trh); tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  (t.rows || []).forEach((row, r) => {
    const tr = document.createElement("tr");
    const isSection = t.row_types[r] === "section";

    if (isSection) {
      const td = document.createElement("td");
      td.colSpan = t.headers.length;
      td.className = "section-row";
      const inp = document.createElement("input");
      inp.type = "text"; inp.value = (row && row[0]) || "";
      inp.placeholder = "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡πà‡∏ß‡∏ô / ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤";
      inp.addEventListener("input", (e) => { t.rows[r] = [e.target.value]; syncHiddenField(); });
      inp.addEventListener("focus", () => { sel.r = r; sel.c = 0; });
      td.appendChild(inp); tr.appendChild(td);
    } else {
      const ensureCols = t.headers.length;
      if (!Array.isArray(row)) row = [];
      while(row.length < ensureCols) row.push("");
      while(row.length > ensureCols) row.pop();
      row.forEach((cell, c) => {
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.type = "text"; inp.value = cell || "";
        inp.addEventListener("input", (e) => { t.rows[r][c] = e.target.value; syncHiddenField(); });
        inp.addEventListener("focus", () => { sel.r = r; sel.c = c; });
        td.appendChild(inp); tr.appendChild(td);
      });
    }
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  wrap.appendChild(tbl);

  if (!Array.isArray(t.notes)) {
    t.notes = (t.note && typeof t.note === 'string') ? [t.note] : [];
    delete t.note; 
  }
  const notesWrap = document.createElement("div");
  notesWrap.className = "table-notes-wrap"; 
  const noteLabel = document.createElement("div");
  noteLabel.className = "note-label";
  noteLabel.textContent = "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á";
  notesWrap.appendChild(noteLabel);
  notesWrap.appendChild(
    renderParagraphs(
      t.notes, 
      () => { syncHiddenField(); }, 
      () => { reRenderFn(); }       
    )
  );
  wrap.appendChild(notesWrap);

  const capInp = head.querySelector(".table-caption-input");
  capInp.addEventListener("input", (e)=> { t.caption = e.target.value; syncHiddenField(); });

  const typeSel = head.querySelector(".table-type");
  typeSel.addEventListener("change", (e) => {
    const newType = e.target.value;
    t.table_type = newType;
    const tmp = createEmptyTable(t.table_no || "3-x", t.caption || "", 1, t.headers.length || 3, newType);
    t.headers = tmp.headers.slice();
    const needCols = t.headers.length;
    (t.rows || []).forEach((row, r) => {
      if (t.row_types[r] === "section") return;
      if (!Array.isArray(row)) t.rows[r] = [];
      while (t.rows[r].length < needCols) t.rows[r].push("");
      while (t.rows[r].length > needCols) t.rows[r].pop();
    });
    reRenderFn(); syncHiddenField();
  });

  function insertRowAt(index, isSection=false){
    const cols = t.headers.length;
    if (isSection){
      t.rows.splice(index, 0, ["‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡πà‡∏ß‡∏ô"]);
      t.row_types.splice(index, 0, "section");
    } else {
      t.rows.splice(index, 0, Array.from({length:cols}).map(()=> ""));
      t.row_types.splice(index, 0, "normal");
    }
  }
  function insertColAt(index){
    t.headers.splice(index, 0, "");
    (t.rows||[]).forEach((row, r)=>{
      if (t.row_types[r] === "section") return;
      row.splice(index, 0, "");
    });
  }

  head.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act]"); if (!btn) return;
    const act = btn.dataset.act;

    if (act === "del-table") {
      const i = nodeObj.tables.indexOf(t);
      if (i >= 0 && confirm("‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ?")) {
        nodeObj.tables.splice(i,1);
        reRenderFn(); syncHiddenField();
      }
      return;
    }

    if (act === "ins-row-above") { insertRowAt(Math.max(sel.r,0), false); reRenderFn(); syncHiddenField(); return; }
    if (act === "ins-row-below") { insertRowAt(Math.max(sel.r+1,0), false); reRenderFn(); syncHiddenField(); return; }
    if (act === "ins-col-left")  { insertColAt(Math.max(sel.c,0)); reRenderFn(); syncHiddenField(); return; }
    if (act === "ins-col-right") { insertColAt(Math.max(sel.c+1,0)); reRenderFn(); syncHiddenField(); return; }

    if (act === "add-section-row") { insertRowAt(Math.max(sel.r+1, 0), true); reRenderFn(); syncHiddenField(); return; }
    if (act === "del-row") {
      if (t.rows.length > 0) {
        const idx = Math.min(sel.r, t.rows.length-1);
        if (idx >= 0) { t.rows.splice(idx,1); t.row_types.splice(idx,1); }
      }
      reRenderFn(); syncHiddenField(); return;
    }
    if (act === "del-col") {
      if (t.headers.length > 0) {
        const idx = Math.min(sel.c, t.headers.length-1);
        if (idx >= 0) {
          t.headers.splice(idx,1);
          (t.rows||[]).forEach((row, r) => {
            if (t.row_types[r] === "section") return;
            if(row[idx] !== undefined) row.splice(idx,1);
          });
        }
      }
      reRenderFn(); syncHiddenField(); return;
    }
  });

  return wrap;
}

// ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö state ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: tableObj = {table_no, caption, headers, rows, ...}
function renderTableCard(tableObj, chapterNo) {
  const wrap = document.createElement('div');
  wrap.className = 'table-card';

  // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
  wrap.innerHTML = `
    <div class="tb-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${tableObj.table_no}</div>
    <div class="tb-caption">
      <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</label>
      <input type="text" class="form-control" data-role="caption" value="${(tableObj.caption||'').replace(/"/g,'&quot;')}">
    </div>
    <div class="tb-editor"></div>
  `;

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML editable (‡∏´‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô input)
  const editor = wrap.querySelector('.tb-editor');
  const tbl = document.createElement('table');
  tbl.className = 'table-editor';
  editor.appendChild(tbl);

  function drawTable() {
    tbl.innerHTML = '';

    // header row
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    tableObj.headers.forEach((h, i) => {
      const th = document.createElement('th');
      th.innerHTML = `
        <div class="th-wrap">
          <input type="text" class="th-input" data-col="${i}" value="${(h||'').replace(/"/g,'&quot;')}">
          <div class="th-tools">
            <button type="button" class="mini-btn" data-act="ins-right" data-col="${i}">+ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤</button>
            <button type="button" class="mini-btn danger" data-act="del-col" data-col="${i}">‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
          </div>
        </div>`;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    tbl.appendChild(thead);

    // body rows
    const tbody = document.createElement('tbody');
    tableObj.rows.forEach((r, ri) => {
      const tr = document.createElement('tr');
      tableObj.headers.forEach((_, ci) => {
        const td = document.createElement('td');
        td.innerHTML = `<input type="text" class="td-input" data-ri="${ri}" data-ci="${ci}" value="${(r[ci]||'').replace(/"/g,'&quot;')}">`;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
  }
  drawTable();

  // events: caption, header edit, insert/del column, cell edit
  wrap.addEventListener('input', (e)=>{
    const cap = e.target.closest('[data-role=caption]');
    const thInp = e.target.closest('.th-input');
    const tdInp = e.target.closest('.td-input');
    if (cap) {
      tableObj.caption = cap.value;
      syncHiddenField();  // ‚Üê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á hidden JSON (tb_sections_json) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ DB
      return;
    }
    if (thInp) {
      const col = parseInt(thInp.dataset.col, 10);
      tableObj.headers[col] = thInp.value;
      syncHiddenField();
      return;
    }
    if (tdInp) {
      const ri = parseInt(tdInp.dataset.ri, 10);
      const ci = parseInt(tdInp.dataset.ci, 10);
      tableObj.rows[ri][ci] = tdInp.value;
      syncHiddenField();
      return;
    }
  });

  wrap.addEventListener('click', (e)=>{
    const btnIns = e.target.closest('[data-act=ins-right]');
    const btnDel = e.target.closest('[data-act=del-col]');
    if (btnIns) {
      const ci = parseInt(btnIns.dataset.col, 10);
      insertColumnAt(tableObj, ci + 1);
      drawTable();
      syncHiddenField();
      return;
    }
    if (btnDel) {
      const ci = parseInt(btnDel.dataset.col, 10);
      deleteColumnAt(tableObj, ci);
      drawTable();
      syncHiddenField();
      return;
    }
  });

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß default ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  renumberDefaultHeaders(tableObj);

  return wrap;
}

function renderPicturesBox(sectionObj, secIndex, pathArr) {
  const picsBox = document.createElement("div");
  picsBox.className = "pics-box";

  const targetNode = getNodeByPath(sectionObj, pathArr);
  if (!targetNode.pictures) targetNode.pictures = [];

  const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
  const keyForThisNode = fileKey(secIndex, pathArr);

  const head = document.createElement("div");
  head.className = "pics-head";
  head.textContent = `‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${nodeNo}`;
  picsBox.appendChild(head);

  const addRow = document.createElement("div");
  addRow.className = "pics-add-row";

  const captionInput = document.createElement("input");
  captionInput.type = "text";
  captionInput.className = "pic-caption-input";
  captionInput.placeholder = "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ ‚Ä¶";

  const pendingLabel = document.createElement("div");
  pendingLabel.className = "pending-label";

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.className = "hidden-file";

  const pickBtn = document.createElement("button");
  pickBtn.type = "button";
  pickBtn.className = "mini-btn";
  pickBtn.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‚Ä¶";

  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "mini-btn primary";
  addBtn.textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ";

  pickBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", () => {
    if (fileInput.files && fileInput.files.length > 0) {
      pendingFiles[keyForThisNode] = fileInput.files[0];
      pendingLabel.textContent = "‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: " + fileInput.files[0].name;
    }
  });

  addBtn.addEventListener("click", async () => {
    const picName = (captionInput.value || "").trim();
    const f = pendingFiles[keyForThisNode];
    if (!picName) { alertBox.show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "warning"); return; }
    if (!f)       { alertBoxBox.show("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ", "warning"); return; }
    alertBox.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...", "info", 0);
    try {
      const chapterNo = String(sectionObj.title_no).split(".")[0] || "3";
      const nextPicNo = computeFirstFreePicNoForChapter(chapterNo);

      const data = await postAction(
        "add_picture",
        { node_no: nodeNo, pic_name: picName, pic_path: f.name, pic_no: nextPicNo },
        f
      );

      const pushed = (data && data.picture) ? { ...data.picture } : { pic_name: picName, pic_path: f.name };
      pushed.pic_no = nextPicNo;

      targetNode.pictures.push(pushed);
      captionInput.value = "";
      pendingLabel.textContent = "";
      delete pendingFiles[keyForThisNode];

      renderPicturesList();        // refresh
      alertBox.show((data && data.message) || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
      syncHiddenField();
    } catch (err) {
      console.error(err);
      alertBox.show("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (" + err.message + ")", "error", 5000);
    }
  });

  addRow.appendChild(captionInput);
  addRow.appendChild(pickBtn);
  addRow.appendChild(addBtn);
  addRow.appendChild(pendingLabel);
  addRow.appendChild(fileInput);
  picsBox.appendChild(addRow);

  const list = document.createElement("div");
  list.className = "pic-list";

  function renderPicturesList() {
    list.innerHTML = "";
    const arr = targetNode.pictures || [];
    if (arr.length === 0) {
      const empty = document.createElement("div");
      empty.className = "pic-item empty";
      empty.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ";
      list.appendChild(empty);
      return;
    }
    arr.sort((a, b) => {
      const an = parseSeqFromPicNo(normalizePicNo(a.pic_no));
      const bn = parseSeqFromPicNo(normalizePicNo(b.pic_no));
      return an - bn;
    });
    arr.forEach((p, idx) => {
      const shownNo = normalizePicNo(p.pic_no);
      const item = document.createElement("div");
      item.className = "pic-item";
      item.innerHTML = `
        <div class="pic-main">
          <strong>‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${shownNo || "-"}</strong> : ${p.pic_name || ""}
          ${p.pic_path ? `<div class="pic-path">${p.pic_path}</div>` : ""}
        </div>
        <div class="pic-actions">
          <button type="button" class="mini-btn danger" data-act="del-pic" data-idx="${idx}">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
        </div>
      `;
      list.appendChild(item);
    });

    list.querySelectorAll('[data-act="del-pic"]').forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const i = parseInt(e.currentTarget.dataset.idx,10);
        targetNode.pictures.splice(i,1);
        renderPicturesList();
        syncHiddenField();
      });
    });
  }

  renderPicturesList();
  picsBox.appendChild(list);
  return picsBox;
}

/* ========================= Table builder & editor (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ========================= */
/* === createEmptyTable (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) === */
function createEmptyTable(tableNo, caption, rows, cols, type="default"){
  const presets = {
    default: (c)=> Array.from({length:c}, (_,i)=> `‡∏´‡∏±‡∏ß ${i+1}`),
    checklist: ()=> ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "‡∏ú‡πà‡∏≤‡∏ô", "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"],
    evaluation: ()=> ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", "‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û"],
    accuracy: ()=> ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö", "‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç", "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (%)"]
  };
  const headers = (presets[type] || presets.default)(cols);
  const dataRows = Array.from({length: rows}).map(()=> Array.from({length: headers.length}).map(()=> ""));
  const rowTypes = Array.from({length: rows}).fill("normal");
  return { table_no:tableNo, caption:caption||"", headers, rows:dataRows, row_types:rowTypes, notes:[], table_type:type };
}

/* === renderTableBuilder (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) === */
function renderTableBuilder(sectionObj, pathArr, nodeObj) {
  const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
  const box = document.createElement("div");
  box.className = "table-builder";

  box.innerHTML = `
    <div class="tb-head">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${nodeNo}</div>
    <div class="tb-form">
      <div class="tb-row">
        <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</label>
        <input type="text" class="tb-input" data-field="caption" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
      </div>
      <div class="tb-row">
        <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</label>
        <select class="tb-input" data-field="type">
          <option value="default">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
          <option value="checklist">‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option>
          <option value="evaluation">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</option>
          <option value="accuracy">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (%)</option>
        </select>
      </div>
      <div class="tb-row tb-grid">
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß</label>
          <input type="number" min="1" value="2" class="tb-input" data-field="rows">
        </div>
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö ‚Äú‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‚Äù)</label>
          <input type="number" min="1" value="3" class="tb-input" data-field="cols">
        </div>
      </div>
      <div class="tb-actions">
        <button type="button" class="mini-btn primary" data-act="create">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
      </div>
    </div>
  `;

  box.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act=create]");
    if (!btn) return;
    
    const chapterNo = String(sectionObj.title_no).split(".")[0] || "3";
    const nextTableNo = computeFirstFreeTableNoForChapter(chapterNo);
    
    const type    = box.querySelector('[data-field="type"]').value;
    let rows = parseInt(box.querySelector('[data-field="rows"]').value || "2", 10);
    let cols = parseInt(box.querySelector('[data-field="cols"]').value || "3", 10);
    rows = Math.max(1, rows); cols = Math.max(1, cols);

    if (!Array.isArray(nodeObj.tables)) nodeObj.tables = [];
    nodeObj.tables.push(createEmptyTable(nextTableNo, box.querySelector('[data-field="caption"]').value.trim(), rows, cols, type));
    redrawSections();
    alertBox.show(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${nextTableNo} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "success");
    syncHiddenField();
  });
  return box;
}

/* === (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) renderSingleNodeTable === */
function renderSingleNodeTable(t, nodeObj, reRenderFn) {
  const wrap = document.createElement("div");
  wrap.className = "table-card";

  let sel = { r: 0, c: 0 };

  const head = document.createElement("div");
  head.className = "table-head";
  
  head.innerHTML = `
    <div class="table-title">
      <span class="badge-no">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${t.table_no || '?-?'}</span>
      <input type="text" class="table-caption-input" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á" value="${t.caption || ''}">
      <select class="table-type">
        <option value="default" ${t.table_type==='default'?'selected':''}>‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
        <option value="checklist" ${t.table_type==='checklist'?'selected':''}>‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</option>
        <option value="evaluation" ${t.table_type==='evaluation'?'selected':''}>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</option>
        <option value="accuracy" ${t.table_type==='accuracy'?'selected':''}>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (%)</option>
      </select>
    </div>
    <div class="table-actions">
      <button type="button" class="mini-btn" data-act="ins-row-above">‚Üë ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô</button>
      <button type="button" class="mini-btn" data-act="ins-row-below">‚Üì ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á</button>
      <button type="button" class="mini-btn" data-act="ins-col-left">‚Üê ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ã‡πâ‡∏≤‡∏¢</button>
      <button type="button" class="mini-btn" data-act="ins-col-right">‚Üí ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏ß‡∏≤</button>
      <button type="button" class="mini-btn" data-act="add-section-row">+ ‡πÅ‡∏ñ‡∏ß‡∏™‡πà‡∏ß‡∏ô</button>
      <button type="button" class="mini-btn" data-act="del-row">- ‡πÅ‡∏ñ‡∏ß</button>
      <button type="button" class="mini-btn" data-act="del-col">- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
      <button type="button" class="mini-btn danger" data-act="del-table">‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
    </div>
  `;
  wrap.appendChild(head);

  const tbl = document.createElement("table");
  tbl.className = "ui-table";
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");

  t.headers = Array.isArray(t.headers) ? t.headers : [];
  t.rows    = Array.isArray(t.rows) ? t.rows : [];
  t.row_types = Array.isArray(t.row_types) ? t.row_types : t.rows.map(()=> "normal");

  t.headers.forEach((h, cidx) => {
    const th = document.createElement("th");
    const inp = document.createElement("input");
    inp.type = "text"; inp.value = h || "";
    inp.addEventListener("input", (e) => { t.headers[cidx] = e.target.value; syncHiddenField(); });
    inp.addEventListener("focus", () => { sel.c = cidx; sel.r = 0; }); 
    th.appendChild(inp); trh.appendChild(th);
  });
  thead.appendChild(trh); tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  (t.rows || []).forEach((row, r) => {
    const tr = document.createElement("tr");
    const isSection = t.row_types[r] === "section";

    if (isSection) {
      const td = document.createElement("td");
      td.colSpan = t.headers.length;
      td.className = "section-row";
      const inp = document.createElement("input");
      inp.type = "text"; inp.value = (row && row[0]) || "";
      inp.placeholder = "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡πà‡∏ß‡∏ô / ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)";
      inp.addEventListener("input", (e) => { t.rows[r] = [e.target.value]; syncHiddenField(); });
      inp.addEventListener("focus", () => { sel.r = r; sel.c = 0; }); 
      td.appendChild(inp); tr.appendChild(td);
    } else {
      const ensureCols = t.headers.length;
      if (!Array.isArray(row)) row = [];
      while(row.length < ensureCols) row.push("");
      while(row.length > ensureCols) row.pop();
      row.forEach((cell, c) => {
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.type = "text"; inp.value = cell || "";
        inp.addEventListener("input", (e) => { t.rows[r][c] = e.target.value; syncHiddenField(); });
        inp.addEventListener("focus", () => { sel.r = r; sel.c = c; }); 
        td.appendChild(inp); tr.appendChild(td);
      });
    }
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  wrap.appendChild(tbl);

  // --- (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á" (‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤) ---
  if (!Array.isArray(t.notes)) {
    t.notes = (t.note && typeof t.note === 'string') ? [t.note] : [];
    delete t.note; 
  }

  const notesWrap = document.createElement("div");
  notesWrap.className = "table-notes-wrap"; 
  
  const noteLabel = document.createElement("div");
  noteLabel.className = "note-label";
  noteLabel.textContent = "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á";
  notesWrap.appendChild(noteLabel);

  notesWrap.appendChild(
    renderParagraphs(
      t.notes, 
      () => { syncHiddenField(); }, 
      () => { reRenderFn(); }       
    )
  );
  wrap.appendChild(notesWrap);
  // --- (‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î) "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á" ---

  // (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Caption ‡πÅ‡∏•‡∏∞ Type
  const capInp = head.querySelector(".table-caption-input");
  capInp.addEventListener("input", (e)=> { t.caption = e.target.value; syncHiddenField(); });

  const typeSel = head.querySelector(".table-type");
  typeSel.addEventListener("change", (e) => {
    const newType = e.target.value;
    t.table_type = newType;
    // (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å createEmptyTable ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ table_no
    const tmp = createEmptyTable(t.table_no || "3-x", t.caption || "", 1, t.headers.length || 3, newType);
    t.headers = tmp.headers.slice();
    const needCols = t.headers.length;
    (t.rows || []).forEach((row, r) => {
      if (t.row_types[r] === "section") return;
      if (!Array.isArray(row)) t.rows[r] = [];
      while (t.rows[r].length < needCols) t.rows[r].push("");
      while (t.rows[r].length > needCols) t.rows[r].pop();
    });
    reRenderFn(); syncHiddenField();
  });

  // ‚úÖ 6. ‡πÄ‡∏û‡∏¥‡πà‡∏°: helpers insert/remove
  function insertRowAt(index, isSection=false){
    const cols = t.headers.length;
    if (isSection){
      t.rows.splice(index, 0, ["‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡πà‡∏ß‡∏ô"]);
      t.row_types.splice(index, 0, "section");
    } else {
      t.rows.splice(index, 0, Array.from({length:cols}).map(()=> ""));
      t.row_types.splice(index, 0, "normal");
    }
  }
  function insertColAt(index){
    t.headers.splice(index, 0, "");
    (t.rows||[]).forEach((row, r)=>{
      if (t.row_types[r] === "section") return;
      row.splice(index, 0, "");
    });
  }

  // ‚úÖ 7. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï event listener ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°
  head.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-act]"); if (!btn) return;
    const act = btn.dataset.act;

    if (act === "del-table") {
      const i = nodeObj.tables.indexOf(t);
      if (i >= 0 && confirm("‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ?")) {
        nodeObj.tables.splice(i,1);
        reRenderFn(); syncHiddenField();
      }
      return;
    }

    // insert row/col ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™
    if (act === "ins-row-above") { insertRowAt(Math.max(sel.r,0), false); reRenderFn(); syncHiddenField(); return; }
    if (act === "ins-row-below") { insertRowAt(Math.max(sel.r+1,0), false); reRenderFn(); syncHiddenField(); return; }
    if (act === "ins-col-left")  { insertColAt(Math.max(sel.c,0)); reRenderFn(); syncHiddenField(); return; }
    if (act === "ins-col-right") { insertColAt(Math.max(sel.c+1,0)); reRenderFn(); syncHiddenField(); return; }

    if (act === "add-section-row") { // ‡πÅ‡∏ó‡∏£‡∏Å‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏™‡πà‡∏ß‡∏ô ‡∏ì ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
      insertRowAt(Math.max(sel.r+1, 0), true);
      reRenderFn(); syncHiddenField(); return;
    }
    if (act === "del-row") { // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß ‡∏ì ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
      if (t.rows.length > 0) {
        const idx = Math.min(sel.r, t.rows.length-1);
        if (idx >= 0) {
            t.rows.splice(idx,1); t.row_types.splice(idx,1);
        }
      }
      reRenderFn(); syncHiddenField(); return;
    }
    if (act === "del-col") { // ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏ì ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
      if (t.headers.length > 0) {
        const idx = Math.min(sel.c, t.headers.length-1);
        if (idx >= 0) {
            t.headers.splice(idx,1);
            (t.rows||[]).forEach((row, r) => {
              if (t.row_types[r] === "section") return;
              if(row[idx] !== undefined) row.splice(idx,1);
            });
        }
      }
      reRenderFn(); syncHiddenField(); return;
    }
  });

  return wrap;
}

/* ========================= Render nodes/sections (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°) ========================= */
// üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å
function renumberSections(chapterNo = '3') {
    sectionsState.forEach((sec, i) => { sec.title_no = chapterNo + '.' + (i + 1); });
}

function renderNode(sectionObj, secIndex, nodeObj, pathArr) {
  const nodeEl = document.createElement("div");
  nodeEl.className = "node-card";

  const topRow = document.createElement("div");
  topRow.className = "node-top-row";
  const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
  const badge = document.createElement("div");
  badge.className = "node-no-badge";
  badge.textContent = nodeNo;

  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.className = "node-title-input";
  titleInput.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‚Ä¶";
  titleInput.value = nodeObj.text || "";
  titleInput.addEventListener("input", (e) => {
    nodeObj.text = e.target.value;
    syncHiddenField();
  });

  const controls = document.createElement("div");
  controls.className = "node-controls";

  // üí° ‡∏õ‡∏∏‡πà‡∏° '‚ûï ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤' (mini-btn)
  const btnAddPara = document.createElement("button");
  btnAddPara.type = "button";
  btnAddPara.className = "mini-btn";
  btnAddPara.textContent = "‚ûï ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤"; 
  btnAddPara.addEventListener("click", () => {
    if (!nodeObj.paragraphs) nodeObj.paragraphs = [];
    nodeObj.paragraphs.push("");
    redrawSections();
  });
  
  // üí° ‡∏õ‡∏∏‡πà‡∏° '‡∏•‡∏ö' (mini-btn)
  const btnDelNode = document.createElement("button");
  btnDelNode.type = "button";
  btnDelNode.className = "mini-btn danger";
  btnDelNode.textContent = "‡∏•‡∏ö"; 
  btnDelNode.addEventListener("click", () => {
    const ref = getParentAndIndex(sectionObj, pathArr);
    if (ref && confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ " + nodeNo + " ?")) {
      ref.listRef.splice(ref.idx, 1);
      redrawSections();
    }
  });
  
  // ‚ùå ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏° ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å controls
  // controls.appendChild(btnAddChild); 

  controls.appendChild(btnAddPara);
  controls.appendChild(btnDelNode);

  topRow.appendChild(badge);
  topRow.appendChild(titleInput);
  topRow.appendChild(controls);
  nodeEl.appendChild(topRow);

  if (!nodeObj.paragraphs) nodeObj.paragraphs = [];
  nodeEl.appendChild(
    renderParagraphs(
      nodeObj.paragraphs,
      () => { syncHiddenField(); },
      () => { redrawSections(); }
    )
  );
  
  nodeEl.appendChild(renderPicturesBox(sectionObj, secIndex, pathArr));
  nodeEl.appendChild(renderTableBuilder(sectionObj, pathArr, nodeObj));

  const tablesWrap = document.createElement("div");
  tablesWrap.className = "node-tables-wrap";
  function renderTablesOfNode(){
    tablesWrap.innerHTML = "";
    const sortedTables = (nodeObj.tables || []).slice().sort((a, b) => {
      const an = parseSeqFromTableNo(normalizeTableNo(a.table_no));
      const bn = parseSeqFromTableNo(normalizeTableNo(b.table_no));
      return an - bn;
    });
    sortedTables.forEach(tb => {
      tablesWrap.appendChild(
        renderSingleNodeTable(tb, nodeObj, renderTablesOfNode)
      );
    });
  }
  renderTablesOfNode();
  nodeEl.appendChild(tablesWrap);

  const childrenWrap = document.createElement("div");
  childrenWrap.className = "children-block";
  
  (nodeObj.children || []).forEach((childNode, childIdx) => {
    const childPath = [...pathArr, childIdx];
    childrenWrap.appendChild(renderNode(sectionObj, secIndex, childNode, childPath));
  });
  nodeEl.appendChild(childrenWrap);

  // üí° ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏° "‚ûï ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á node
  const btnAddChildBottom = document.createElement("button");
  btnAddChildBottom.type = "button";
  btnAddChildBottom.className = "mini-btn";
  const nextChildNoBottom = nodeNo + '.' + ((nodeObj.children?.length || 0) + 1);
  btnAddChildBottom.textContent = "‚ûï ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (" + nextChildNoBottom + ")";
  btnAddChildBottom.style.marginTop = '10px';
  btnAddChildBottom.style.display = 'block'; // ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  btnAddChildBottom.addEventListener("click", () => {
    if (!nodeObj.children) nodeObj.children = [];
    nodeObj.children.push(makeNode());
    redrawSections();
  });
  nodeEl.appendChild(btnAddChildBottom);
  
  return nodeEl;
}

function renderSectionTree(sectionObj, secIndex) {
  const treeWrap = document.createElement("div");
  treeWrap.className = "tree-wrap";
  (sectionObj.items || []).forEach((node, idx) => {
    const pathArr = [idx];
    treeWrap.appendChild(renderNode(sectionObj, secIndex, node, pathArr));
  });

  const addRootBtn = document.createElement("button");
  addRootBtn.type = "button";
  addRootBtn.className = "mini-btn";
  const nextRootNo = sectionObj.title_no + '.' + ((sectionObj.items?.length || 0) + 1);
  addRootBtn.textContent = "‚ûï ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å (" + nextRootNo + ")"; 
  addRootBtn.addEventListener("click", () => {
    if (!sectionObj.items) sectionObj.items = [];
    sectionObj.items.push(makeNode());
    redrawSections();
  });
  
  const wrapper = document.createElement("div");
  wrapper.style.marginTop = '10px';
  wrapper.appendChild(addRootBtn);
  treeWrap.appendChild(wrapper);
  
  return treeWrap;
}

function renderSectionCard(sectionObj, secIndex) {
  const wrap = document.createElement("div");
  wrap.className = "chapter-section-card";

  const headRow = document.createElement("div");
  headRow.className = "chapter-head-row";

  const badge = document.createElement("div");
  badge.className = "badge-no";
  badge.textContent = sectionObj.title_no;

  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.className = "chapter-title-input";
  titleInput.placeholder = "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤";
  titleInput.value = sectionObj.title || "";
  titleInput.addEventListener("input", (e) => {
    sectionObj.title = e.target.value;
    syncHiddenField();
  });

  // === ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (‡∏Ç‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)" ===
  const delSectionBtn = document.createElement("button");
  delSectionBtn.type = "button";
  delSectionBtn.className = "mini-btn danger";
  delSectionBtn.style.marginLeft = "auto";
  delSectionBtn.textContent = "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà"; 
  delSectionBtn.addEventListener("click", () => {
    if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å " + sectionObj.title_no + " ?")) {
        sectionsState.splice(secIndex, 1);
        redrawSections();
    }
  });

  headRow.appendChild(badge);
  headRow.appendChild(titleInput);
  headRow.appendChild(delSectionBtn);
  wrap.appendChild(headRow);

  const overBlock = document.createElement("div");
  overBlock.className = "overview-block";
  const overLabel = document.createElement("div");
  overLabel.className = "overview-label";
  overLabel.textContent = "‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°):";
  overBlock.appendChild(overLabel);
  if (!sectionObj.body_paragraphs) sectionObj.body_paragraphs = [];
  
  // üí° ‡πÉ‡∏ä‡πâ renderParagraphs ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô
  overBlock.appendChild(
    renderParagraphs(
      sectionObj.body_paragraphs,
      () => { syncHiddenField(); },
      () => { redrawSections(); }
    )
  );
  wrap.appendChild(overBlock);
  wrap.appendChild(renderSectionTree(sectionObj, secIndex));
  return wrap;
}

function redrawSections() {
  const container = document.getElementById("sections-container");
  if (!container) return;
  container.innerHTML = "";
  
  renumberSections('3'); 

  sectionsState.forEach((secObj, secIndex) => {
    container.appendChild(renderSectionCard(secObj, secIndex));
  });
  syncHiddenField();
  refreshAddSectionButton(); 
}

/* ========================= Mapping initial data to nodes (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ========================= */
function attachTablesToNodesFromInitial(tables){
  if (!tables || !Array.isArray(tables)) return;
  function walk(sectionObj, pathArr, nodeObj){
    const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
    const matchTables = [];
    tables.forEach(t=>{
      const anchor = t.anchor_no || "";
      if (anchor ? (anchor === nodeNo) : (String(t.title_no||"").startsWith(nodeNo) || String(t.table_no||"").startsWith(nodeNo))) {
        matchTables.push(t);
      }
    });
    if (matchTables.length){
      if (!Array.isArray(nodeObj.tables)) nodeObj.tables = [];
      matchTables.forEach(t=>{
        nodeObj.tables.push({
          table_no: normalizeTableNo(t.table_no || t.title_no || ""),
          caption: t.caption || "",
          headers: Array.isArray(t.headers) ? t.headers.slice() : [],
          rows: Array.isArray(t.rows) ? t.rows.map(r=>Array.isArray(r)?r.slice():[]) : [],
          row_types: Array.isArray(t.row_types) ? t.row_types.slice() : (Array.isArray(t.rows)?t.rows.map(()=> "normal"):[]),
          table_type: t.table_type || "default",
          notes: (Array.isArray(t.notes) && t.notes.length > 0) 
                  ? t.notes.slice() 
                  : ((t.note && typeof t.note === 'string') ? [t.note] : [])
        });
      });
    }
    (nodeObj.children||[]).forEach((ch, i)=> walk(sectionObj, [...pathArr, i], ch));
  }
  (sectionsState||[]).forEach(sec=>{
    (sec.items||[]).forEach((n,i)=> walk(sec, [i], n));
  });
}

/* ========================= Intro Editor (‡πÉ‡∏´‡∏°‡πà) ========================= */
function validateIntroTitleNo(s){
  return /^3(?:\.\d+)*$/.test(String(s||"").trim());
}
function renderIntroNode(node, idxPath) {
  const card = document.createElement("div");
  card.className = "intro-node-card";

  const head = document.createElement("div");
  head.className = "intro-node-head";

  const noInput = document.createElement("input");
  noInput.type = "text";
  noInput.className = "intro-no-input";
  noInput.placeholder = "‡πÄ‡∏•‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô 3.1 ‡∏´‡∏£‡∏∑‡∏≠ 3.1.1)";
  noInput.value = node.title_no || "";
  noInput.addEventListener("input", (e)=>{
    const v = e.target.value.trim();
    node.title_no = v;
    if (!validateIntroTitleNo(v)) noInput.classList.add("invalid");
    else noInput.classList.remove("invalid");
    syncHiddenField();
  });

  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.className = "intro-title-input";
  titleInput.placeholder = "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢";
  titleInput.value = node.title || "";
  titleInput.addEventListener("input", (e)=> { node.title = e.target.value; syncHiddenField(); });

  const btnAddPara = document.createElement("button");
  btnAddPara.type = "button";
  btnAddPara.className = "mini-btn";
  btnAddPara.textContent = "‚ûï ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  btnAddPara.addEventListener("click", ()=>{
    if (!Array.isArray(node.paragraphs)) node.paragraphs = [];
    node.paragraphs.push("");
    renderIntro();
  });

  const btnAddChild = document.createElement("button");
  btnAddChild.type = "button";
  btnAddChild.className = "mini-btn";
  btnAddChild.textContent = "‚ûï ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ã‡πâ‡∏≠‡∏ô (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏á)";
  btnAddChild.addEventListener("click", ()=>{
    if (!Array.isArray(node.children)) node.children = [];
    node.children.push(makeIntroNode());
    renderIntro();
  });

  // === ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡∏Ç‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡∏ô‡∏≥ ===
  const btnDelete = document.createElement("button");
  btnDelete.type = "button";
  btnDelete.className = "mini-btn danger";
  btnDelete.textContent = "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡∏Ç‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)";
  btnDelete.addEventListener("click", ()=>{
    function removeAtIfLast(rootItems, path){
      if (path.length === 1) {
        if (path[0] !== rootItems.length - 1) return false;
        rootItems.splice(path[0],1); return true;
      }
      let cur = rootItems[path[0]];
      for (let i=1; i<path.length-1; i++) cur = cur.children[path[i]];
      const lastIndex = cur.children.length - 1;
      if (path[path.length-1] !== lastIndex) return false;
      cur.children.splice(lastIndex,1); return true;
    }
    if (!removeAtIfLast(introState.items, idxPath.slice())) {
      alertBox.show("‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô '‡∏Ç‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' ‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏±‡πâ‡∏ô", "warning");
      return;
    }
    renderIntro();
  });

  head.appendChild(noInput);
  head.appendChild(titleInput);
  head.appendChild(btnAddPara);
  head.appendChild(btnAddChild);
  head.appendChild(btnDelete);

  card.appendChild(head);

  if (!Array.isArray(node.paragraphs)) node.paragraphs = [];
  card.appendChild(
    renderParagraphs(
      node.paragraphs,
      ()=>{ syncHiddenField(); },
      ()=>{ renderIntro(); }
    )
  );

  const childrenWrap = document.createElement("div");
  childrenWrap.className = "intro-children-wrap";
  (node.children || []).forEach((ch, i)=>{
    childrenWrap.appendChild(renderIntroNode(ch, idxPath.concat(i)));
  });
  card.appendChild(childrenWrap);

  return card;
}

function renderIntro(){
  const root = document.getElementById("intro-editor");
  if (!root) return;
  root.innerHTML = "";

  const rootBlock = document.createElement("div");
  rootBlock.className = "intro-root-paras";

  const rootLabel = document.createElement("div");
  rootLabel.className = "overview-label";
  rootLabel.textContent = "‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏ö‡∏ó‡∏ô‡∏≥):";
  rootBlock.appendChild(rootLabel);

  if (!Array.isArray(introState.paragraphs)) introState.paragraphs = [];
  rootBlock.appendChild(
    renderParagraphs(
      introState.paragraphs,
      ()=>{ syncHiddenField(); },
      ()=>{ renderIntro(); }
    )
  );

  root.appendChild(rootBlock);

  // >>> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡∏ô‡∏≥ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)
  root.appendChild(renderIntroPicturesBox());

  // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏á) ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
  const addRow = document.createElement("div");
  addRow.className = "intro-add-row";
  const noInput = document.createElement("input");
  noInput.type = "text";
  noInput.placeholder = "‡πÄ‡∏•‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô 3.1)";
  noInput.className = "intro-no-input";

  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.placeholder = "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå)";
  titleInput.className = "intro-title-input";

  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "mini-btn primary";
  addBtn.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏á)";
  addBtn.addEventListener("click", ()=>{
    const vno = (noInput.value || "").trim();
    const vt  = (titleInput.value || "").trim();
    if (!vno || !vt) { alertBox.show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢", "warning"); return; }
    if (!validateIntroTitleNo(vno)) { alertBox.show("‡πÄ‡∏•‡∏Ç‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 3 ‡πÄ‡∏ä‡πà‡∏ô 3.1 ‡∏´‡∏£‡∏∑‡∏≠ 3.1.1)", "error"); return; }
    introState.items.push({ title_no: vno, title: vt, paragraphs: [], children: [] });
    noInput.value = ""; titleInput.value = "";
    renderIntro();
  });

  addRow.appendChild(noInput);
  addRow.appendChild(titleInput);
  addRow.appendChild(addBtn);
  root.appendChild(addRow);

  const list = document.createElement("div");
  list.className = "intro-items-list";
  (introState.items || []).sort((a,b)=>{
    const pa = (a.title_no||"").split(".").map(n=>parseInt(n,10)||0);
    const pb = (b.title_no||"").split(".").map(n=>parseInt(n,10)||0);
    const len = Math.max(pa.length, pb.length);
    for (let i=0;i<len;i++){ const na = pa[i]||0, nb=pb[i]||0; if (na!==nb) return na-nb; }
    return 0;
  }).forEach((node, i)=>{
    list.appendChild(renderIntroNode(node, [i]));
  });
  root.appendChild(list);

  syncHiddenField();
}

/* ========================= Wiring & init ========================= */
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("chapter3Form");
  const btnAddSection = document.getElementById("btnAddSection");
  
  // üí° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà
  if (btnAddSection) {
    btnAddSection.addEventListener("click", () => {
      const nextNo = getNextSectionNumber();
      sectionsState.push(makeSection(nextNo, ""));
      redrawSections();
    });
  }

  /* --- Init Intro Data ‡πÅ‡∏•‡∏∞ Event Listeners --- */
  introData = getIntroBodyData();
  renderIntroParas();
  renderIntroNodes();
  
  const btnAddIntroPara = document.getElementById('btnAddIntroPara');
  if (btnAddIntroPara) {
      btnAddIntroPara.onclick = () => {
          if (!introData.paragraphs) introData.paragraphs = [];
          introData.paragraphs.push('');
          renderIntroParas();
      };
  }
  const btnAddIntroNode = document.getElementById('btnAddIntroNode');
  if (btnAddIntroNode) {
      btnAddIntroNode.onclick = () => {
          if (!introData.subnodes) introData.subnodes = [];
          introData.subnodes.push({ title: '', paragraphs: [''] }); 
          renderIntroNodes();
      };
  }
  /* --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Intro --- */

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å server
  const preSecs = getJsonScript('chapter3-sections');
  if (preSecs && Array.isArray(preSecs) && preSecs.length > 0) {
    const remapPicture = (p) => ({ ...p, pic_no: normalizePicNo(p.pic_no || p.server_pic_no || "") });
    const remapNode = (rawNode) => ({
      text: rawNode.text || "",
      paragraphs: Array.isArray(rawNode.paragraphs) ? rawNode.paragraphs.slice() : [],
      pictures: Array.isArray(rawNode.pictures) ? rawNode.pictures.map(remapPicture) : [],
      tables: [],
      children: Array.isArray(rawNode.children) ? rawNode.children.map(remapNode) : []
    });
    sectionsState = preSecs.map(sec => ({
      title_no: sec.title_no || "",
      title: sec.title || "",
      body_paragraphs: Array.isArray(sec.body_paragraphs) ? sec.body_paragraphs.slice() : [],
      pictures: Array.isArray(sec.pictures) ? sec.pictures.map(remapPicture) : [],
      items: Array.isArray(sec.items) ? sec.items.map(remapNode) : [ makeNode() ]
    }));
  } else {
    sectionsState = [];
  }

  const preTables = getJsonScript('chapter3-tables');
  if (preTables && Array.isArray(preTables) && preTables.length > 0) {
    attachTablesToNodesFromInitial(preTables);
  }

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ö‡∏ó‡∏ô‡∏≥‡∏à‡∏≤‡∏Å server: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö JSON ‡πÅ‡∏•‡∏∞ string ‡πÄ‡∏î‡∏¥‡∏°
 // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ö‡∏ó‡∏ô‡∏≥‡∏à‡∏≤‡∏Å server: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö object / JSON string / double-encoded string
const rawIntro = getJsonScript('chapter3-intro');

function parseMaybeJsonString(s){
  try { return JSON.parse(s); } catch(e){ return null; }
}
function coerceIntro(raw){
  if (raw == null) return null;
  if (typeof raw === 'object') return raw;           // ‡πÑ‡∏î‡πâ dict ‡∏ï‡∏£‡∏á ‡πÜ
  if (typeof raw === 'string') {
    let s = raw.trim();
    // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å JSON-encode ‡∏ã‡πâ‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô  "\"{...}\""
    const unwrap = parseMaybeJsonString(s);
    if (unwrap && (typeof unwrap === 'object' || typeof unwrap === 'string')) s = unwrap;
    if (typeof s === 'object') return s;
    const parsed = parseMaybeJsonString(s);
    if (parsed && typeof parsed === 'object') return parsed;
    // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‚Üí ‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    return { paragraphs: s ? [String(s)] : [], items: [] };
  }
  return null;
}

const introObj = coerceIntro(rawIntro);
if (introObj) {
  introState.paragraphs = Array.isArray(introObj.paragraphs) ? introObj.paragraphs.slice() : [];
  introState.items      = Array.isArray(introObj.items) ? introObj.items.slice() : [];
  
  // [!] EDIT 3: ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏¥‡πâ‡∏á
  // introState.pictures   = Array.isArray(introObj.pictures) ? introObj.pictures.slice() : [];
  // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ô‡∏≥‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å preSecs (sectionsState[0].pictures) ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

} else {
  const legacy = document.getElementById('intro_body_legacy');
  if (legacy && legacy.value.trim().length > 0) {
    introState.paragraphs = [legacy.value.trim()];
  }
}


  // render ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  renderIntro();
  redrawSections();

  if (form) {
    form.addEventListener('click', (e)=>{
      const isMiniBtn = e.target.closest('.mini-btn');
      if (isMiniBtn && e.target.type !== 'submit') {
        e.preventDefault();
      }
    });

    // ‡∏Å‡πà‡∏≠‡∏ô submit: ‡∏ï‡∏±‡∏î \n textarea ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà editor ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏á compatibility ‡πÄ‡∏î‡∏¥‡∏°
    form.addEventListener("submit", function () {
      const textareas = form.querySelectorAll("textarea");
      textareas.forEach(textarea => {
        if (textarea.id === 'intro_body_legacy') return; // ‡∏≠‡∏¢‡πà‡∏≤‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤ legacy; ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏±‡∏ô
        const rawText = textarea.value;
        if (!textarea.closest('.paras-wrap')) {
            const cleanedText = rawText.replace(/\r?\n/g, "").replace(/\s+/g, " ").trim();
            textarea.value = cleanedText;
        }
      });
      // ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á legacy textarea
      const legacy = document.getElementById('intro_body_legacy');
      if (legacy) legacy.name = ""; // ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏û‡∏™‡∏ï‡πå

      syncHiddenField();
      syncIntroHidden(); 
    });
  }
});
</script>

<style>

</style>

</body>
</html>
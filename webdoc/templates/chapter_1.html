{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</title>

  <!-- css ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏ó‡∏ó‡∏µ‡πà1 ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤‡πÜ ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ä‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô -->
  <link rel="stylesheet" href="{% static 'css/chapter_1_clean.css' %}">
</head>
<body>

<div class="container-fluid ch1-wrapper">

  <!-- ================== HEADER ================== -->
  <div class="ch1-page-head">
    <div class="ch1-title-row">
      <div>
        <h1 class="ch1-title">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</h1>
        <div class="ch1-subtitle">
          ‡∏ö‡∏ó‡∏ô‡∏≥‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô ¬∑ ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ ¬∑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å .docx
        </div>
      </div>

      <form id="actionFormTop" method="POST" action="{% url 'chapter_1' %}" class="ch1-inline-form">
        {% csrf_token %}
        <input type="hidden" name="intro_body" id="intro_body_clone_top" />
        <input type="hidden" name="chapter1_json" id="chapter1_json_clone_top" />
        <input type="hidden" name="action" value="get_data" />
        <button type="submit" class="btn btn-outline-secondary btn-sm" onclick="snapshotToHiddenFields()">
          ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        </button>
      </form>
    </div>
  </div>

  <!-- ================== FORM ================== -->
  <form id="chapter1Form" method="POST" action="{% url 'chapter_1' %}">
    {% csrf_token %}

    <!-- ===== ‡∏ö‡∏ó‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 ===== -->
    <div class="card ch1-card mb-4">
      <div class="card-header ch1-card-head">
        <div class="ch1-card-head-main">
          <div class="ch1-card-head-icon ch1-icon-blue">üìÑ</div>
          <div>
            <div class="ch1-card-head-title">‡∏ö‡∏ó‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</div>
            <div class="ch1-card-head-desc">
              ‡πÄ‡∏Å‡∏£‡∏¥‡πà‡∏ô‡∏ñ‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏£‡∏á‡∏à‡∏π‡∏á‡πÉ‡∏à ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
            </div>
          </div>
        </div>
      </div>

      <div class="card-body ch1-card-body">
        <div class="mb-3">
          <label for="intro_body" class="form-label ch1-label">
            ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡∏£‡∏¥‡πà‡∏ô‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1
          </label>
          <textarea
            class="form-control ch1-textarea"
            id="intro_body"
            name="intro_body"
            rows="4"
            placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ...">{{ initial.intro_body|default:'' }}</textarea>
        </div>
      </div>
    </div>

    <!-- ===== ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ ===== -->
    <div class="card ch1-card mb-4">
      <div class="card-header ch1-card-head ch1-card-head-2row">
        <div class="ch1-card-head-main">
          <div class="ch1-card-head-icon ch1-icon-green">üß©</div>
          <div>
            <div class="ch1-card-head-title">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢</div>
            <div class="ch1-card-head-desc">
              ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (1.1 / 1.2 / ...) ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞ bullet ‡∏¢‡πà‡∏≠‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡πâ‡∏ô
            </div>
          </div>
        </div>
        <div class="ch1-card-head-side">
          <button type="button" class="btn btn-success btn-sm" onclick="addSection()">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
      </div>

      <div class="card-body ch1-card-body">
        <!-- list ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 1.x -->
        <div id="sections_container" class="ch1-section-list"></div>
      </div>
    </div>

    <!-- hidden fields -->
    <input type="hidden" id="chapter1_json" name="chapter1_json" value="">
    <input type="hidden" id="actionField" name="action" value="">

    <!-- ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ===== -->
    <div class="card ch1-card mb-5">
      <div class="card-body d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-dark btn-sm" onclick="handleSave()">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button type="button" class="btn btn-primary btn-sm" onclick="handleGenerate()">
          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ .docx
        </button>
        <button type="button" class="btn btn-danger btn-sm" onclick="handleResetConfirm()">
          ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        </button>
      </div>
    </div>

  </form>
</div>


{% if initial.chapter1_json|default:None %}
  {{ initial.chapter1_json|json_script:"chapter1-data" }}
{% endif %}


<script>
/* ================== DATA MODEL ================== */
let sections = [];
// ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô sections:
// {
//   title: "1.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤...",
//   body: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ",
//   points: [
//      { text: "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å 1.x.1", subs: ["bullet ‡∏¢‡πà‡∏≠‡∏¢1", "bullet ‡∏¢‡πà‡∏≠‡∏¢2"] }
//   ]
// }

function getInitialSections() {
  const el = document.getElementById('chapter1-data');
  if (!el) {
    return [
      { title: "1.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤", body: "", points: [] },
      { title: "1.2 ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢",            body: "", points: [] },
      { title: "1.3 ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢",               body: "", points: [] },
      { title: "1.4 ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢",                 body: "", points: [] },
      { title: "1.5 ‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô",                   body: "", points: [] },
      { title: "1.6 ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞",                   body: "", points: [] },
      { title: "1.7 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö",         body: "", points: [] }
    ];
  }
  try {
    const data = JSON.parse(el.textContent);
    if (Array.isArray(data)) return data;
  } catch(e){}
  return [];
}


/* ================== RENDER ================== */
function renderAllSections() {
  const wrap = document.getElementById('sections_container');
  wrap.innerHTML = '';

  sections.forEach((sec, secIndex) => {

    // card ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 1.x
    const box = document.createElement('div');
    box.className = 'ch1-subcard card mb-3';

    // header ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 1.x
    const head = document.createElement('div');
    head.className = 'ch1-subcard-head card-header d-flex flex-wrap justify-content-between align-items-start gap-2';

    const leftHead = document.createElement('div');
    leftHead.className = 'flex-grow-1';

    const lblTitle = document.createElement('label');
    lblTitle.className = 'ch1-label mb-1';
    lblTitle.textContent = `‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô 1.${secIndex+1} ...)`;

    const inpTitle = document.createElement('input');
    inpTitle.type = 'text';
    inpTitle.className = 'form-control form-control-sm';
    inpTitle.value = sec.title || '';
    inpTitle.oninput = e => {
      sections[secIndex].title = e.target.value;
    };

    leftHead.appendChild(lblTitle);
    leftHead.appendChild(inpTitle);

    const rightHead = document.createElement('div');
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'btn btn-outline-danger btn-sm';
    delBtn.textContent = '‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ';
    delBtn.onclick = () => {
      removeSection(secIndex);
    };
    rightHead.appendChild(delBtn);

    head.appendChild(leftHead);
    head.appendChild(rightHead);

    // body ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ
    const bodyWrap = document.createElement('div');
    bodyWrap.className = 'card-body ch1-subcard-body border-bottom';

    const bodyLbl = document.createElement('label');
    bodyLbl.className = 'ch1-label mb-1';
    bodyLbl.textContent = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ';

    const bodyArea = document.createElement('textarea');
    bodyArea.className = 'form-control form-control-sm ch1-textarea';
    bodyArea.rows = 3;
    bodyArea.value = sec.body || '';
    bodyArea.oninput = e => {
      sections[secIndex].body = e.target.value;
    };

    bodyWrap.appendChild(bodyLbl);
    bodyWrap.appendChild(bodyArea);

    // bullet ‡∏¢‡πà‡∏≠‡∏¢ (1.x.1 / 1.x.2 ‚Ä¶)
    const pointsWrap = document.createElement('div');
    pointsWrap.className = 'ch1-points card-body';

    // header bullet list
    const pointsHead = document.createElement('div');
    pointsHead.className = 'd-flex flex-wrap justify-content-between align-items-start gap-2 mb-2';

    const pLeft = document.createElement('div');
    pLeft.className = 'small text-muted';
    pLeft.innerHTML = `
      <div class="fw-semibold text-secondary" style="font-size:.8rem;">
        ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å/ bullet ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ
      </div>
      <div style="font-size:.75rem;">
        ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 1.${secIndex+1}.1 , 1.${secIndex+1}.2 , ...
      </div>
    `;

    const pRight = document.createElement('div');
    const addPointBtn = document.createElement('button');
    addPointBtn.type = 'button';
    addPointBtn.className = 'btn btn-success btn-sm';
    addPointBtn.textContent = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å';
    addPointBtn.onclick = () => {
      addMainPoint(secIndex);
    };
    pRight.appendChild(addPointBtn);

    pointsHead.appendChild(pLeft);
    pointsHead.appendChild(pRight);

    const pointsList = document.createElement('div');
    pointsList.className = 'd-flex flex-column gap-2';

    (sec.points || []).forEach((pt, ptIndex) => {
      const pCard = document.createElement('div');
      pCard.className = 'card ch1-pointcard';

      // header ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å 1.x.1
      const pTop = document.createElement('div');
      pTop.className = 'card-header d-flex flex-wrap justify-content-between align-items-start gap-2';

      const pTopLeft = document.createElement('div');

      const lbMain = document.createElement('label');
      lbMain.className = 'ch1-label mb-1';
      lbMain.textContent = `‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å 1.${secIndex+1}.${ptIndex+1}`;

      const inpMain = document.createElement('input');
      inpMain.type = 'text';
      inpMain.className = 'form-control form-control-sm';
      inpMain.value = pt.text || '';
      inpMain.oninput = e => {
        sections[secIndex].points[ptIndex].text = e.target.value;
      };

      pTopLeft.appendChild(lbMain);
      pTopLeft.appendChild(inpMain);

      const pTopRight = document.createElement('div');
      const delMainBtn = document.createElement('button');
      delMainBtn.type = 'button';
      delMainBtn.className = 'btn btn-outline-danger btn-sm';
      delMainBtn.textContent = '‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏µ‡πâ';
      delMainBtn.onclick = () => {
        removeMainPoint(secIndex, ptIndex);
      };
      pTopRight.appendChild(delMainBtn);

      pTop.appendChild(pTopLeft);
      pTop.appendChild(pTopRight);

      // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î bullet ‡∏¢‡πà‡∏≠‡∏¢‡πÜ (1.x.1.1 ‚Ä¶)
      const subsWrap = document.createElement('div');
      subsWrap.className = 'card-body';

      const subsHead = document.createElement('div');
      subsHead.className = 'd-flex flex-wrap justify-content-between align-items-start gap-2 mb-2';

      const subsLeft = document.createElement('div');
      subsLeft.className = 'small text-muted';
      subsLeft.innerHTML = `
        <div class="fw-semibold text-secondary" style="font-size:.75rem;">
          ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° / bullet ‡∏¢‡πà‡∏≠‡∏¢
        </div>
        <div style="font-size:.7rem;">
          ‡πÄ‡∏ä‡πà‡∏ô 1.${secIndex+1}.${ptIndex+1}.1 , 1.${secIndex+1}.${ptIndex+1}.2 ...
        </div>
      `;

      const subsRight = document.createElement('div');
      const addSubBtn = document.createElement('button');
      addSubBtn.type = 'button';
      addSubBtn.className = 'btn btn-primary btn-sm';
      addSubBtn.textContent = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
      addSubBtn.onclick = () => {
        addSubPoint(secIndex, ptIndex);
      };
      subsRight.appendChild(addSubBtn);

      subsHead.appendChild(subsLeft);
      subsHead.appendChild(subsRight);

      const subsList = document.createElement('div');
      subsList.className = 'd-flex flex-column gap-2';

      (pt.subs || []).forEach((sb, sbIndex) => {
        const row = document.createElement('div');
        row.className = 'd-flex flex-wrap justify-content-between align-items-start gap-2';

        const subLeft = document.createElement('div');
        subLeft.className = 'flex-grow-1';
        const inpSub = document.createElement('input');
        inpSub.type = 'text';
        inpSub.className = 'form-control form-control-sm';
        inpSub.value = sb || '';
        inpSub.oninput = e => {
          sections[secIndex].points[ptIndex].subs[sbIndex] = e.target.value;
        };
        subLeft.appendChild(inpSub);

        const subRight = document.createElement('div');
        const delSubBtn = document.createElement('button');
        delSubBtn.type = 'button';
        delSubBtn.className = 'btn btn-outline-danger btn-sm';
        delSubBtn.textContent = '‡∏•‡∏ö';
        delSubBtn.onclick = () => {
          removeSubPoint(secIndex, ptIndex, sbIndex);
        };
        subRight.appendChild(delSubBtn);

        row.appendChild(subLeft);
        row.appendChild(subRight);

        subsList.appendChild(row);
      });

      subsWrap.appendChild(subsHead);
      subsWrap.appendChild(subsList);

      pCard.appendChild(pTop);
      pCard.appendChild(subsWrap);

      pointsList.appendChild(pCard);
    });

    pointsWrap.appendChild(pointsHead);
    pointsWrap.appendChild(pointsList);

    // ‡πÉ‡∏™‡πà‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 1.x
    box.appendChild(head);
    box.appendChild(bodyWrap);
    box.appendChild(pointsWrap);

    wrap.appendChild(box);
  });
}


/* ================== MODIFY ACTIONS ================== */
function addSection() {
  sections.push({ title: "", body: "", points: [] });
  renderAllSections();
}
function removeSection(secIndex) {
  sections.splice(secIndex, 1);
  renderAllSections();
}
function addMainPoint(secIndex) {
  sections[secIndex].points = sections[secIndex].points || [];
  sections[secIndex].points.push({ text: "", subs: [] });
  renderAllSections();
}
function removeMainPoint(secIndex, ptIndex) {
  sections[secIndex].points.splice(ptIndex, 1);
  renderAllSections();
}
function addSubPoint(secIndex, ptIndex) {
  sections[secIndex].points[ptIndex].subs = sections[secIndex].points[ptIndex].subs || [];
  sections[secIndex].points[ptIndex].subs.push("");
  renderAllSections();
}
function removeSubPoint(secIndex, ptIndex, sbIndex) {
  sections[secIndex].points[ptIndex].subs.splice(sbIndex, 1);
  renderAllSections();
}


/* ================== SUBMIT ================== */
function snapshotToHiddenFields() {
  const introVal = document.getElementById('intro_body').value || "";
  const jsonString = JSON.stringify(sections);

  document.getElementById('chapter1_json').value = jsonString;
  document.getElementById('intro_body_clone_top').value = introVal;
  document.getElementById('chapter1_json_clone_top').value = jsonString;
}

function handleSave() {
  snapshotToHiddenFields();
  document.getElementById('actionField').value = 'save';
  document.getElementById('chapter1Form').submit();
}

function handleGenerate() {
  snapshotToHiddenFields();
  document.getElementById('actionField').value = 'generate_docx';
  document.getElementById('chapter1Form').submit();
}

function handleResetConfirm() {
  if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)")) {
    sections = getInitialSections();
    document.getElementById('intro_body').value = "";
    renderAllSections();
  }
}


/* ================== INIT ================== */
document.addEventListener("DOMContentLoaded", () => {
  sections = getInitialSections();
  renderAllSections();
});
</script>

</body>
</html>

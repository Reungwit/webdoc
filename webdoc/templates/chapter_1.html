{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 ‡∏ö‡∏ó‡∏ô‡∏≥</title>

  <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á chapter_1 (‡∏ã‡∏∂‡πà‡∏á @import chapter_2.css ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô) -->
  <link rel="stylesheet" href="{% static 'css/chapter_1.css' %}">
</head>

<body>
<div class="page-shell">

  <div class="header-row"></div>

  {% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li{% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  <div id="alert-box"></div>

  <form id="chapter1Form" method="POST" action="{% url 'chapter_1' %}">
    {% csrf_token %}

    <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ó‡∏ô‡∏≥ (intro) -->
    <section class="section-card-outer">
      <center><h2>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</h2></center>
      <div class="section-title-head">
        <center>‡∏ö‡∏ó‡∏ô‡∏≥</center>
      </div>
      <div class="section-card-body">
        <div class="badge-no">‡∏ö‡∏ó‡∏ô‡∏≥</div>
        <textarea id="intro_body" name="intro_body" class="clean-textarea main-textarea" rows="6"
                  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1...">{{ initial.intro_body|default:'' }}</textarea>
      </div>
    </section>

    <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 (1.1‚Äì1.7) + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ -->
    <div id="sections-container" class="chapter1-sections-wrapper"></div>

    <div style="margin-top:12px;">
      <button id="btnAddSection" type="button" class="main-btn main-btn-neutral">
        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (1.x)
      </button>
    </div>

    <!-- hidden ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô server -->
    <input type="hidden" id="chapter1_json" name="chapter1_json" value="[]">

    <!-- ‡πÅ‡∏ñ‡∏ß‡∏õ‡∏∏‡πà‡∏° action -->
    <div class="footer-action-bar">
      <button class="main-btn main-btn-success" type="submit" name="action" value="save">
        <span class="emoji">üíæ</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </button>

      <button class="main-btn main-btn-danger" type="submit" name="action" value="generate_docx">
        <span class="emoji">üìÑ</span><span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
      </button>
    </div>
  </form>

  <!-- json_script ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
  {% if initial.chapter1_json|default:None %}{{ initial.chapter1_json|json_script:"chapter1-data" }}{% endif %}
</div>

<script>
/* ========= Helpers ========= */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return "";
}
function getCsrfToken() { return getCookie("csrftoken"); }

const alertBox = (() => {
  const el = () => document.getElementById("alert-box");
  function show(msg, type = "info", timeoutMs = 3000) {
    const box = el(); if (!box) return;
    box.textContent = msg;
    box.className = "";
    box.classList.add(type, "show");
    if (timeoutMs) {
      setTimeout(() => {
        if (box.textContent === msg) {
          box.textContent = "";
          box.className = "";
        }
      }, timeoutMs);
    }
  }
  return { show };
})();

function getJsonScript(id){
  const el = document.getElementById(id);
  if(!el) return null;
  try { return JSON.parse(el.textContent); }
  catch(e){ console.error('JSON Script Error:', e); return null; }
}

/* ========= Data model ‡∏Ç‡∏≠‡∏á chapter_1 =========
  - index 0: { title, paragraphs: [...] }  // 1.1 ‡πÇ‡∏´‡∏°‡∏î paragraphs
  - index 1+: { title, body: "", points: [ { main:"", subs:["", ...] }, ... ] } // 1.2+
*/
function defaultSections(){
  return [
    { title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤', paragraphs: [], mains: [] }, // 1.1
    { title: '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå',                 body: '', points: [] },
    { title: '‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô',                   body: '', points: [] },
    { title: '‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô',          body: '', points: [] },
    { title: '‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô',             body: '', points: [] },
    { title: '‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞',              body: '', points: [] },
    { title: '‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö',    body: '', points: [] },
  ];
}
let chapter1State = defaultSections();

/* ========= Numbering (auto-run ‡πÅ‡∏ö‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2) ========= */
const CHAPTER_NO = 1;
function sectionNo(secIndex){              // 1.x
  return `${CHAPTER_NO}.${secIndex+1}`;
}
function mainNo(secIndex, mainIdx){        // 1.x.y
  return `${CHAPTER_NO}.${secIndex+1}.${mainIdx+1}`;
}
function subNo(secIndex, mainIdx, subIdx){ // 1.x.y.z
  return `${CHAPTER_NO}.${secIndex+1}.${mainIdx+1}.${subIdx+1}`;
}
function getNextSectionNumber(){           // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà
  return sectionNo(chapter1State.length);
}

/* ========= UI builders ========= */
function renderParagraphs(arr, onChangeContent, onAddOrRemove) {
  const wrap = document.createElement("div");
  wrap.className = "paras-wrap";
  arr.forEach((txt, idx) => {
    const row = document.createElement("div");
    row.className = "para-row";
    const ta = document.createElement("textarea");
    ta.classList.add("clean-textarea");
    ta.value = txt || "";
    ta.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ . . .";
    ta.addEventListener("input", (e) => {
      arr[idx] = e.target.value;
      if (onChangeContent) onChangeContent();
    });
    const del = document.createElement("button");
    del.type = "button";
    del.className = "del-para-btn mini-btn-danger";
    del.textContent = "‡∏•‡∏ö‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
    del.addEventListener("click", () => {
      arr.splice(idx,1);
      if (onAddOrRemove) onAddOrRemove();
    });
    row.appendChild(ta);
    row.appendChild(del);
    wrap.appendChild(row);
  });
  const addBtn = document.createElement("button");
  addBtn.type = "button";
  addBtn.className = "add-para-btn";
  addBtn.textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  addBtn.addEventListener("click", () => {
    arr.push("");
    if (onAddOrRemove) onAddOrRemove();
  });
  wrap.appendChild(addBtn);
  return wrap;
}

/* ========= ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 1.1: paragraph-only ========= */
function renderParagraphOnlyCard(secObj, secIndex) {
  const wrap = document.createElement("div");
  wrap.className = "chapter-section-card";

  const headRow = document.createElement("div");
  headRow.className = "chapter-head-row";

  const badge = document.createElement("div");
  badge.className = "badge-no";
  badge.textContent = sectionNo(secIndex); // 1.1

  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.className = "chapter-title-input";
  titleInput.placeholder = "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
  titleInput.value = secObj.title || "";
  titleInput.addEventListener("input", (e) => { secObj.title = e.target.value; });

  headRow.appendChild(badge);
  headRow.appendChild(titleInput);
  wrap.appendChild(headRow);

  const label = document.createElement("div");
  label.className = "overview-label";
  label.textContent = "‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 1.1:";
  wrap.appendChild(label);

  if (!Array.isArray(secObj.paragraphs) || secObj.paragraphs.length === 0) {
    secObj.paragraphs = [""];
  }
  wrap.appendChild(
    renderParagraphs(
      secObj.paragraphs,
      () => {},
      () => { redrawSections(); }
    )
  );

  return wrap;
}

/* ========= ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 1.2+ : main/sub + ‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 1.8 ========= */
function renderPointsCard(secObj, secIndex) {
  const wrap = document.createElement("div");
  wrap.className = "chapter-section-card";

  // ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î
  const headRow = document.createElement("div");
  headRow.className = "chapter-head-row";

  const badge = document.createElement("div");
  badge.className = "badge-no";
  badge.textContent = sectionNo(secIndex); // 1.x

  const titleInput = document.createElement("input");
  titleInput.type = "text";
  titleInput.className = "chapter-title-input";
  titleInput.placeholder = "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå";
  titleInput.value = secObj.title || "";
  titleInput.addEventListener("input", (e) => { secObj.title = e.target.value; });

  const headControls = document.createElement("div");
  headControls.className = "node-controls";

  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 1.8 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ (index >= 7)
  if (secIndex >= 7) {
    const btnDelSection = document.createElement("button");
    btnDelSection.type = "button";
    btnDelSection.className = "mini-btn mini-btn-danger";
    btnDelSection.textContent = `‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${sectionNo(secIndex)}`;
    btnDelSection.addEventListener("click", () => {
      chapter1State.splice(secIndex, 1);
      redrawSections(); // ‡∏£‡∏µ‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    });
    headControls.appendChild(btnDelSection);
  }

  headRow.appendChild(badge);
  headRow.appendChild(titleInput);
  headRow.appendChild(headControls);
  wrap.appendChild(headRow);

  // ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ body ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
  const overBlock = document.createElement("div");
  overBlock.className = "overview-block";
  const overLabel = document.createElement("div");
  overLabel.className = "overview-label";
  overLabel.textContent = "‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°):";
  const bodyTA = document.createElement("textarea");
  bodyTA.className = "clean-textarea";
  bodyTA.rows = 4;
  bodyTA.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ...";
  bodyTA.value = secObj.body || "";
  bodyTA.addEventListener("input", e => { secObj.body = e.target.value; });
  overBlock.appendChild(overLabel);
  overBlock.appendChild(bodyTA);
  wrap.appendChild(overBlock);

  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ main/sub
  const pointsWrap = document.createElement("div");
  pointsWrap.className = "tree-wrap";

  function renderOnePoint(point, mainIdx) {
    const nodeEl = document.createElement("div");
    nodeEl.className = "node-card";

    const topRow = document.createElement("div");
    topRow.className = "node-top-row";

    const nodeBadge = document.createElement("div");
    nodeBadge.className = "node-no-badge";
    nodeBadge.textContent = mainNo(secIndex, mainIdx); // 1.x.y

    const titleInput = document.createElement("input");
    titleInput.type = "text";
    titleInput.className = "node-title-input";
    titleInput.placeholder = "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (main)";
    titleInput.value = point.main || "";
    titleInput.addEventListener("input", (e) => { point.main = e.target.value; });

    const controls = document.createElement("div");
    controls.className = "node-controls";

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢" ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô 1.2.1.5
    const nextSubNo = `${mainNo(secIndex, mainIdx)}.${(point.subs ? point.subs.length : 0) + 1}`;
    const btnAddSub = document.createElement("button");
    btnAddSub.type = "button";
    btnAddSub.className = "mini-btn";
    btnAddSub.textContent = `‚ûï ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ (${nextSubNo})`;
    btnAddSub.addEventListener("click", () => {
      if (!Array.isArray(point.subs)) point.subs = [];
      point.subs.push("");
      redrawSections();
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (main)" ‚Äî ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç, ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"
    const btnDelMain = document.createElement("button");
    btnDelMain.type = "button";
    btnDelMain.className = "mini-btn mini-btn-danger";
    btnDelMain.textContent = "‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠";                         // ‚Üê ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô: `‡∏•‡∏ö ${mainNo(secIndex, mainIdx)}`
    btnDelMain.title = `‡∏•‡∏ö ${mainNo(secIndex, mainIdx)}`;        // tooltip ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡πÄ‡∏ß‡∏≠‡∏£‡πå
    btnDelMain.setAttribute("aria-label", `‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${mainNo(secIndex, mainIdx)}`);
    btnDelMain.addEventListener("click", () => {
      secObj.points.splice(mainIdx, 1);
      redrawSections();
    });

    controls.appendChild(btnAddSub);
    controls.appendChild(btnDelMain);

    topRow.appendChild(nodeBadge);
    topRow.appendChild(titleInput);
    topRow.appendChild(controls);
    nodeEl.appendChild(topRow);

    // subs
    const subsWrap = document.createElement("div");
    subsWrap.className = "children-block";
    (point.subs || []).forEach((sv, subIdx) => {
      const row = document.createElement("div");
      row.className = "para-row";

      const lbl = document.createElement("label");
      lbl.className = "overview-label";
      lbl.textContent = subNo(secIndex, mainIdx, subIdx); // 1.x.y.z

      const inp = document.createElement("input");
      inp.type = "text";
      inp.className = "node-title-input";
      inp.placeholder = "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢";
      inp.value = sv || "";
      inp.addEventListener("input", (e) => { point.subs[subIdx] = e.target.value; });

      // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö sub ‚Üí ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç, ‡∏™‡∏µ‡πÅ‡∏î‡∏á
      const del = document.createElement("button");
      del.type = "button";
      del.className = "mini-btn mini-btn-danger";
      del.textContent = "‡∏•‡∏ö";
      del.addEventListener("click", () => {
        point.subs.splice(subIdx,1);
        redrawSections();
      });

      row.appendChild(lbl);
      row.appendChild(inp);
      row.appendChild(del);
      subsWrap.appendChild(row);
    });

    nodeEl.appendChild(subsWrap);
    return nodeEl;
  }

  (secObj.points || []).forEach((pt, idx) => {
    pointsWrap.appendChild(renderOnePoint(pt, idx));
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° main ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô 1.2.3
  const addMainBtn = document.createElement("button");
  addMainBtn.type = "button";
  addMainBtn.className = "mini-btn";
  const nextMainNo = `${sectionNo(secIndex)}.${(secObj.points ? secObj.points.length : 0) + 1}`;
  addMainBtn.textContent = `‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å (${nextMainNo})`;
  addMainBtn.addEventListener("click", () => {
    if (!Array.isArray(secObj.points)) secObj.points = [];
    secObj.points.push({ main: "", subs: [] });
    redrawSections();
  });
  pointsWrap.appendChild(addMainBtn);

  wrap.appendChild(pointsWrap);
  return wrap;
}

/* ========= Render ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ ========= */
function refreshAddSectionButton(){
  const btn = document.getElementById("btnAddSection");
  if (!btn) return;
  btn.innerHTML = `‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (${getNextSectionNumber()})`;
}
function redrawSections() {
  const container = document.getElementById("sections-container");
  if (!container) return;
  container.innerHTML = "";

  chapter1State.forEach((secObj, idx) => {
    if (idx === 0) container.appendChild(renderParagraphOnlyCard(secObj, idx));
    else           container.appendChild(renderPointsCard(secObj, idx));
  });

  refreshAddSectionButton(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  syncHiddenField();         // sync state -> hidden
}

/* ========= (De)Serialize ========= */
function syncHiddenField() {
  const hidden = document.getElementById("chapter1_json");
  if (!hidden) return;
  const clean = chapter1State.map((sec, idx) => {
    if (idx === 0) {
      const paras = (sec.paragraphs || []).map(s => String(s||"").trim()).filter(Boolean);
      return { title: sec.title || "", paragraphs: paras, mains: [] };
    }
    const body = String(sec.body || "").trim();
    const points = (sec.points || []).map(p => ({
      main: String(p.main || "").trim(),
      subs: (p.subs || []).map(s => String(s||"").trim()).filter(Boolean)
    })).filter(pp => pp.main || (pp.subs && pp.subs.length));
    return { title: sec.title || "", body, points };
  });
  hidden.value = JSON.stringify(clean);
}

/* ========= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà ========= */
function makeNewSection() {
  return { title: "", body: "", points: [] };
}
function wireButtons() {
  const btnAddSection = document.getElementById("btnAddSection");
  if (btnAddSection) {
    btnAddSection.addEventListener("click", () => {
      chapter1State.push(makeNewSection());
      redrawSections(); // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      alertBox.show(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${getNextSectionNumber().replace(/\.\d+$/, '')} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ`, "success");
    });
  }
}

/* ========= Init ========= */
document.addEventListener("DOMContentLoaded", () => {
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å server ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  const pre = getJsonScript('chapter1-data');
  if (pre && Array.isArray(pre) && pre.length > 0) {
    chapter1State = pre.map((s, idx) => {
      if (idx === 0) {
        const fromBodyToParas = (s.body || "").trim()
          ? (String(s.body).replace(/\r\n/g, '\n').split(/\n\n+/).map(t => t.trim()).filter(Boolean))
          : [];
        const paras = Array.isArray(s.paragraphs) ? s.paragraphs.slice()
                     : fromBodyToParas.length ? fromBodyToParas : [""];
        return { title: s.title || "", paragraphs: paras, mains: [] };
      } else {
        const points = Array.isArray(s.points) ? s.points.map(p => ({
          main: p.main || "",
          subs: Array.isArray(p.subs) ? p.subs.slice() : []
        })) : [];
        return { title: s.title || "", body: s.body || "", points };
      }
    });
  } else {
    chapter1State = defaultSections();
  }

  redrawSections();
  wireButtons();

  const form = document.getElementById("chapter1Form");
  if (form) {
    form.addEventListener("submit", function () {
      // 1) sync state -> hidden
      syncHiddenField();
      // 2) ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î textarea ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const textareas = form.querySelectorAll("textarea");
      textareas.forEach(textarea => {
        const rawText = textarea.value;
        const cleanedText = rawText.replace(/\r?\n/g, "").replace(/\s+/g, " ").trim();
        textarea.value = cleanedText;
      });
    });
  } else {
    console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö <form id='chapter1Form'>");
  }
});
</script>

</body>
</html>

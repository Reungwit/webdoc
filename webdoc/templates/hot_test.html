<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Handsontable ‚Äî table quick test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Handsontable (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.js"></script>

  <style>
    :root{--border:#e5e7eb;--muted:#6b7280}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px}
    h1{margin-top:0}
    .btn{padding:10px 14px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:#2d6cdf;color:#fff;border-color:#2d6cdf}
    .wrap{display:flex;gap:16px;align-items:center;margin:12px 0 20px}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;margin:12px 0;background:#fff}
    .head{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{display:flex;gap:8px;align-items:center;flex:1}
    .badge{background:#eef2ff;border:1px solid #c7d2fe;border-radius:8px;padding:2px 8px;font-weight:700;color:#1e3a8a}
    .caption{flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:8px}
    .sub{font-size:12px;color:var(--muted);margin:6px 0 8px}
    .hot{border:1px solid var(--border);border-radius:10px;overflow:auto}
    .actions{display:flex;gap:6px}
    .json-view{width:100%;height:120px;margin-top:10px}
  </style>
</head>
<body>

  <h1>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Handsontable</h1>
  <div class="wrap">
    <button id="btnCreate" class="btn primary">üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
    <button id="btnShowJson" class="btn">üëÄ ‡πÅ‡∏™‡∏î‡∏á tb_sections_json</button>
  </div>

  <div id="tablesContainer"></div>

  <textarea id="jsonOut" class="json-view" placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå tb_sections_json ‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äò‡πÅ‡∏™‡∏î‡∏á tb_sections_json‚Äô"></textarea>

<script>
/* ---------- Config: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ö‡∏ó ---------- */
const CHAPTER_NO = 3;

/* ---------- State ---------- */
let tableSeq = 0;               // running number ‡∏ï‡πà‡∏≠‡∏ö‡∏ó
const allTables = [];           // ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á tb_sections_json

/* ---------- Helpers ---------- */
function nextSeq(){ tableSeq += 1; return tableSeq; }
function formatDisplayTitle(chap, seq, caption){
  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà <‡∏ö‡∏ó>-<seq>‚ê†‚ê†<caption>
  const cap = (caption||"").trim();
  return `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${chap}-${seq}${cap ? "  " + cap : ""}`;
}
function buildTbJson(tb){
  return {
    title_no: tb.title_no,          // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏ú‡∏π‡∏Å‡∏ï‡∏≤‡∏° seq ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
    caption: tb.caption || "",
    headers: tb.hot ? tb.hot.getColHeader() : tb.headers,
    rows: tb.hot ? tb.hot.getData() : tb.rows,
    display_title: tb.display_title,
    seq: tb.seq,
    anchor_no: tb.title_no         // ‡πÉ‡∏ä‡πâ title_no ‡πÄ‡∏õ‡πá‡∏ô anchor ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
  };
}
function refreshJsonOutput(){
  const payload = allTables.map(buildTbJson);
  document.getElementById('jsonOut').value = JSON.stringify(payload, null, 2);
}

/* ---------- Create one empty HOT table (5x5) ---------- */
function createDefaultMatrix(rows=5, cols=5){
  const headers = Array.from({length: cols}, (_,i)=>"‡∏´‡∏±‡∏ß "+(i+1));
  const data    = Array.from({length: rows}, ()=> Array.from({length: cols}, ()=>""));
  return {headers, data};
}

/* ---------- UI: create a table card ---------- */
function createTableCard(){
  const seq = nextSeq();
  const titleNo = `3.${seq}`; // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡∏≠‡∏¥‡∏á‡πÄ‡∏•‡∏Ç node ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô 3.<seq>

  const card = document.createElement('div');
  card.className = 'card';

  const head = document.createElement('div');
  head.className = 'head';

  const titleWrap = document.createElement('div');
  titleWrap.className = 'title';

  const badge = document.createElement('span');
  badge.className = 'badge';
  badge.textContent = titleNo;

  const caption = document.createElement('input');
  caption.className = 'caption';
  caption.placeholder = '‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á';

  const actions = document.createElement('div');
  actions.className = 'actions';
  actions.innerHTML = `
    <button class="btn" data-act="add-row">+ ‡πÅ‡∏ñ‡∏ß</button>
    <button class="btn" data-act="add-col">+ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
    <button class="btn" data-act="del-row">- ‡πÅ‡∏ñ‡∏ß</button>
    <button class="btn" data-act="del-col">- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
    <button class="btn" data-act="remove">‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
  `;

  titleWrap.appendChild(badge);
  titleWrap.appendChild(caption);
  head.appendChild(titleWrap);
  head.appendChild(actions);

  const sub = document.createElement('div');
  sub.className = 'sub';
  sub.textContent = ''; // ‡∏à‡∏∞ set ‡∏´‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå caption

  const mount = document.createElement('div');
  mount.className = 'hot';

  card.appendChild(head);
  card.appendChild(sub);
  card.appendChild(mount);

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á HOT 5√ó5
  const base = createDefaultMatrix();
  const hot = new Handsontable(mount, {
    data: base.data,
    colHeaders: base.headers,
    rowHeaders: true,
    manualColumnMove: true,
    manualRowMove: true,
    stretchH: 'all',
    contextMenu: true,
    licenseKey: 'non-commercial-and-evaluation',
    afterChange(){ syncSelf(); }
  });

  // ‡πÄ‡∏Å‡πá‡∏ö state ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ô‡∏µ‡πâ
  const tb = {
    title_no: titleNo,
    caption: '',
    display_title: '',
    seq: seq,
    hot
  };
  allTables.push(tb);

  // sync caption -> display_title
  caption.addEventListener('input', (e)=>{
    tb.caption = e.target.value;
    tb.display_title = formatDisplayTitle(CHAPTER_NO, tb.seq, tb.caption);
    sub.textContent = tb.display_title;
    syncSelf();
  });

  // ‡∏õ‡∏∏‡πà‡∏° actions
  head.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-act]'); if(!btn) return;
    const act = btn.getAttribute('data-act');
    if (act === 'add-row') hot.alter('insert_row', hot.countRows());
    if (act === 'del-row' && hot.countRows()>0) hot.alter('remove_row', hot.countRows()-1);
    if (act === 'add-col'){ hot.alter('insert_col', hot.countCols()); const h=hot.getColHeader(); h.push(''); hot.updateSettings({colHeaders:h}); }
    if (act === 'del-col' && hot.countCols()>0){ const h=hot.getColHeader(); h.pop(); hot.alter('remove_col', hot.countCols()-1); hot.updateSettings({colHeaders:h}); }
    if (act === 'remove'){
      if (confirm('‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ?')){
        const i = allTables.indexOf(tb);
        if (i>=0) allTables.splice(i,1);
        card.remove();
        refreshJsonOutput();
      }
    }
    syncSelf();
  });

  function syncSelf(){ refreshJsonOutput(); }
  // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ß‡πà‡∏≤‡∏á)
  tb.display_title = formatDisplayTitle(CHAPTER_NO, tb.seq, tb.caption);
  sub.textContent = tb.display_title;

  return card;
}

/* ---------- Wire buttons ---------- */
document.getElementById('btnCreate').addEventListener('click', ()=>{
  const card = createTableCard();
  document.getElementById('tablesContainer').appendChild(card);
});

document.getElementById('btnShowJson').addEventListener('click', ()=>{
  refreshJsonOutput();
});
</script>
</body>
</html>

{% load static %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ page_title|default:"‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" }}</title>

  <link rel="stylesheet" href="{% static 'css/chapter_3.css' %}">
  <!-- Handsontable -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/styles/ht-theme-main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
</head>

<body>
<div class="page-shell">

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        {% if "chapter3" in message.tags %}
          <li class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</li>
        {% endif %}
      {% endfor %}
    </ul>
  {% endif %}

  <div id="alert-box"></div>

  <form id="chapter3Form" method="POST" action="{% url 'chapter_3' %}" enctype="multipart/form-data">
    {% csrf_token %}

    <section class="section-card-outer">
      <center><h2>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</h2></center>
      <div class="section-title-head"><center>‡∏ß‡∏¥‡∏ò‡∏µ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£/‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</center></div>

      <div class="section-card-body">
        <div class="badge-no">‡∏ö‡∏ó‡∏ô‡∏≥</div>
        <textarea id="intro_body" name="intro_body" class="clean-textarea main-textarea" rows="6" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏ó‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3...">{{ initial.intro_body|default:'' }}</textarea>
      </div>
    </section>

    <div class="toolbar-top">
      <button id="btnAddSection" class="main-btn main-btn-neutral" type="button">
        <span class="emoji">‚ûï</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà (3.x)</span>
      </button>
    </div>

    <div id="sections-container" class="chapter-sections-wrapper"></div>

    <!-- hidden fields -->
    <input type="hidden" id="sections_json"    name="sections_json"    value="[]">
    <input type="hidden" id="tb_sections_json" name="tb_sections_json" value="[]">

    <div class="footer-action-bar">
      <button class="main-btn main-btn-success" type="submit" name="action" value="save">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="main-btn main-btn-info"    type="submit" name="action" value="get_data">üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="main-btn main-btn-danger"  type="submit" name="action" value="generate_doc">üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
    </div>
  </form>

  {% if initial.sections %}{{ initial.sections|json_script:"chapter3-sections" }}{% endif %}
  {% if initial.tables %}{{ initial.tables|json_script:"chapter3-tables" }}{% endif %}
</div>

<script>
/* ---------- utils ---------- */
function getCookie(name){const v=`; ${document.cookie}`;const p=v.split(`; ${name}=`);if(p.length===2)return p.pop().split(";").shift();return"";}
function getCsrfToken(){return getCookie("csrftoken");}
function jsonScript(id){const el=document.getElementById(id);if(!el)return null;try{return JSON.parse(el.textContent);}catch{ return null;}}

const alertBox=(()=>{const el=()=>document.getElementById("alert-box");
  function show(msg,type="info",timeout=2200){const b=el();if(!b)return;b.textContent=msg;b.className="";b.classList.add("alert-inline",type,"show");if(timeout)setTimeout(()=>{if(b.textContent===msg){b.textContent="";b.className="";}},timeout);}
  return {show};
})();

/* ---------- data model ---------- */
function makeNode(){return{ text:"", paragraphs:[], pictures:[], tables:[], children:[] };}
function makeSection(no,title){return{ title_no:no, title, body_paragraphs:[], pictures:[], items:[makeNode()] };}
let sectionsState=[ makeSection("3.1","") ];
const CHAPTER_NO = 3;

/* ---------- keep UI open states ---------- */
const picsOpenState = new Map();      // key=nodeKey -> true/false
const tableBuilderOpenState = new Map();

function nodeKey(secIndex, pathArr){ return `${secIndex}|${pathArr.join('.')}`; }

/* ---------- picture numbering (‡πÅ‡∏ö‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2) ---------- */
function normalizePicNo(any){const m=String(any||'').match(/^(\d+)(?:\.\d+)*-(\d+)$/);return m?`${m[1]}-${m[2]}`:any;}
function collectChapterPicSeqs(chapterNo){
  const seqs=new Set();
  function scanPics(arr){(arr||[]).forEach(p=>{const n=normalizePicNo(p.pic_no);if(n&&String(n).startsWith(chapterNo+'-')){const m=String(n).split('-')[1];const v=parseInt(m||'0',10);if(v>0)seqs.add(v);}});}
  function walkNode(n){scanPics(n.pictures);(n.children||[]).forEach(walkNode);}
  (sectionsState||[]).forEach(sec=>{if(String(sec.title_no).split('.')[0]===String(chapterNo)){scanPics(sec.pictures);(sec.items||[]).forEach(walkNode);}});
  return seqs;
}
function nextPicNo(chapterNo){
  const used=collectChapterPicSeqs(chapterNo);
  let i=1; while(used.has(i)) i++;
  return `${chapterNo}-${i}`;
}

/* ---------- table helpers ---------- */
function defaultMatrix(rows=5, cols=5){
  const headers=Array.from({length:cols},(_,i)=>`‡∏´‡∏±‡∏ß ${i+1}`);
  const rowsData=Array.from({length:rows},()=>Array.from({length:cols},()=>'')); 
  return { headers, rowsData };
}
function renumberHeaders(hot){
  const n=hot.countCols();
  hot.updateSettings({ colHeaders: Array.from({length:n},(_,i)=>`‡∏´‡∏±‡∏ß ${i+1}`) });
}
function normalizedHeaders(hot){const n=hot.countCols();let h=Array.isArray(hot.getColHeader())?hot.getColHeader().slice():[];while(h.length<n)h.push(`‡∏´‡∏±‡∏ß ${h.length+1}`);if(h.length>n)h.length=n;return h;}
function addRowAfterSelection(hot){const data=hot.getData();const nRows=hot.countRows();const nCols=hot.countCols();const sel=hot.getSelectedLast();const r=sel?sel[0]:nRows-1;const row=Array.from({length:nCols},()=> "");data.splice(Math.max(r+1,0),0,row);hot.updateSettings({data});}
function removeRowAtSelection(hot){const data=hot.getData();const nRows=hot.countRows();if(!nRows)return;const sel=hot.getSelectedLast();const r=sel?sel[0]:nRows-1;data.splice(Math.max(r,0),1);hot.updateSettings({data});}
function addColAfterSelection(hot){const data=hot.getData();const nCols=hot.countCols();let headers=normalizedHeaders(hot);const sel=hot.getSelectedLast();const c=sel?sel[1]:nCols-1;data.forEach(row=>row.splice(Math.max(c+1,0),0,""));headers.splice(Math.max(c+1,0),0,"");hot.updateSettings({data,colHeaders:headers});renumberHeaders(hot);}
function removeColAtSelection(hot){const data=hot.getData();const nCols=hot.countCols();if(!nCols)return;let headers=normalizedHeaders(hot);const sel=hot.getSelectedLast();const c=sel?sel[1]:nCols-1;data.forEach(row=>row.splice(Math.max(c,0),1));headers.splice(Math.max(c,0),1);hot.updateSettings({data,colHeaders:headers});renumberHeaders(hot);}

function formatDisplayTitle(chap, seq, caption){
  const cap=(caption||'').trim();
  return `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà ${chap}-${seq}${cap ? '  '+cap : ''}`;
}
function nextTableSeqForChapter(chapNo){
  const all=[]; function walk(n){(n.tables||[]).forEach(t=>all.push(t));(n.children||[]).forEach(walk);}
  (sectionsState||[]).forEach(sec=>{ if(String(sec.title_no).split('.')[0]===String(chapNo)){ (sec.items||[]).forEach(walk); }});
  const seqs=all.map(t=>parseInt(t.seq||0,10)).filter(n=>Number.isFinite(n)&&n>0);
  let i=1; while(seqs.includes(i)) i++; return i;
}
function createDefaultTable(titleNo, caption){
  const {headers, rowsData}=defaultMatrix();
  return { title_no:titleNo, caption:caption||'', headers, rows:rowsData, seq:null, display_title:'', __open:true };
}

/* ---------- UI small helpers ---------- */
function buildNodeNumber(sectionNo,pathArr){return sectionNo+"."+pathArr.map(i=>i+1).join(".");}
function getNodeByPath(sectionObj, pathArr){let cur=sectionObj.items[pathArr[0]];for(let i=1;i<pathArr.length;i++)cur=cur.children[pathArr[i]];return cur;}
function getParentAndIndex(sectionObj, pathArr){if(pathArr.length===1)return{listRef:sectionObj.items,idx:pathArr[0]};let p=sectionObj.items[pathArr[0]];for(let i=1;i<pathArr.length-1;i++)p=p.children[pathArr[i]];return{listRef:p.children,idx:pathArr[pathArr.length-1]};}

/* ---------- Pictures UI (fixed keep-open + numbering) ---------- */
const pendingFiles = new Map();

function renderPicturesBox(sectionObj, secIndex, pathArr){
  const targetNode = getNodeByPath(sectionObj, pathArr);
  if(!targetNode.pictures) targetNode.pictures = [];

  const nodeNo = buildNodeNumber(sectionObj.title_no, pathArr);
  const key = nodeKey(secIndex, pathArr);

  // toggle button
  const toggle = document.createElement("button");
  toggle.type="button"; toggle.className="mini-btn"; toggle.textContent="üñºÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û";

  // box
  const box = document.createElement("div");
  box.className="pics-box";

  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏° state: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î
  const defaultOpen = targetNode.pictures.length>0;
  const remembered = picsOpenState.get(key);
  box.hidden = remembered!==undefined ? !remembered : !defaultOpen;

  toggle.addEventListener("click",(e)=>{ e.preventDefault(); box.hidden=!box.hidden; picsOpenState.set(key, !box.hidden); });

  // header
  const head = document.createElement("div");
  head.className = "pics-head";
  head.textContent = `‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${nodeNo}`;

  // add row
  const row = document.createElement("div");
  row.className = "pics-add-row";

  const captionInput = document.createElement("input");
  captionInput.type="text"; captionInput.className="pic-caption-input"; captionInput.placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ ‚Ä¶";

  const pickBtn = document.createElement("button");
  pickBtn.type="button"; pickBtn.className="mini-btn"; pickBtn.textContent="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‚Ä¶";

  const uploadBtn = document.createElement("button");
  uploadBtn.type="button"; uploadBtn.className="mini-btn primary"; uploadBtn.textContent="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ";

  const pendingLabel = document.createElement("div");
  pendingLabel.className="pending-label";

  const fileInput = document.createElement("input");
  fileInput.type="file"; fileInput.accept="image/*"; fileInput.className="hidden-file";

  pickBtn.addEventListener("click",(e)=>{e.preventDefault();fileInput.click();});
  fileInput.addEventListener("change",()=>{ if(fileInput.files&&fileInput.files.length){ pendingFiles.set(key,{file:fileInput.files[0]}); pendingLabel.textContent="‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: "+fileInput.files[0].name; } });

  uploadBtn.addEventListener("click", async (e)=>{
    e.preventDefault();
    const info=pendingFiles.get(key);
    const f=info&&info.file;
    const cap=(captionInput.value||"").trim();
    if(!cap){alertBox.show("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û","warning");return;}
    if(!f){alertBox.show("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ","warning");return;}

    alertBox.show("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...","info",0);
    try{
      const chapterNo = String(sectionObj.title_no).split(".")[0] || "3";
      const autoPicNo = nextPicNo(chapterNo); // ‡πÄ‡∏ä‡πà‡∏ô 3-1

      const fd = new FormData();
      fd.append("action","add_picture");
      fd.append("node_no", nodeNo);
      fd.append("pic_name", cap);
      fd.append("pic_file", f);
      fd.append("pic_no", autoPicNo); // ‡∏™‡πà‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ö‡∏ó 2 ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢

      const res = await fetch(window.location.href,{ method:"POST", headers:{ "X-CSRFToken":getCsrfToken() }, body:fd });
      if(!res.ok) throw new Error(await res.text());
      const data = await res.json();

      const pushed = (data && data.picture) ? data.picture : { pic_no:(data&&data.pic_no)||autoPicNo, pic_name:cap, pic_path:f.name, url:null };
      targetNode.pictures.push(pushed);
      renderList(); // refresh

      captionInput.value=""; fileInput.value=""; pendingFiles.delete(key); pendingLabel.textContent="";
      picsOpenState.set(key, true); // ‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏™‡∏°‡∏≠
      alertBox.show("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","success");
      syncHiddenField();
    }catch(err){ console.error(err); alertBox.show("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+err.message,"error",4500); }
  });

  row.appendChild(captionInput); row.appendChild(pickBtn); row.appendChild(uploadBtn); row.appendChild(pendingLabel); row.appendChild(fileInput);

  // list
  const list = document.createElement("div"); list.className="pic-list";
  function renderList(){
    list.innerHTML="";
    const arr=targetNode.pictures||[];
    if(arr.length===0){ const e=document.createElement("div"); e.className="pic-item empty"; e.textContent="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ"; list.appendChild(e); return; }

    arr.forEach((p, idx)=>{
      const item=document.createElement("div"); item.className="pic-item";
      const left=document.createElement("div"); left.className="pic-main";
      left.innerHTML = `<strong>${p.pic_no?`‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${normalizePicNo(p.pic_no)}`:"‡∏†‡∏≤‡∏û"}</strong> : ${p.pic_name||""}`;
      if(p.url){ const img=document.createElement("img"); img.src=p.url; img.alt=p.pic_name||""; img.style.cssText="max-height:40px;margin-left:8px;border-radius:4px;border:1px solid #e5e7eb"; left.appendChild(img); }
      else if(p.pic_path){ const pp=document.createElement("div"); pp.className="pic-path"; pp.textContent=p.pic_path; left.appendChild(pp); }

      const right=document.createElement("div"); right.className="pic-actions";
      const del=document.createElement("button"); del.type="button"; del.className="mini-btn danger"; del.textContent="‡∏•‡∏ö‡∏£‡∏π‡∏õ";
      del.addEventListener("click",(e)=>{ e.preventDefault(); targetNode.pictures.splice(idx,1); renderList(); syncHiddenField(); });

      right.appendChild(del); item.appendChild(left); item.appendChild(right); list.appendChild(item);
    });
  }
  renderList();

  // compose
  box.appendChild(head); box.appendChild(row); box.appendChild(list);
  return {toggleBtn:toggle, box};
}

/* ---------- Table editor ---------- */
function renderNodeTableEditor(tb, nodeObj, reRender){
  const card=document.createElement("div");card.className="table-card";card.hidden=!tb.__open;
  const head=document.createElement("div");head.className="table-head";
  head.innerHTML=`
    <div class="table-title">
      <span class="badge-no">${tb.title_no || '-'}</span>
      <input type="text" class="table-caption-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á" value="${tb.caption||''}">
    </div>
    <div class="table-actions">
      <button type="button" class="mini-btn" data-act="add-row">+ ‡πÅ‡∏ñ‡∏ß</button>
      <button type="button" class="mini-btn" data-act="add-col">+ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
      <button type="button" class="mini-btn" data-act="del-row">- ‡πÅ‡∏ñ‡∏ß</button>
      <button type="button" class="mini-btn" data-act="del-col">- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
      <button type="button" class="mini-btn danger" data-act="del-table">‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
    </div>`;
  const subTitle=document.createElement("div");
  subTitle.style.cssText="font-size:12px;color:#6b7280;margin:4px 0 6px;";
  subTitle.textContent = tb.display_title || "";
  const hotMount=document.createElement("div");hotMount.className="hot-mount";
  card.appendChild(head);card.appendChild(subTitle);card.appendChild(hotMount);

  const hot=new Handsontable(hotMount,{
    data:tb.rows,
    colHeaders:tb.headers,
    rowHeaders:(r)=>r+1,
    manualColumnMove:true,manualRowMove:true,
    licenseKey:'non-commercial-and-evaluation',
    stretchH:'all',contextMenu:true,height:'auto'
  });
  tb.__hot = hot;

  function syncFromHot(){
    if(tb.__hot && typeof tb.__hot.finishEditing==='function') tb.__hot.finishEditing();
    tb.rows = tb.__hot.getData();
    tb.headers = normalizedHeaders(tb.__hot);
    syncHiddenField();
  }

  head.addEventListener("click",(e)=>{
    const btn=e.target.closest("[data-act]"); if(!btn) return;
    const a=btn.dataset.act; e.preventDefault();

    if(a==="del-table"){
      const i=nodeObj.tables.indexOf(tb);
      if(i>=0 && confirm("‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ?")){ nodeObj.tables.splice(i,1); reRender(); syncHiddenField(); }
      return;
    }
    if(a==="add-row"){ addRowAfterSelection(hot); hot.render(); syncFromHot(); }
    if(a==="del-row"){ removeRowAtSelection(hot); hot.render(); syncFromHot(); }
    if(a==="add-col"){ addColAfterSelection(hot); hot.render(); syncFromHot(); }
    if(a==="del-col"){ removeColAtSelection(hot); hot.render(); syncFromHot(); }
  });

  head.querySelector(".table-caption-input").addEventListener("input", e=>{
    tb.caption=e.target.value;
    const chap = String(tb.title_no||"-").split(".")[0] || "3";
    tb.display_title = formatDisplayTitle(chap, tb.seq||"", tb.caption);
    subTitle.textContent = tb.display_title;
    syncHiddenField();
  });

  const toggleBtn=document.createElement("button");toggleBtn.type="button";toggleBtn.className="mini-btn";toggleBtn.textContent="üìÇ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á";
  toggleBtn.addEventListener("click",(e)=>{ e.preventDefault(); card.hidden=!card.hidden; });
  if(tb.__open){ setTimeout(()=>{card.hidden=false;tb.__open=false;},0); }
  return {card,toggleBtn};
}

/* ---------- Table creator ---------- */
function renderTableCreator(sectionObj, pathArr, nodeObj){
  const nodeNo=buildNodeNumber(sectionObj.title_no,pathArr);
  const creator=document.createElement("div");creator.className="table-builder";
  const k = nodeKey(0, pathArr);   // ‡πÉ‡∏ä‡πâ path ‡πÄ‡∏õ‡πá‡∏ô key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö state
  const remembered = tableBuilderOpenState.get(k);
  creator.hidden = remembered!==undefined ? !remembered : true;

  creator.innerHTML = `
    <div class="tb-head">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ${nodeNo}</div>
    <div class="tb-form">
      <div class="tb-row">
        <label>‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á</label>
        <input type="text" class="tb-input" data-field="caption" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
      </div>
      <div class="tb-actions">
        <button type="button" class="mini-btn primary" data-act="create">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
      </div>
    </div>`;

  creator.addEventListener("click",(e)=>{
    const btn=e.target.closest('[data-act="create"]'); if(!btn) return; e.preventDefault();
    const caption=(creator.querySelector('[data-field="caption"]').value||'').trim();
    const seq = nextTableSeqForChapter(CHAPTER_NO);

    nodeObj.tables = nodeObj.tables || [];
    const tb = createDefaultTable(nodeNo, caption);
    tb.seq = seq;
    tb.display_title = formatDisplayTitle(CHAPTER_NO, seq, caption);
    nodeObj.tables.push(tb);

    // ‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á pictures
    redrawSections(); syncHiddenField();
    tableBuilderOpenState.set(k, true);
  });

  const toggle=document.createElement("button");
  toggle.type="button"; toggle.className="mini-btn"; toggle.textContent="üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á";
  toggle.addEventListener("click",(e)=>{ e.preventDefault(); creator.hidden=!creator.hidden; tableBuilderOpenState.set(k, !creator.hidden); });

  return {builder:creator, toggleBtn:toggle};
}

/* ---------- paragraph + nodes/sections ---------- */
function renderParagraphs(arr,onChange,onAddRm){
  const wrap=document.createElement("div");wrap.className="paras-wrap";
  arr.forEach((txt,idx)=>{const row=document.createElement("div");row.className="para-row";
    const ta=document.createElement("textarea");ta.classList.add("clean-textarea");ta.value=txt||"";ta.placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ . . .";
    ta.addEventListener("input",(e)=>{arr[idx]=e.target.value;onChange&&onChange();});
    const del=document.createElement("button");del.type="button";del.className="mini-btn danger";del.textContent="‡∏•‡∏ö‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
    del.addEventListener("click",(e)=>{e.preventDefault();arr.splice(idx,1);onAddRm&&onAddRm();});
    row.appendChild(ta);row.appendChild(del);wrap.appendChild(row);});
  const add=document.createElement("button");add.type="button";add.className="mini-btn";add.textContent="‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  add.addEventListener("click",(e)=>{e.preventDefault();arr.push("");onAddRm&&onAddRm();});wrap.appendChild(add);
  return wrap;
}

function renderNode(sectionObj,secIndex,nodeObj,pathArr){
  const el=document.createElement("div"); el.className="node-card";
  const top=document.createElement("div"); top.className="node-top-row";
  const badge=document.createElement("div"); badge.className="node-no-badge"; badge.textContent=buildNodeNumber(sectionObj.title_no,pathArr);
  const title=document.createElement("input"); title.type="text"; title.className="node-title-input"; title.placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‚Ä¶"; title.value=nodeObj.text||"";
  title.addEventListener("input",()=>{ nodeObj.text=title.value; syncHiddenField(); });

  const ctr=document.createElement("div"); ctr.className="node-controls";
  const bPara=document.createElement("button"); bPara.type="button"; bPara.className="mini-btn"; bPara.textContent="‚ûï ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤";
  bPara.addEventListener("click",(e)=>{e.preventDefault(); nodeObj.paragraphs=nodeObj.paragraphs||[]; nodeObj.paragraphs.push(""); redrawSections();});
  const bChild=document.createElement("button"); bChild.type="button"; bChild.className="mini-btn"; bChild.textContent="‚ûï ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ";
  bChild.addEventListener("click",(e)=>{e.preventDefault(); nodeObj.children=nodeObj.children||[]; nodeObj.children.push(makeNode()); redrawSections();});
  const bDel=document.createElement("button"); bDel.type="button"; bDel.className="mini-btn danger"; bDel.textContent="‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢";
  bDel.addEventListener("click",(e)=>{e.preventDefault(); const r=getParentAndIndex(sectionObj,pathArr); if(r){r.listRef.splice(r.idx,1); redrawSections();}});
  ctr.appendChild(bPara); ctr.appendChild(bChild); ctr.appendChild(bDel);

  top.appendChild(badge); top.appendChild(title); top.appendChild(ctr); el.appendChild(top);
  nodeObj.paragraphs=nodeObj.paragraphs||[]; el.appendChild( renderParagraphs(nodeObj.paragraphs,()=>syncHiddenField(),()=>redrawSections()) );

  // toggles row
  const toggles=document.createElement("div"); toggles.className="node-toggle-bar";
  const picUI = renderPicturesBox(sectionObj, secIndex, pathArr);
  const tbUI  = renderTableCreator(sectionObj, pathArr, nodeObj);
  toggles.appendChild(picUI.toggleBtn); toggles.appendChild(tbUI.toggleBtn);
  el.appendChild(toggles); el.appendChild(picUI.box); el.appendChild(tbUI.builder);

  // tables list
  const wrap=document.createElement("div"); wrap.className="node-tables-wrap";
  function renderTables(){
    wrap.innerHTML="";
    (nodeObj.tables||[]).forEach(tb=>{
      const ed=renderNodeTableEditor(tb,nodeObj,renderTables);
      const tRow=document.createElement("div"); tRow.className="node-toggle-bar"; tRow.appendChild(ed.toggleBtn);
      wrap.appendChild(tRow); wrap.appendChild(ed.card);
    });
  }
  renderTables(); el.appendChild(wrap);

  // children
  const kids=document.createElement("div"); kids.className="children-block";
  (nodeObj.children||[]).forEach((c,i)=>kids.appendChild(renderNode(sectionObj,secIndex,c,[...pathArr,i])));
  el.appendChild(kids);
  return el;
}

function renderSectionTree(sectionObj,secIndex){
  const t=document.createElement("div"); t.className="tree-wrap";
  (sectionObj.items||[]).forEach((n,i)=>t.appendChild(renderNode(sectionObj,secIndex,n,[i])));
  const add=document.createElement("button"); add.type="button"; add.className="mini-btn"; add.textContent="‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å";
  add.addEventListener("click",(e)=>{e.preventDefault(); sectionObj.items=sectionObj.items||[]; sectionObj.items.push(makeNode()); redrawSections();});
  t.appendChild(add); return t;
}
function renderSectionCard(sectionObj,secIndex){
  const wrap=document.createElement("div"); wrap.className="chapter-section-card";
  const head=document.createElement("div"); head.className="chapter-head-row";
  const b=document.createElement("div"); b.className="badge-no"; b.textContent=sectionObj.title_no;
  const inp=document.createElement("input"); inp.type="text"; inp.className="chapter-title-input"; inp.placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤"; inp.value=sectionObj.title||"";
  inp.addEventListener("input",()=>{sectionObj.title=inp.value; syncHiddenField();});
  const del=document.createElement("button"); del.type="button"; del.className="mini-btn danger"; del.style.marginLeft="auto"; del.textContent="‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà";
  del.addEventListener("click",(e)=>{e.preventDefault(); sectionsState.splice(secIndex,1); redrawSections();});
  head.appendChild(b); head.appendChild(inp); head.appendChild(del); wrap.appendChild(head);

  const over=document.createElement("div"); over.className="overview-block";
  const lab=document.createElement("div"); lab.className="overview-label"; lab.textContent="‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ (‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°):";
  over.appendChild(lab);
  sectionObj.body_paragraphs=sectionObj.body_paragraphs||[];
  over.appendChild( renderParagraphs(sectionObj.body_paragraphs,()=>syncHiddenField(),()=>redrawSections()) );
  wrap.appendChild(over);

  wrap.appendChild( renderSectionTree(sectionObj,secIndex) );
  return wrap;
}
function redrawSections(){
  const c=document.getElementById("sections-container"); c.innerHTML="";
  sectionsState.forEach((sec,i)=>c.appendChild(renderSectionCard(sec,i)));
  syncHiddenField();
}

/* ---------- sync hidden ---------- */
function syncHiddenField(){
  const tbAll=[];
  function walk(node,nodeNo){
    (node.tables||[]).forEach(tb=>{
      if(tb.__hot && typeof tb.__hot.finishEditing === 'function'){ tb.__hot.finishEditing(); }
      tbAll.push({
        title_no: tb.title_no || nodeNo,
        caption: tb.caption || '',
        headers: Array.isArray(tb.headers)?tb.headers:[],
        rows: Array.isArray(tb.rows)?tb.rows:[],
        display_title: tb.display_title || '',
        seq: tb.seq || null,
        anchor_no: nodeNo
      });
    });
    (node.children||[]).forEach((ch,i)=>walk(ch, `${nodeNo}.${i+1}`));
  }
  (sectionsState||[]).forEach(sec=>{ (sec.items||[]).forEach((n,i)=>walk(n, `${sec.title_no}.${i+1}`)); });

  document.getElementById('sections_json').value    = JSON.stringify(sectionsState);
  document.getElementById('tb_sections_json').value = JSON.stringify(tbAll);
}

/* ---------- init / load initial ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const preSecs=jsonScript('chapter3-sections');
  if(Array.isArray(preSecs)&&preSecs.length){
    const mapNode=(n)=>({text:n.text||"",paragraphs:Array.isArray(n.paragraphs)?n.paragraphs.slice():[],pictures:Array.isArray(n.pictures)?n.pictures.slice():[],tables:Array.isArray(n.tables)?n.tables.slice():[],children:Array.isArray(n.children)?n.children.map(mapNode):[]});
    const mapped=preSecs.map(s=>({title_no:s.title_no||"",title:s.title||"",body_paragraphs:Array.isArray(s.body_paragraphs)?s.body_paragraphs.slice():[],pictures:Array.isArray(s.pictures)?s.pictures.slice():[],items:Array.isArray(s.items)?s.items.map(mapNode):[makeNode()]}));
    const only31=mapped.filter(s=>(s.title_no||"")=="3.1");
    sectionsState=only31.length?only31:[mapped[0]];
  }

  // ‡πÅ‡∏ô‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö
  const preTables=jsonScript('chapter3-tables');
  if(Array.isArray(preTables)&&preTables.length){
    function walk(sectionObj,pathArr,nodeObj){
      const nodeNo=sectionObj.title_no+'.'+pathArr.map(i=>i+1).join('.');
      const matches=preTables.filter(t=> (t.anchor_no? t.anchor_no===nodeNo : String(t.title_no||"").startsWith(nodeNo)));
      if(matches.length){ nodeObj.tables=nodeObj.tables||[]; matches.forEach(t=>nodeObj.tables.push({...t,__open:false})); }
      (nodeObj.children||[]).forEach((ch,i)=>walk(sectionObj,[...pathArr,i],ch));
    }
    (sectionsState||[]).forEach(sec=>{ (sec.items||[]).forEach((n,i)=>walk(sec,[i],n)); });
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà
  const addBtn=document.getElementById('btnAddSection');
  if(addBtn){
    addBtn.addEventListener('click',(e)=>{
      e.preventDefault();
      const last = sectionsState.length ? parseInt(sectionsState[sectionsState.length-1].title_no.split('.')[1]||'1',10) : 0;
      sectionsState.push( makeSection(`3.${last+1}`, '') );
      redrawSections();
    });
  }

  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô mini-btn ‡∏ó‡∏≥‡∏ü‡∏≠‡∏£‡πå‡∏° submit
  document.getElementById('chapter3Form').addEventListener('click',(e)=>{
    const isActionBtn = e.target.closest('.mini-btn');
    if(isActionBtn){ e.preventDefault(); }
  });

  // ‡∏Å‡πà‡∏≠‡∏ô submit ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î + sync
  document.getElementById('chapter3Form').addEventListener('submit', ()=>{
    document.querySelectorAll('textarea').forEach(t=>{ t.value = t.value.replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim(); });
    syncHiddenField();
  });

  redrawSections();
});
</script>
</body>
</html>
